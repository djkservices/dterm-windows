<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Network Tools</title>
  <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">
  <link rel="stylesheet" href="node_modules/monaco-editor/min/vs/editor/editor.main.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0d1117;
      color: #d1d5db;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #app-container {
      flex: 1;
      display: flex;
      min-height: 0;
      overflow: hidden;
    }

    /* Left Panel */
    #left-panel {
      width: 500px;
      min-width: 0;
      max-width: 900px;
      background: #161b22;
      border-right: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    /* Top Navigation Tab Bar */
    #nav-tabs {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 6px 10px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      flex-shrink: 0;
      overflow-x: auto;
      -webkit-app-region: no-drag;
    }
    #nav-tabs::-webkit-scrollbar { height: 0; }
    .nav-tab {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border: none;
      background: none;
      color: #8b949e;
      font-size: 11.5px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      border-radius: 6px;
      white-space: nowrap;
      transition: color 0.15s, background 0.15s;
      flex-shrink: 0;
    }
    .nav-tab:hover { color: #d1d5db; background: #21262d; }
    .nav-tab.active {
      color: #f0f6fc;
      background: #0066cc;
    }
    .nav-tab svg { flex-shrink: 0; }
    .nav-tab-separator {
      width: 1px;
      height: 16px;
      background: #30363d;
      margin: 0 4px;
      flex-shrink: 0;
    }

    /* Left Panel Content */
    #left-panel-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }
    .left-tab-content {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .left-tab-content.active {
      display: flex;
    }
    .left-tab-header {
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #30363d;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Git Panel */
    #git-panel {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    #git-commit-area {
      padding: 8px;
      border-bottom: 1px solid #30363d;
    }
    .git-file-item {
      padding: 3px 8px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .git-file-item:hover { background: #21262d; }
    .git-status-m { color: #e2b93d; }
    .git-status-a { color: #4ec94e; }
    .git-status-d { color: #f44; }
    .git-status-u { color: #8b949e; }
    .git-log-item { padding: 4px 4px; cursor: pointer; border-bottom: 1px solid #21262d; }
    .git-log-item:hover { background: #21262d; }
    .git-branch-item:hover { background: #21262d; }

    /* FTP Progress Bar */
    #ftp-progress-bar { display: none; margin: 6px 8px; height: 4px; background: #21262d; border-radius: 2px; overflow: hidden; }
    #ftp-progress-fill { height: 100%; background: #0e639c; width: 0%; transition: width 0.2s; }

    /* Broadcast Modal */
    #broadcast-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center; z-index: 3500;
    }
    #broadcast-modal {
      background: #21262d; border: 1px solid #d29922; border-radius: 12px;
      padding: 24px; width: 400px; max-width: 90vw; text-align: center;
    }
    #broadcast-modal .broadcast-icon { font-size: 32px; margin-bottom: 12px; }
    #broadcast-modal h3 { font-size: 15px; color: #d29922; margin-bottom: 14px; font-weight: 700; }
    #broadcast-modal .broadcast-msg { font-size: 13px; color: #d1d5db; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }
    #broadcast-modal button {
      padding: 8px 28px; border-radius: 6px; border: none; font-size: 12px;
      font-weight: 600; cursor: pointer; background: #d29922; color: #000;
    }
    #broadcast-modal button:hover { background: #e5a825; }

    /* Search Panel */
    #search-panel {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .search-result-file {
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #d1d5db;
      cursor: pointer;
    }
    .search-result-file:hover { background: #21262d; }
    .search-result-line {
      padding: 2px 8px 2px 20px;
      font-size: 11px;
      color: #8b949e;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-result-line:hover { background: #21262d; color: #d1d5db; }
    .search-result-match { color: #e2b93d; font-weight: 600; }

    /* Code Runner Panel */
    #runner-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 0;
    }
    .runner-section {
      padding: 8px 10px 4px;
      font-size: 10px;
      font-weight: 600;
      color: #6e7681;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #30363d;
    }
    .runner-run-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: calc(100% - 16px);
      margin: 8px;
      padding: 10px 12px;
      background: #0e639c;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      text-align: left;
    }
    .runner-run-btn:hover { background: #1177bb; }
    .runner-run-btn:disabled { background: #30363d; color: #6e7681; cursor: not-allowed; }
    .runner-file-info {
      padding: 0 20px 8px;
      font-size: 11px;
      color: #6e7681;
    }
    .runner-task-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: #d1d5db;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .runner-task-item:hover { background: #21262d; }
    .runner-task-play { color: #4ec94e; font-size: 10px; flex-shrink: 0; }
    .runner-task-name { flex: 1; }
    .runner-task-detail { color: #484f58; font-size: 10px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .runner-custom {
      padding: 8px;
      display: flex;
      gap: 6px;
    }
    .runner-custom input {
      flex: 1;
      padding: 6px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      outline: none;
      font-family: 'SF Mono', Monaco, monospace;
    }
    .runner-custom input:focus { border-color: #0066cc; }
    .runner-custom button {
      padding: 6px 12px;
      background: #0e639c;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .runner-custom button:hover { background: #1177bb; }
    .runner-task-category {
      font-size: 10px;
      color: #6e7681;
      text-transform: uppercase;
      padding: 8px 10px 2px;
      letter-spacing: 0.5px;
    }
    .runner-empty {
      padding: 12px;
      color: #484f58;
      font-size: 12px;
      text-align: center;
    }

    /* Breadcrumb Path */
    .breadcrumb { display: flex; align-items: center; flex: 1; overflow: hidden; flex-wrap: nowrap; }
    .breadcrumb-segment { color: #8b949e; cursor: pointer; white-space: nowrap; }
    .breadcrumb-segment:hover { color: #0066cc; text-decoration: underline; }
    .breadcrumb-sep { color: #484f58; margin: 0 2px; white-space: nowrap; }
    .breadcrumb-segment:last-child { color: #d1d5db; }

    /* File Icons in Editor Tabs */
    .tab-icon { margin-right: 4px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 14px; text-align: center; }

    /* Markdown Preview */
    #md-preview-container {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      background: #161b22;
      color: #d1d5db;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }
    #md-preview-container.visible { display: block; }
    #md-preview-container h1 { font-size: 24px; color: #e6e6e6; border-bottom: 1px solid #30363d; padding-bottom: 8px; margin: 16px 0 8px; }
    #md-preview-container h2 { font-size: 20px; color: #e6e6e6; border-bottom: 1px solid #30363d; padding-bottom: 6px; margin: 14px 0 6px; }
    #md-preview-container h3 { font-size: 16px; color: #e6e6e6; margin: 12px 0 4px; }
    #md-preview-container h4,#md-preview-container h5,#md-preview-container h6 { font-size: 14px; color: #d1d5db; margin: 10px 0 4px; }
    #md-preview-container code { background: #21262d; padding: 2px 6px; border-radius: 3px; font-family: Menlo, Monaco, monospace; font-size: 13px; }
    #md-preview-container pre { background: #0d1117; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 12px 0; }
    #md-preview-container pre code { background: none; padding: 0; }
    #md-preview-container blockquote { border-left: 3px solid #444; padding-left: 12px; color: #8b949e; margin: 8px 0; }
    #md-preview-container a { color: #58a6ff; text-decoration: none; }
    #md-preview-container a:hover { text-decoration: underline; }
    #md-preview-container img { max-width: 100%; border-radius: 6px; }
    #md-preview-container table { border-collapse: collapse; width: 100%; margin: 12px 0; }
    #md-preview-container th, #md-preview-container td { border: 1px solid #30363d; padding: 6px 10px; text-align: left; }
    #md-preview-container th { background: #21262d; }
    #md-preview-container ul, #md-preview-container ol { padding-left: 24px; }
    #md-preview-container li { margin: 4px 0; }
    #md-preview-container hr { border: none; border-top: 1px solid #30363d; margin: 16px 0; }
    #md-preview-toggle { background: none; border: 1px solid #30363d; color: #8b949e; font-size: 11px; padding: 2px 8px; border-radius: 3px; cursor: pointer; margin-left: auto; margin-right: 6px; white-space: nowrap; }
    #md-preview-toggle:hover { color: #d1d5db; border-color: #484f58; }
    #md-preview-toggle.active { color: #4ec94e; border-color: #4ec94e; }
    #diff-toggle { background: none; border: 1px solid #30363d; color: #8b949e; font-size: 11px; padding: 2px 8px; border-radius: 3px; cursor: pointer; margin-right: 6px; white-space: nowrap; }
    #diff-toggle:hover { color: #d1d5db; border-color: #484f58; }
    #diff-toggle.active { color: #f0883e; border-color: #f0883e; }

    /* Image Preview Tooltip */
    .file-preview-tooltip {
      position: fixed;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 4px;
      z-index: 9999;
      pointer-events: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    }
    .file-preview-tooltip img { max-width: 200px; max-height: 200px; display: block; border-radius: 4px; }

    /* Status Bar */
    #status-bar {
      display: flex;
      align-items: center;
      height: 28px;
      background: #161b22;
      border-top: 1px solid #30363d;
      font-size: 11px;
      color: #8b949e;
      padding: 0 12px;
      gap: 4px;
      flex-shrink: 0;
    }
    .status-item {
      padding: 0 8px;
      white-space: nowrap;
      cursor: default;
      display: flex;
      align-items: center;
      gap: 4px;
      height: 100%;
    }
    .status-item.clickable { cursor: pointer; }
    .status-item.clickable:hover { background: #30363d; color: #d1d5db; }
    .status-spacer { flex: 1; }

    /* Left Terminal */
    #left-terminal-area {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    #left-terminal-container {
      flex: 1;
      position: relative;
      background: #0d1117;
      min-height: 0;
    }

    /* Panel Resizers */
    .panel-resizer {
      width: 4px;
      background: #30363d;
      cursor: ew-resize;
      flex-shrink: 0;
    }
    .panel-resizer:hover { background: #0066cc; }

    /* Panel Collapse Toggles */
    .panel-toggle {
      width: 16px;
      background: #161b22;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: #484f58;
      font-size: 10px;
      padding: 0;
      transition: background 0.15s, color 0.15s;
      user-select: none;
    }
    .panel-toggle:hover {
      background: #21262d;
      color: #d1d5db;
    }
    .panel-toggle .toggle-icon {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 10px;
      letter-spacing: 1px;
    }

    /* Collapsed panel states */
    #left-panel.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      overflow: hidden;
      border-right: none;
    }
    #left-panel.collapsed #left-panel-content {
      display: none;
    }
    /* Right panel removed — single sidebar layout */

    /* Resize ghost preview */
    #resize-ghost {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #0066cc;
      z-index: 9999;
      pointer-events: none;
      display: none;
    }
    #resize-ghost.visible { display: block; }

    .nav-tab.dragging { opacity: 0.4; }

    /* Smooth transitions for collapse/expand */
    #left-panel {
      transition: width 0.2s ease, min-width 0.2s ease;
    }

    /* File Manager */
    #file-manager {
      flex: 1;
      background: #161b22;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* Mini Browser */
    #mini-browser {
      flex: 1;
      background: #161b22;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Browser Tab Bar */
    #browser-tab-bar {
      display: flex;
      align-items: center;
      background: #0d1117;
      border-bottom: 1px solid #30363d;
      padding: 4px 4px 0;
      overflow-x: auto;
      flex-shrink: 0;
      gap: 2px;
    }
    #browser-tab-bar::-webkit-scrollbar { height: 0; }
    .browser-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      color: #8b949e;
      font-size: 11px;
      cursor: pointer;
      max-width: 180px;
      min-width: 60px;
      flex-shrink: 0;
    }
    .browser-tab .browser-tab-title {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .browser-tab.active {
      background: #161b22;
      color: #f0f6fc;
      border-bottom-color: #161b22;
    }
    .browser-tab .tab-close {
      opacity: 0.4;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      flex-shrink: 0;
    }
    .browser-tab .tab-close:hover { opacity: 1; }
    #browser-new-tab {
      background: none;
      border: none;
      color: #8b949e;
      font-size: 16px;
      cursor: pointer;
      padding: 2px 8px;
      flex-shrink: 0;
      line-height: 1;
    }
    #browser-new-tab:hover { color: #f0f6fc; }

    .browser-webview { display: none; flex: 1; border: none; background: #fff; min-height: 0; width: 100%; height: 100%; }
    .browser-webview.active { display: flex; }

    /* Browser Device Tabs */
    #browser-device-tabs {
      display: flex;
      gap: 2px;
      padding: 4px 6px;
      background: #0d1117;
      border-bottom: 1px solid #30363d;
      flex-shrink: 0;
    }
    .device-tab {
      padding: 3px 10px;
      border: none;
      background: none;
      color: #8b949e;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      border-radius: 4px;
      transition: color 0.15s, background 0.15s;
    }
    .device-tab:hover { color: #d1d5db; background: #21262d; }
    .device-tab.active { color: #f0f6fc; background: #0066cc; }
    #browser-viewport-label {
      margin-left: auto;
      font-size: 10px;
      color: #6e7681;
      display: flex;
      align-items: center;
    }

    #mini-browser-toolbar {
      padding: 6px;
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #30363d;
    }

    #mini-browser-toolbar button {
      padding: 5px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #mini-browser-toolbar button:hover {
      background: #30363d;
      border-color: #484f58;
    }

    #mini-browser-url {
      flex: 1;
      padding: 4px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 11px;
      outline: none;
    }

    #mini-browser-url:focus {
      border-color: #0066cc;
    }

    /* webview styles now handled by .browser-webview */

    #mini-browser-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #6e7681;
      font-size: 12px;
      display: none;
    }

    #mini-browser-loading.visible {
      display: block;
    }

    #mini-browser-content {
      position: relative;
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #30363d;
      border-top-color: #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* File list loading */
    #file-list-loading {
      padding: 20px;
      text-align: center;
      color: #6e7681;
      display: none;
    }

    #file-list-loading.visible {
      display: block;
    }

    #fm-toolbar {
      padding: 6px;
      border-bottom: 1px solid #30363d;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    #fm-toolbar button, #fm-bottom-toolbar button {
      padding: 5px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      white-space: nowrap;
    }

    #fm-toolbar button:hover, #fm-bottom-toolbar button:hover {
      background: #30363d;
      border-color: #484f58;
    }

    #fm-toolbar button.active {
      background: #0066cc;
      border-color: #0066cc;
    }

    #fm-search {
      flex: 1;
      min-width: 60px;
      padding: 4px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 11px;
      outline: none;
    }

    #fm-search:focus { border-color: #0066cc; }

    #fm-path {
      padding: 6px 10px;
      font-size: 11px;
      color: #6e7681;
      border-bottom: 1px solid #30363d;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #fm-path span { flex: 1; overflow: hidden; text-overflow: ellipsis; }

    #fm-path button {
      background: none;
      border: none;
      color: #6e7681;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
    }

    #fm-path button:hover { color: #0066cc; }

    /* Bookmarks */
    #bookmarks-bar {
      display: flex;
      gap: 4px;
      padding: 4px 6px;
      border-bottom: 1px solid #30363d;
      overflow-x: auto;
      flex-shrink: 0;
    }

    #bookmarks-bar:empty { display: none; }

    .bookmark-item {
      padding: 3px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #8b949e;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bookmark-item:hover { background: #30363d; color: #d1d5db; }

    .bookmark-item .remove-bookmark {
      opacity: 0;
      font-size: 10px;
    }

    .bookmark-item:hover .remove-bookmark { opacity: 0.6; }
    .bookmark-item .remove-bookmark:hover { opacity: 1; color: #f44; }

    /* Recent Menu */
    #recent-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #recent-menu.visible { display: block; }

    #recent-menu .recent-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: #d1d5db;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #recent-menu .recent-item:hover { background: #0066cc; }

    #recent-menu .recent-header {
      padding: 4px 12px;
      font-size: 10px;
      color: #6e7681;
      text-transform: uppercase;
    }

    #recent-menu .recent-clear {
      padding: 6px 12px;
      font-size: 11px;
      color: #8b949e;
      cursor: pointer;
      border-top: 1px solid #30363d;
      margin-top: 4px;
    }

    #recent-menu .recent-clear:hover { color: #f44; }

    #fm-toolbar { position: relative; }

    /* Git indicators */
    #git-branch {
      padding: 2px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      font-size: 10px;
      color: #8b949e;
      display: none;
      align-items: center;
      gap: 4px;
    }

    #git-branch.visible { display: flex; }
    #git-branch .branch-icon { color: #f90; }

    .file-item.git-modified .file-name { color: #f90; }
    .file-item.git-added .file-name { color: #0f0; }
    .file-item.git-deleted .file-name { color: #f44; text-decoration: line-through; }
    .file-item.git-untracked .file-name { color: #8b949e; }

    .git-indicator {
      font-size: 10px;
      margin-left: auto;
      padding: 1px 4px;
      border-radius: 2px;
    }

    .git-indicator.modified { color: #f90; }
    .git-indicator.added { color: #0f0; }
    .git-indicator.untracked { color: #8b949e; }

    #file-list {
      flex: 1;
      overflow-y: auto;
    }

    #file-list.drop-over {
      outline: 2px dashed #0066cc;
      outline-offset: -2px;
      background: rgba(0, 102, 204, 0.05);
    }

    .file-item {
      padding: 4px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      user-select: none;
      color: #e6edf3;
    }

    .file-item[draggable="true"] {
      cursor: grab;
    }

    .file-item.dragging {
      opacity: 0.5;
    }

    .file-item:hover { background: #21262d; }
    .file-item.selected { background: #0066cc; }
    .file-item.cut { opacity: 0.5; }

    .file-item .file-info {
      margin-left: auto;
      font-size: 10px;
      color: #6e7681;
    }

    #fm-bottom-toolbar {
      padding: 6px;
      border-top: 1px solid #30363d;
      display: flex;
      gap: 4px;
    }

    /* Main Area */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }

    /* Editor Area */
    #editor-area {
      display: none;
      flex-direction: column;
      border-bottom: 1px solid #30363d;
    }

    #editor-area.visible {
      display: flex;
      flex: 1;
      min-height: 120px;
    }

    #editor-tabs {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      overflow-x: auto;
    }

    #editor-container {
      flex: 1;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    /* Terminal Area */
    #terminal-area {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    #terminal-area.with-editor {
      flex: 2;
      min-height: 150px;
      border-top: 1px solid #30363d;
    }

    /* Tabs */
    #terminal-tabs {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
    }

    .tab {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #8b949e;
      border-right: 1px solid #30363d;
    }

    .tab.active { background: #0d1117; color: #f0f6fc; }
    .tab-label { max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tab:hover:not(.active) { background: #21262d; }
    .tab.modified span:first-child::before { content: '● '; color: #0af; }

    .tab-close {
      opacity: 0.6;
      font-size: 12px;
    }

    .tab-close:hover { opacity: 1; }

    #new-term-btn, .term-profile-btn {
      padding: 8px 12px;
      background: none;
      border: none;
      color: #6e7681;
      cursor: pointer;
      font-size: 14px;
    }

    #new-term-btn:hover, .term-profile-btn:hover { color: #d1d5db; }

    /* Terminal search bar */
    #terminal-search {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 6px 8px;
      z-index: 100;
      gap: 4px;
      align-items: center;
    }

    #terminal-search.visible { display: flex; }

    #terminal-search input {
      width: 200px;
      padding: 4px 8px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      outline: none;
    }

    #terminal-search input:focus { border-color: #0066cc; }

    #terminal-search button {
      padding: 4px 8px;
      background: #30363d;
      border: none;
      border-radius: 4px;
      color: #d1d5db;
      cursor: pointer;
      font-size: 11px;
    }

    #terminal-search button:hover { background: #3d444d; }

    #terminal-search .search-count {
      font-size: 10px;
      color: #6e7681;
      min-width: 40px;
    }

    .term-profiles {
      display: flex;
      margin-left: auto;
      border-left: 1px solid #30363d;
    }

    /* Terminal Container */
    #terminal-container {
      flex: 1;
      position: relative;
      background: #0d1117;
      min-height: 0;
      overflow: hidden;
      display: flex;
    }

    /* Split Pane System */
    .split-pane {
      display: flex;
      flex: 1;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }
    .split-pane.vertical { flex-direction: row; }
    .split-pane.horizontal { flex-direction: column; }
    .split-divider-v {
      width: 4px;
      background: #30363d;
      cursor: col-resize;
      flex-shrink: 0;
    }
    .split-divider-h {
      height: 4px;
      background: #30363d;
      cursor: row-resize;
      flex-shrink: 0;
    }
    .split-divider-v:hover, .split-divider-h:hover { background: #0066cc; }
    .pane-container {
      flex: 1;
      position: relative;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }
    .pane-container.active-pane {
      outline: 1px solid #0066cc33;
      outline-offset: -1px;
    }

    #terminal-container.drag-over {
      outline: 2px dashed #0066cc;
      outline-offset: -2px;
    }

    /* AI Select (in left panel header) */
    #ai-select {
      background: #21262d;
      color: #d1d5db;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      outline: none;
    }
    #ai-select:hover { background: #30363d; }

    #ai-frame {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
      background: #0d1117;
      min-height: 0;
    }

    /* Notes Panel (Monaco editor) */
    #notes-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    #notes-editor-container {
      flex: 1;
      min-height: 0;
    }

    /* Tools Panel (now in left sidebar) */
    #tools-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    #tools-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .tools-category {
      color: #8b949e;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 4px 4px;
      border-bottom: 1px solid #30363d;
      margin-bottom: 4px;
    }

    .tools-category:first-child {
      padding-top: 0;
    }

    .tool-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 8px;
      background: none;
      border: none;
      color: #d1d5db;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      border-radius: 4px;
    }

    .tool-btn:hover {
      background: #21262d;
      color: #fff;
    }

    .tool-btn.active {
      background: #0066cc;
      color: #fff;
    }

    .vault-entry:hover {
      background: #161b22;
    }

    #tools-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid #30363d;
      flex-shrink: 0;
      background: #0d1117;
    }

    .tool-back-btn {
      background: none;
      border: none;
      color: #0088ff;
      font-size: 14px;
      cursor: pointer;
      padding: 2px 4px;
    }

    .tool-back-btn:hover { color: #44aaff; }

    .tool-title {
      color: #d1d5db;
      font-size: 13px;
      font-weight: 600;
    }

    .tool-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .tool-body label {
      display: block;
      color: #8b949e;
      font-size: 11px;
      margin-bottom: 3px;
      margin-top: 8px;
    }

    .tool-body label:first-child { margin-top: 0; }

    .tool-input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
    }

    .tool-input:focus { border-color: #0066cc; }

    .tool-textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
      resize: vertical;
      min-height: 60px;
    }

    .tool-textarea:focus { border-color: #0066cc; }

    .tool-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .tool-run-btn {
      padding: 6px 14px;
      background: #0066cc;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .tool-run-btn:hover { background: #0077ee; }
    .tool-run-btn:disabled { background: #30363d; color: #6e7681; cursor: not-allowed; }

    .tool-secondary-btn {
      padding: 6px 14px;
      background: #30363d;
      border: none;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .tool-secondary-btn:hover { background: #3d444d; }

    .tool-output {
      margin-top: 10px;
      padding: 8px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #0f0;
      font-size: 11px;
      font-family: 'SF Mono', Monaco, monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }

    .tool-output.error { color: #f55; }

    .tool-result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 11px;
    }

    .tool-result-table td, .tool-result-table th {
      padding: 4px 6px;
      border: 1px solid #30363d;
      color: #d1d5db;
      text-align: left;
    }

    .tool-result-table th {
      background: #21262d;
      color: #8b949e;
      font-weight: 600;
    }

    .tool-result-table td:first-child {
      color: #0088ff;
      white-space: nowrap;
      width: 1%;
    }

    .tool-status { font-size: 11px; color: #8b949e; margin-top: 6px; }
    .tool-status.ok { color: #4c4; }
    .tool-status.warn { color: #cc4; }
    .tool-status.fail { color: #f55; }

    /* FTP Panel (now in left sidebar) */
    #ftp-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #ftp-bar {
      background: #161b22;
      padding: 12px;
      flex-shrink: 0;
    }

    #ftp-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
    }

    #ftp-bar input, #ftp-bar select {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 12px;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      box-sizing: border-box;
    }

    #ftp-bar input:focus { border-color: #0066cc; }

    #ftp-bar-row {
      display: flex;
      gap: 8px;
    }

    #ftp-bar-row input {
      flex: 1;
      min-width: 0;
    }

    #ftp-port { max-width: 70px; }

    #ftp-bar-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    #ftp-bar button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #ftp-connect-btn {
      flex: 1;
      background: #0066cc;
      color: #fff;
    }
    #ftp-connect-btn:hover { background: #0077dd; }

    #ftp-disconnect-btn {
      flex: 1;
      background: #cc3333;
      color: #fff;
    }
    #ftp-disconnect-btn:hover { background: #dd4444; }

    #ftp-save-btn {
      background: #30363d;
      color: #d1d5db;
    }
    #ftp-save-btn:hover { background: #3d444d; }

    #ftp-delete-saved-btn {
      background: #30363d;
      color: #f44;
    }
    #ftp-delete-saved-btn:hover { background: #3d444d; }

    #ftp-status {
      font-size: 11px;
      color: #6e7681;
      border-bottom: 1px solid #30363d;
    }

    .terminal-panel {
      position: absolute;
      inset: 0;
      display: none;
    }
    .terminal-panel.active { display: block; }
    /* When inside a split pane, always show */
    .pane-container .terminal-panel { display: block; }

    /* Context Menu */
    #context-menu {
      position: fixed;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #d1d5db;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #context-menu button:hover { background: #0066cc; }
    #context-menu button.danger { color: #f44; }

    /* Terminal Context Menu */
    #terminal-context-menu {
      position: fixed;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #terminal-context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #d1d5db;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #terminal-context-menu button:hover { background: #0066cc; }

    /* Command Palette */
    #command-palette {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      max-width: 90%;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      z-index: 4000;
      max-height: 400px;
    }

    #command-palette.visible { display: flex; }

    #command-palette-input {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-bottom: 1px solid #30363d;
      color: #fff;
      font-size: 14px;
      outline: none;
    }

    #command-palette-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .command-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .command-item:hover, .command-item.selected { background: #0066cc; }

    .command-item .command-icon { font-size: 16px; opacity: 0.7; }
    .command-item .command-name { flex: 1; }
    .command-item .command-shortcut { font-size: 11px; color: #8b949e; }

    .command-item.selected .command-shortcut { color: #d1d5db; }

    /* Resizer */
    #resizer {
      height: 4px;
      background: #30363d;
      cursor: ns-resize;
    }
    #resizer:hover { background: #0066cc; }

    /* File Preview */
    #file-preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }

    #file-preview-overlay.visible { display: flex; }

    #file-preview-container {
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #file-preview-container img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 4px;
    }

    #file-preview-container video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 4px;
    }

    #file-preview-name {
      margin-top: 12px;
      color: #8b949e;
      font-size: 12px;
    }

    #file-preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: #8b949e;
      font-size: 24px;
      cursor: pointer;
    }

    #file-preview-close:hover { color: #fff; }

    /* Settings Panel */
    /* Contact Modal */
    #contact-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    #contact-panel {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 24px;
      width: 440px;
      max-height: 85vh;
      overflow-y: auto;
    }
    #contact-panel h2 { font-size: 16px; color: #f0f6fc; margin-bottom: 16px; font-weight: 700; }
    #contact-panel label { display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px; font-weight: 500; }
    #contact-panel input[type="text"], #contact-panel select, #contact-panel textarea {
      width: 100%; padding: 8px 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      color: #d1d5db; font-size: 13px; font-family: inherit; margin-bottom: 12px;
    }
    #contact-panel textarea { min-height: 120px; resize: vertical; }
    #contact-panel select { cursor: pointer; }
    #contact-panel .contact-btn-row { display: flex; gap: 8px; justify-content: flex-end; }
    #contact-panel .contact-btn-row button { padding: 7px 18px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; }
    #contact-sent { color: #3fb950; font-size: 12px; margin-bottom: 12px; display: none; }
    #contact-error { color: #f85149; font-size: 12px; margin-bottom: 12px; display: none; }

    /* My Messages list inside contact modal */
    #my-messages-list { max-height: 200px; overflow-y: auto; margin-top: 12px; }
    .my-msg-item { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 12px; }
    .my-msg-item .msg-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .my-msg-item .msg-subject { font-weight: 600; color: #d1d5db; }
    .my-msg-item .msg-date { color: #6e7681; font-size: 11px; }
    .my-msg-item .msg-body { color: #8b949e; margin-bottom: 6px; }
    .my-msg-item .msg-reply { background: #122d1a; border-left: 2px solid #3fb950; padding: 6px 8px; border-radius: 4px; color: #3fb950; margin-top: 6px; }
    .my-msg-item .msg-reply-label { font-size: 10px; color: #6e7681; text-transform: uppercase; margin-bottom: 2px; }

    /* Notification bell */
    #notif-badge { position: relative; }
    #notif-badge.has-notif svg { color: #f0883e; }
    #notif-badge.has-notif { animation: bellPulse 2s ease-in-out infinite; }
    @keyframes bellPulse {
      0%, 100% { transform: scale(1); }
      15% { transform: scale(1.2) rotate(8deg); }
      30% { transform: scale(1.2) rotate(-8deg); }
      45% { transform: scale(1); }
    }
    #notif-count {
      position: absolute; top: -4px; right: -6px;
      background: #f85149; color: #fff; font-size: 9px; font-weight: 700;
      min-width: 14px; height: 14px; border-radius: 7px;
      display: none; align-items: center; justify-content: center; padding: 0 3px;
    }
    #notif-count.visible { display: flex; }

    /* Update notification bar */
    #update-bar {
      display: none;
      background: linear-gradient(90deg, #1a5c2e, #238636);
      color: #fff;
      text-align: center;
      padding: 4px 12px;
      font-size: 12px;
      -webkit-app-region: no-drag;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    #update-bar.visible { display: flex; }
    #update-bar button {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      padding: 2px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    #update-bar button:hover { background: rgba(255,255,255,0.3); }

    /* Notification toast */
    #notif-toast {
      position: fixed; bottom: 40px; right: 16px; z-index: 8000;
      background: #21262d; border: 1px solid #30363d; border-left: 3px solid #3fb950;
      border-radius: 8px; padding: 12px 16px; max-width: 320px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4); display: none;
      animation: slideIn 0.3s ease;
    }
    #notif-toast.visible { display: block; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    #notif-toast .toast-title { font-size: 12px; font-weight: 600; color: #3fb950; margin-bottom: 4px; }
    #notif-toast .toast-body { font-size: 11px; color: #d1d5db; }
    #notif-toast .toast-close { position: absolute; top: 8px; right: 10px; color: #6e7681; cursor: pointer; font-size: 14px; }

    /* User Avatar */
    #user-avatar {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      border: 2px solid #30363d; object-fit: cover; display: none;
      transition: border-color 0.2s;
    }
    #user-avatar:hover { border-color: #58a6ff; }
    #user-avatar-initials {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      background: #0066cc; color: #fff; font-size: 11px; font-weight: 700;
      display: none; align-items: center; justify-content: center;
      border: 2px solid #30363d; transition: border-color 0.2s;
    }
    #user-avatar-initials:hover { border-color: #58a6ff; }

    /* Settings profile photo */
    .settings-photo-section {
      display: flex; align-items: center; gap: 16px; padding: 12px 0;
      border-bottom: 1px solid #21262d; margin-bottom: 12px;
    }
    .settings-photo-preview {
      width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
      border: 2px solid #30363d; background: #0d1117;
    }
    .settings-photo-initials {
      width: 64px; height: 64px; border-radius: 50%;
      background: #0066cc; color: #fff; font-size: 24px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      border: 2px solid #30363d;
    }
    .settings-photo-actions { display: flex; flex-direction: column; gap: 6px; }
    .settings-photo-actions .photo-btn {
      padding: 4px 12px; background: #21262d; border: 1px solid #30363d;
      border-radius: 4px; color: #d1d5db; font-size: 11px; cursor: pointer;
    }
    .settings-photo-actions .photo-btn:hover { background: #30363d; }
    .settings-photo-status { font-size: 11px; color: #6e7681; }

    /* Menu Dropdown */
    #menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 4px 0;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 5000;
    }
    .menu-item {
      padding: 7px 14px;
      font-size: 12px;
      color: #d1d5db;
      cursor: pointer;
      transition: background 0.1s;
    }
    .menu-item:hover { background: #30363d; }
    .menu-divider { height: 1px; background: #30363d; margin: 4px 0; }

    #about-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    #about-panel {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 32px;
      width: 420px;
      text-align: center;
    }
    #about-panel .about-logo { font-size: 40px; margin-bottom: 12px; }
    #about-panel h2 { font-size: 20px; color: #f0f6fc; margin-bottom: 4px; font-weight: 700; }
    #about-panel .about-version { font-size: 12px; color: #8b949e; margin-bottom: 16px; }
    #about-panel .about-desc { font-size: 13px; color: #d1d5db; line-height: 1.5; margin-bottom: 20px; }
    #about-panel .about-info { font-size: 11px; color: #6e7681; line-height: 1.8; margin-bottom: 20px; }
    #about-panel .about-info a { color: #58a6ff; text-decoration: none; }
    #about-panel .about-info a:hover { text-decoration: underline; }
    #about-panel .about-tech { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 20px; }
    #about-panel .about-tech span { background: #0d1117; border: 1px solid #30363d; border-radius: 12px; padding: 3px 10px; font-size: 11px; color: #8b949e; }
    #about-panel .about-close { padding: 6px 20px; background: #30363d; border: none; border-radius: 6px; color: #d1d5db; font-size: 12px; cursor: pointer; }
    #about-panel .about-close:hover { background: #484f58; }

    #settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #settings-panel {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #settings-panel h2 {
      margin-bottom: 16px;
      font-size: 16px;
      color: #fff;
    }

    .settings-group {
      margin-bottom: 16px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: #8b949e;
    }

    .settings-group input, .settings-group select {
      width: 100%;
      padding: 8px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #d1d5db;
      font-size: 13px;
      outline: none;
    }

    .settings-group input:focus, .settings-group select:focus {
      border-color: #0066cc;
    }

    #settings-panel .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    #settings-panel button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #settings-panel button.primary {
      background: #0066cc;
      color: #fff;
    }

    #settings-panel button.secondary {
      background: #30363d;
      color: #d1d5db;
    }

    /* Shortcuts Panel */
    #shortcuts-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #shortcuts-panel {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      width: 450px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #shortcuts-panel h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: #f0f6fc;
      font-weight: 600;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #30363d;
      font-size: 14px;
      color: #e6edf3;
    }

    .shortcut-key {
      background: #30363d;
      padding: 4px 10px;
      border-radius: 4px;
      font-family: -apple-system, BlinkMacSystemFont, monospace;
      font-size: 13px;
      color: #f0f6fc;
      border: 1px solid #484f58;
      box-shadow: 0 1px 0 rgba(0,0,0,0.3);
    }
    .shortcut-key.clickable { cursor: pointer; transition: all 0.15s; }
    .shortcut-key.clickable:hover { background: #3d444d; border-color: #58a6ff; color: #58a6ff; }
    .shortcut-key.recording {
      background: #1a3a5c;
      color: #79c0ff;
      border-color: #58a6ff;
      animation: scPulse 1s infinite;
    }
    .shortcut-key.conflict { color: #f85149; border-color: #f85149; }
    .shortcut-key-group { display: flex; align-items: center; gap: 6px; }
    .shortcut-reset-btn {
      color: #f0883e;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.6;
      transition: opacity 0.15s;
    }
    .shortcut-reset-btn:hover { opacity: 1; }
    @keyframes scPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Guide Overlay */
    #guide-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center;
      z-index: 3000;
    }
    #guide-panel {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      width: 90vw; max-width: 800px;
      height: 85vh;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #guide-panel .guide-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #30363d;
      flex-shrink: 0;
    }
    #guide-panel .guide-header h2 { margin: 0; font-size: 16px; color: #f0f6fc; }
    #guide-panel .guide-header input {
      background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 5px 10px; color: #d1d5db; font-size: 12px; width: 200px;
    }
    #guide-panel .guide-toc {
      padding: 12px 20px;
      border-bottom: 1px solid #21262d;
      flex-shrink: 0;
      display: flex; flex-wrap: wrap; gap: 4px;
    }
    #guide-panel .guide-toc a {
      color: #58a6ff; font-size: 11px; text-decoration: none;
      padding: 2px 6px; border-radius: 4px;
    }
    #guide-panel .guide-toc a:hover { background: #21262d; }
    #guide-body {
      flex: 1; overflow-y: auto; padding: 20px;
      color: #d1d5db; font-size: 13px; line-height: 1.7;
    }
    #guide-body h2 {
      color: #f0f6fc; font-size: 18px; margin: 28px 0 12px;
      padding-bottom: 8px; border-bottom: 1px solid #21262d;
    }
    #guide-body h2:first-child { margin-top: 0; }
    #guide-body h3 { color: #e6edf3; font-size: 14px; margin: 20px 0 8px; }
    #guide-body h4 { color: #c9d1d9; font-size: 13px; margin: 16px 0 6px; }
    #guide-body p { margin: 8px 0; }
    #guide-body code {
      background: #0d1117; border: 1px solid #30363d; border-radius: 4px;
      padding: 1px 5px; font-size: 12px; color: #79c0ff;
    }
    #guide-body pre {
      background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 12px; overflow-x: auto; margin: 10px 0;
    }
    #guide-body pre code { border: none; padding: 0; background: none; }
    #guide-body table {
      width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;
    }
    #guide-body th {
      text-align: left; padding: 8px 10px;
      background: #0d1117; border: 1px solid #30363d; color: #8b949e; font-weight: 600;
    }
    #guide-body td {
      padding: 6px 10px; border: 1px solid #21262d; color: #d1d5db;
    }
    #guide-body tr:hover td { background: rgba(56,139,253,0.05); }
    #guide-body ul, #guide-body ol { padding-left: 20px; margin: 8px 0; }
    #guide-body li { margin: 4px 0; }
    #guide-body a { color: #58a6ff; text-decoration: none; }
    #guide-body a:hover { text-decoration: underline; }
    #guide-body strong { color: #f0f6fc; }
    #guide-body hr { border: none; border-top: 1px solid #21262d; margin: 24px 0; }
    #guide-body .guide-section { scroll-margin-top: 10px; }

    /* Status Bar */
    /* Title Bar */
    #title-bar {
      height: 42px;
      background: #0d1117;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      padding: 0 14px 0 80px; /* 80px left padding for macOS traffic lights, adjusted by JS on Windows */
      font-size: 12px;
      color: #8b949e;
      gap: 10px;
      flex-shrink: 0;
      -webkit-app-region: drag;
      user-select: none;
    }
    #title-bar button, #title-bar select, #title-bar span[onclick] {
      -webkit-app-region: no-drag;
    }
    .title-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title-left { justify-content: flex-start; }
    .title-center {
      flex: 1;
      text-align: center;
      color: #484f58;
      font-size: 12px;
      font-weight: 500;
    }
    .title-right {
      justify-content: flex-end;
    }
    #title-bar button {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
    }
    #title-bar button:hover { background: #30363d; color: #d1d5db; }

    /* FTP mode indicator */
    #ftp-mode-badge {
      display: none;
      background: #0066cc;
      color: #fff;
      padding: 1px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }

    #ftp-mode-badge.visible { display: inline-block; }

    /* Collab Panel */
    #collab-panel { padding: 12px; display: flex; flex-direction: column; gap: 12px; height: 100%; }
    #collab-panel .collab-section { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; }
    #collab-panel .collab-section h3 { font-size: 12px; color: #f0f6fc; margin-bottom: 8px; font-weight: 600; }
    #collab-panel .collab-section p { font-size: 11px; color: #8b949e; margin-bottom: 8px; line-height: 1.4; }
    #collab-panel input[type="text"] { width: 100%; padding: 6px 10px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #d1d5db; font-size: 12px; margin-bottom: 6px; }
    #collab-panel .btn-collab { padding: 6px 14px; border-radius: 6px; border: none; font-size: 12px; cursor: pointer; font-weight: 500; transition: background 0.15s; }
    #collab-panel .btn-collab-primary { background: #238636; color: #fff; }
    #collab-panel .btn-collab-primary:hover { background: #2ea043; }
    #collab-panel .btn-collab-danger { background: #da3633; color: #fff; }
    #collab-panel .btn-collab-danger:hover { background: #f85149; }
    #collab-panel .btn-collab-secondary { background: #30363d; color: #d1d5db; }
    #collab-panel .btn-collab-secondary:hover { background: #484f58; }
    #collab-code-display { font-family: 'SF Mono', Menlo, monospace; font-size: 22px; font-weight: 700; color: #58a6ff; letter-spacing: 4px; text-align: center; padding: 10px; background: #0d1117; border: 1px dashed #30363d; border-radius: 6px; margin: 8px 0; user-select: all; }
    #collab-users-list { list-style: none; padding: 0; margin: 0; }
    #collab-users-list li { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 12px; color: #d1d5db; }
    #collab-users-list li .user-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    #collab-status-bar { font-size: 11px; color: #8b949e; padding: 4px 0; display: flex; align-items: center; gap: 6px; }
    #collab-status-bar .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #238636; animation: pulse-dot 2s infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .collab-active-indicator { display: none; width: 6px; height: 6px; border-radius: 50%; background: #238636; margin-left: 4px; }
    .collab-active-indicator.visible { display: inline-block; }

    /* Welcome / Cloud Account Overlay */
    #welcome-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #welcome-overlay.hidden { display: none; }
    #welcome-box {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
    }
    #welcome-box h1 { font-size: 28px; margin-bottom: 8px; color: #fff; }
    #welcome-box .brand { color: #569cd6; font-family: 'SF Mono', Monaco, monospace; }
    #welcome-box .welcome-msg { color: #8b949e; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
    #welcome-box .form-group { margin-bottom: 14px; text-align: left; }
    #welcome-box .form-group label { display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px; }
    #welcome-box .form-group input { width: 100%; padding: 10px 12px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #fff; font-size: 14px; }
    #welcome-box .form-group input:focus { outline: none; border-color: #569cd6; }
    #welcome-box .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 8px; }
    #welcome-box .btn-primary { background: #0e639c; color: #fff; }
    #welcome-box .btn-primary:hover { background: #1177bb; }
    #welcome-box .btn-secondary { background: #30363d; color: #d1d5db; }
    #welcome-box .btn-secondary:hover { background: #3d444d; }
    #welcome-box .toggle-link { color: #569cd6; cursor: pointer; font-size: 13px; margin-top: 16px; display: inline-block; }
    #welcome-box .error-msg { color: #f48771; font-size: 13px; margin-top: 8px; }
    #welcome-box .skip-link { color: #6e7681; cursor: pointer; font-size: 12px; margin-top: 16px; display: inline-block; }
    #welcome-box .skip-link:hover { color: #8b949e; }

    /* Cloud account badge in status bar */
    #cloud-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #569cd6;
      cursor: pointer;
    }
    #cloud-badge:hover { color: #7ab8e8; }
    #cloud-badge .sync-icon { animation: none; }
    #cloud-badge .sync-icon.syncing { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <!-- Welcome / Login Overlay -->
  <div id="welcome-overlay">
    <div id="welcome-box">
      <h1>dTerm</h1>
      <p class="welcome-msg" id="welcome-msg">Welcome to dTerm</p>
      <div id="welcome-error" class="error-msg" style="display:none;"></div>

      <!-- Login Form -->
      <div id="login-form">
        <div class="form-group">
          <label>Username or Email</label>
          <input type="text" id="cloud-username" placeholder="username" autocomplete="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="cloud-password" placeholder="password" autocomplete="current-password" onkeydown="if(event.key==='Enter')cloudLogin()">
        </div>
        <button class="btn btn-primary" onclick="cloudLogin()">Sign In</button>
        <span class="toggle-link" onclick="showRegisterForm()">Create Account</span>
      </div>

      <!-- Register Form -->
      <div id="register-form" style="display:none;">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="reg-username" placeholder="username">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-password" placeholder="password (min 5 chars)">
        </div>
        <button class="btn btn-primary" onclick="cloudRegister()">Create Account</button>
        <span class="toggle-link" onclick="showLoginForm()">Already have an account? Sign In</span>
      </div>

      <!-- Logged In View -->
      <div id="welcome-logged-in" style="display:none;">
        <p style="color:#4ec94e; margin-bottom:16px;">&#10003; Signed in as <strong id="welcome-username"></strong></p>
        <div id="trial-notice" style="display:none; background:#2d1f00; border:1px solid #d39e00; border-radius:6px; padding:10px 14px; margin-bottom:12px; font-size:13px; color:#ffc107;">
          <span id="trial-notice-text"></span>
          <span class="toggle-link" onclick="showPaymentView()" style="margin-left:8px;">Purchase Now</span>
        </div>
        <button class="btn btn-primary" onclick="dismissWelcome()">Continue to dTerm</button>
        <button class="btn btn-secondary" onclick="cloudLogout()">Sign Out</button>
      </div>

      <!-- Payment Required View -->
      <div id="payment-required" style="display:none;">
        <p style="color:#ffc107; margin-bottom:12px; font-size:14px;" id="payment-msg">Payment is required to use dTerm.</p>
        <button class="btn btn-primary" onclick="showPaymentView()">Complete Purchase</button>
        <button class="btn btn-secondary" onclick="cloudLogout()" style="margin-top:4px;">Sign Out</button>
      </div>

      <!-- Payment Webview -->
      <div id="payment-view" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <span style="font-size:13px; color:#8b949e;">Complete your purchase</span>
          <span class="toggle-link" onclick="hidePaymentView()">Back</span>
        </div>
        <webview id="payment-webview" style="width:100%; height:420px; border-radius:8px; border:1px solid #30363d;"></webview>
      </div>

    </div>
  </div>

  <!-- Resize Ghost -->
  <div id="resize-ghost"></div>

  <!-- Update Bar -->
  <div id="update-bar">
    <span id="update-bar-text">Downloading update...</span>
    <button id="update-bar-btn" onclick="api.appUpdate.installUpdate()" style="display:none;">Restart Now</button>
  </div>
  <div id="broadcast-overlay" onclick="if(event.target===this)dismissBroadcast()">
    <div id="broadcast-modal">
      <div class="broadcast-icon">&#128226;</div>
      <h3>Announcement</h3>
      <div id="broadcast-text" class="broadcast-msg"></div>
      <button onclick="dismissBroadcast()">Got it</button>
    </div>
  </div>

  <!-- Title Bar -->
  <div id="title-bar">
    <div class="title-section title-left">
      <span id="ftp-mode-badge">FTP</span>
      <span id="status-file">No file open</span>
      <span id="status-line" style="color:#484f58;">Ln 1, Col 1</span>
    </div>
    <div class="title-center">dTerm <span id="title-version" style="font-size:10px;color:#484f58;font-weight:normal;"></span></div>
    <div class="title-section title-right">
      <span id="cloud-badge" onclick="showCloudMenu()" style="display:none;" title="Cloud Account">
        <span class="sync-icon">&#9729;</span>
        <span id="cloud-badge-text">Not signed in</span>
      </span>
      <button id="cloud-sync-btn" onclick="manualSync()" style="display:none;" title="Sync Now">&#8635; Sync</button>
      <span id="session-sync-time" style="color:#484f58;font-size:11px;" title="Last session save"></span>
      <span id="notif-badge" onclick="showContact()" title="Notifications" style="cursor:pointer;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        <span id="notif-count"></span>
      </span>
      <img id="user-avatar" onclick="toggleMenu()" title="Profile">
      <div id="user-avatar-initials" onclick="toggleMenu()" title="Profile"></div>
      <div id="menu-dropdown-wrapper" style="position:relative;">
        <button onclick="toggleMenu()" id="menu-btn" title="Menu">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div id="menu-dropdown" style="display:none;">
          <div class="menu-item" onclick="showSettings(); closeMenu();">Settings</div>
          <div class="menu-item" onclick="showShortcuts(); closeMenu();">Keyboard Shortcuts</div>
          <div class="menu-item" onclick="showContact(); closeMenu();">Contact</div>
          <div class="menu-item" onclick="showGuide(); closeMenu();">User Guide</div>
          <div class="menu-divider"></div>
          <div class="menu-item" onclick="showAbout(); closeMenu();">About dTerm</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Navigation Tabs -->
  <div id="nav-tabs">
    <button class="nav-tab" data-panel="files" onclick="showLeftTab('files')" title="Explorer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
      Files
    </button>
    <button class="nav-tab" data-panel="browser" onclick="showLeftTab('browser')" title="Browser">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
      Browser
    </button>
    <button class="nav-tab" data-panel="git" onclick="showLeftTab('git')" title="Source Control">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 009 9"/></svg>
      Git
    </button>
    <button class="nav-tab" data-panel="search" onclick="showLeftTab('search')" title="Search">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Search
    </button>
    <button class="nav-tab" data-panel="terminal" onclick="showLeftTab('terminal')" title="Terminal">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
      Terminal
    </button>
    <div class="nav-tab-separator"></div>
    <button class="nav-tab" data-panel="runner" onclick="showLeftTab('runner')" title="Code Runner">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      Run
    </button>
    <button class="nav-tab" data-panel="notes" onclick="showLeftTab('notes')" title="Notes">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Notes
    </button>
    <button class="nav-tab" data-panel="snippets" onclick="showLeftTab('snippets')" title="Snippets">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
      Snippets
    </button>
    <button class="nav-tab" data-panel="processes" onclick="showLeftTab('processes')" title="Processes">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
      Procs
    </button>
    <button class="nav-tab" data-panel="tools" onclick="showLeftTab('tools')" title="Tools">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
      Tools
    </button>
    <button class="nav-tab" data-panel="ai" onclick="showLeftTab('ai')" title="AI Chat">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      AI
    </button>
    <button class="nav-tab" data-panel="ftp" onclick="showLeftTab('ftp')" title="FTP">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
      FTP
    </button>
    <button class="nav-tab" data-panel="vault" onclick="showLeftTab('vault')" title="LastPass Vault">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      Vault
    </button>
    <div class="nav-tab-separator"></div>
    <button class="nav-tab" data-panel="collab" onclick="showLeftTab('collab')" title="Collaborate">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Collab
      <span class="collab-active-indicator" id="collab-nav-dot"></span>
    </button>
  </div>

  <!-- App Container -->
  <div id="app-container">
  <!-- Left Panel -->
  <div id="left-panel">
    <!-- Left Panel Content -->
    <div id="left-panel-content">
      <!-- Files Tab -->
      <div id="left-tab-files" class="left-tab-content">
        <div id="file-manager">
          <div id="fm-toolbar">
            <button onclick="goHome()">Home</button>
            <button onclick="goUp()">Up</button>
            <button onclick="openFolder()">Open</button>
            <button onclick="refresh()">Refresh</button>
            <button id="hidden-toggle" onclick="toggleHidden()">Hidden</button>
            <button onclick="showRecentMenu(event)">Recent ▾</button>
            <input type="text" id="fm-search" placeholder="Search..." oninput="filterFiles()">
          </div>
          <div id="recent-menu"></div>
          <div id="fm-path"><span>Loading...</span><div id="git-branch"><span class="branch-icon">⎇</span><span id="git-branch-name"></span></div><button onclick="toggleBookmark()" title="Bookmark this folder">☆</button></div>
          <div id="bookmarks-bar"></div>
          <div id="file-list"></div>
          <div id="fm-bottom-toolbar">
            <button onclick="newFile()">+ File</button>
            <button onclick="newFolder()">+ Folder</button>
          </div>
        </div>
      </div>

      <!-- Browser Tab -->
      <div id="left-tab-browser" class="left-tab-content">
        <div id="mini-browser">
          <div id="browser-tab-bar">
            <button id="browser-new-tab" onclick="createBrowserTab()" title="New Tab">+</button>
          </div>
          <div id="mini-browser-toolbar">
            <button onclick="miniBrowserBack()">←</button>
            <button onclick="miniBrowserForward()">→</button>
            <button onclick="miniBrowserRefresh()">↻</button>
            <button onclick="miniBrowserHome()">⌂</button>
            <input type="text" id="mini-browser-url" placeholder="Enter URL..." value="" onkeydown="if(event.key==='Enter')miniBrowserGo()">
            <button onclick="miniBrowserGo()">Go</button>
          </div>
          <div id="browser-device-tabs">
            <button class="device-tab active" data-device="desktop" onclick="setBrowserDevice('desktop')">Desktop</button>
            <button class="device-tab" data-device="tablet" onclick="setBrowserDevice('tablet')">Tablet</button>
            <button class="device-tab" data-device="mobile" onclick="setBrowserDevice('mobile')">Mobile</button>
            <span id="browser-viewport-label">100%</span>
          </div>
          <div id="mini-browser-content">
            <div id="mini-browser-loading"><span class="loading-spinner"></span>Loading...</div>
          </div>
        </div>
      </div>

      <!-- Git Tab -->
      <div id="left-tab-git" class="left-tab-content">
        <div id="git-panel">
          <div class="left-tab-header" style="display:flex;justify-content:space-between;align-items:center;">
            <span>Source Control</span>
            <div style="display:flex;gap:4px;">
              <button onclick="toggleGitBranches()" title="Switch Branch" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:12px;">⎇</button>
              <button onclick="toggleGitLog()" title="History" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:12px;">⏱</button>
            </div>
          </div>
          <!-- Branch Selector -->
          <div id="git-branch-selector" style="display:none;padding:4px 8px 8px;">
            <div style="display:flex;gap:4px;margin-bottom:4px;">
              <input type="text" id="git-new-branch" placeholder="New branch name..." style="flex:1;padding:4px 6px;background:#21262d;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:11px;">
              <button onclick="gitCreateNewBranch()" style="padding:4px 8px;background:#238636;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:11px;">Create</button>
            </div>
            <div id="git-branch-list" style="max-height:150px;overflow-y:auto;"></div>
          </div>
          <div id="git-commit-area">
            <input type="text" id="git-commit-msg" placeholder="Commit message..." style="width:100%;padding:6px 8px;background:#21262d;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;margin-bottom:6px;">
            <div style="display:flex;gap:4px;">
              <button onclick="gitCommitAll()" style="flex:1;padding:4px 8px;background:#0e639c;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:11px;">Commit All</button>
              <button onclick="gitPush()" style="padding:4px 8px;background:#30363d;border:none;border-radius:4px;color:#d1d5db;cursor:pointer;font-size:11px;">Push</button>
              <button onclick="gitPull()" style="padding:4px 8px;background:#30363d;border:none;border-radius:4px;color:#d1d5db;cursor:pointer;font-size:11px;">Pull</button>
            </div>
          </div>
          <div class="left-tab-header" style="margin-top:8px;font-size:11px;color:#8b949e;">Changes <button onclick="loadGitStatus()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:11px;">↻</button></div>
          <div id="git-changes-list" style="flex:1;overflow-y:auto;padding:4px 8px;font-size:12px;font-family:monospace;"></div>
          <!-- Git Log -->
          <div id="git-log-section" style="display:none;flex:1;overflow-y:auto;">
            <div class="left-tab-header" style="font-size:11px;color:#8b949e;">History <button onclick="loadGitLog()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:11px;">↻</button></div>
            <div id="git-log-list" style="padding:4px 8px;font-size:12px;font-family:monospace;"></div>
          </div>
        </div>
      </div>

      <!-- Search Tab -->
      <div id="left-tab-search" class="left-tab-content">
        <div id="search-panel">
          <div class="left-tab-header">Search Files</div>
          <div style="padding:0 8px 8px;">
            <input type="text" id="global-search-input" placeholder="Search in files..." style="width:100%;padding:6px 8px;background:#21262d;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;margin-bottom:6px;" onkeydown="if(event.key==='Enter')globalSearch()">
            <div style="display:flex;gap:8px;font-size:11px;color:#8b949e;margin-bottom:6px;">
              <label><input type="checkbox" id="search-regex"> Regex</label>
              <label><input type="checkbox" id="search-case"> Case sensitive</label>
            </div>
            <button onclick="globalSearch()" style="width:100%;padding:4px 8px;background:#0e639c;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:11px;">Search</button>
          </div>
          <div id="search-results" style="flex:1;overflow-y:auto;padding:4px 8px;font-size:12px;"></div>
        </div>
      </div>

      <!-- Terminal Tab -->
      <div id="left-tab-terminal" class="left-tab-content">
        <div id="left-terminal-area">
          <div class="left-tab-header">Terminal <button onclick="createLeftTerminal()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:13px;">+</button></div>
          <div id="left-terminal-container"></div>
        </div>
      </div>

      <!-- Code Runner Tab -->
      <div id="left-tab-runner" class="left-tab-content">
        <div id="runner-panel">
          <div class="left-tab-header">Code Runner <button onclick="refreshRunner()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:11px;">↻</button></div>
          <button class="runner-run-btn" id="runner-run-file-btn" onclick="runCurrentFile()" disabled>
            <span style="color:#4ec94e;">▶</span> Run Current File
          </button>
          <div class="runner-file-info" id="runner-file-info">No file open in editor</div>
          <div class="runner-section">Project Tasks</div>
          <div id="runner-tasks-list"><div class="runner-empty">Open a project folder to detect tasks</div></div>
          <div class="runner-section">Quick Run</div>
          <div class="runner-custom">
            <input type="text" id="runner-custom-cmd" placeholder="e.g. npm start" onkeydown="if(event.key==='Enter')runCustomCommand()">
            <button onclick="runCustomCommand()">Run</button>
          </div>
        </div>
      </div>

      <!-- Notes Tab -->
      <div id="left-tab-notes" class="left-tab-content">
        <div id="notes-panel">
          <div class="left-tab-header">Notes</div>
          <div id="notes-editor-container" style="flex:1;min-height:0;"></div>
        </div>
      </div>

      <!-- Snippets Tab -->
      <div id="left-tab-snippets" class="left-tab-content">
        <div style="display:flex;flex-direction:column;height:100%;">
          <div class="left-tab-header">Snippets <button onclick="createSnippet()" style="background:none;border:none;color:#0066cc;cursor:pointer;font-size:11px;">+ New</button></div>
          <div id="snippets-list" style="flex:1;overflow-y:auto;padding:4px;"></div>
        </div>
      </div>

      <!-- Processes Tab -->
      <div id="left-tab-processes" class="left-tab-content">
        <div style="display:flex;flex-direction:column;height:100%;">
          <div class="left-tab-header">Processes <button onclick="refreshProcesses()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:11px;">↻</button></div>
          <div style="padding:4px 8px;">
            <input type="text" id="process-search" placeholder="Search processes..." style="width:100%;padding:4px 8px;background:#0d1117;border:1px solid #30363d;border-radius:3px;color:#d1d5db;font-size:11px;" oninput="filterProcessList()">
          </div>
          <div class="runner-section">Listening Ports</div>
          <div id="ports-list" style="overflow-y:auto;max-height:200px;padding:4px;"></div>
          <div class="runner-section">Processes</div>
          <div id="process-list" style="flex:1;overflow-y:auto;padding:4px;"></div>
        </div>
      </div>

      <!-- Tools Tab -->
      <div id="left-tab-tools" class="left-tab-content">
        <div id="tools-panel">
          <div id="tools-list">
            <div class="tools-category">Network</div>
            <button class="tool-btn" onclick="openTool('ping')">Ping</button>
            <button class="tool-btn" onclick="openTool('traceroute')">Traceroute</button>
            <button class="tool-btn" onclick="openTool('dns-lookup')">DNS Lookup</button>
            <button class="tool-btn" onclick="openTool('reverse-dns')">Reverse DNS</button>
            <button class="tool-btn" onclick="openTool('port-scanner')">Port Scanner</button>
            <button class="tool-btn" onclick="openTool('ip-info')">IP Info</button>
            <button class="tool-btn" onclick="openTool('whois')">Whois</button>
            <button class="tool-btn" onclick="openTool('mac-lookup')">MAC Lookup</button>
            <button class="tool-btn" onclick="openTool('subnet-calc')">Subnet Calculator</button>
            <button class="tool-btn" onclick="openTool('ping-monitor')">Ping Monitor</button>
            <button class="tool-btn" onclick="openTool('uptime-monitor')">Uptime Monitor</button>
            <button class="tool-btn" onclick="openTool('blacklist-check')">Blacklist Check</button>
            <div class="tools-category">SSL / Security</div>
            <button class="tool-btn" onclick="openTool('ssl-checker')">SSL Checker</button>
            <button class="tool-btn" onclick="openTool('ssl-expiry')">SSL Expiry</button>
            <button class="tool-btn" onclick="openTool('security-headers')">Security Headers</button>
            <button class="tool-btn" onclick="openTool('password-generator')">Password Generator</button>
            <button class="tool-btn" onclick="openTool('password-checker')">Password Checker</button>
            <button class="tool-btn" onclick="openTool('hash-generator')">Hash Generator</button>
            <div class="tools-category">Web / SEO</div>
            <button class="tool-btn" onclick="openTool('seo-analyzer')">SEO Analyzer</button>
            <button class="tool-btn" onclick="openTool('page-speed')">Page Speed</button>
            <button class="tool-btn" onclick="openTool('broken-links')">Broken Links</button>
            <button class="tool-btn" onclick="openTool('http-headers')">HTTP Headers</button>
            <button class="tool-btn" onclick="openTool('open-graph')">Open Graph</button>
            <button class="tool-btn" onclick="openTool('meta-tags')">Meta Tags</button>
            <button class="tool-btn" onclick="openTool('robots-txt')">Robots.txt</button>
            <button class="tool-btn" onclick="openTool('sitemap-generator')">Sitemap Generator</button>
            <button class="tool-btn" onclick="openTool('domain-expiry')">Domain Expiry</button>
            <div class="tools-category">Developer</div>
            <button class="tool-btn" onclick="openTool('api-tester')">API Tester</button>
            <button class="tool-btn" onclick="openTool('json-formatter')">JSON Formatter</button>
            <button class="tool-btn" onclick="openTool('code-beautifier')">Code Beautifier</button>
            <button class="tool-btn" onclick="openTool('regex-tester')">Regex Tester</button>
            <button class="tool-btn" onclick="openTool('base64')">Base64</button>
            <button class="tool-btn" onclick="openTool('jwt-decoder')">JWT Decoder</button>
            <button class="tool-btn" onclick="openTool('cron-parser')">Cron Parser</button>
            <button class="tool-btn" onclick="openTool('uuid-generator')">UUID Generator</button>
            <button class="tool-btn" onclick="openTool('timestamp-converter')">Timestamp Converter</button>
            <div class="tools-category">System</div>
            <button class="tool-btn" onclick="openTool('env-viewer')">Environment Variables</button>
            <div class="tools-category">Utilities</div>
            <button class="tool-btn" onclick="openTool('markdown-preview')">Markdown Preview</button>
            <button class="tool-btn" onclick="openTool('lorem-ipsum')">Lorem Ipsum</button>
            <button class="tool-btn" onclick="openTool('qr-generator')">QR Generator</button>
            <button class="tool-btn" onclick="openTool('color-picker')">Color Picker</button>
          </div>
        </div>
        <div id="tools-content" style="display:none;"></div>
      </div>

      <!-- AI Tab -->
      <div id="left-tab-ai" class="left-tab-content">
        <div class="left-tab-header">
          AI Chat
          <select id="ai-select" onchange="switchAI()">
            <option value="https://chatgpt.com">ChatGPT</option>
            <option value="https://copilot.microsoft.com">Copilot</option>
            <option value="https://claude.ai">Claude</option>
            <option value="https://gemini.google.com">Gemini</option>
            <option value="https://poe.com">Poe</option>
            <option value="https://perplexity.ai">Perplexity</option>
          </select>
        </div>
        <webview id="ai-frame" src="about:blank" allowpopups></webview>
      </div>

      <!-- FTP Tab -->
      <div id="left-tab-ftp" class="left-tab-content">
        <div id="ftp-panel">
          <div class="left-tab-header">FTP Connection</div>
          <div id="ftp-bar">
            <select id="ftp-saved" onchange="loadSavedConnection()">
              <option value="">Saved connections...</option>
            </select>
            <input type="text" id="ftp-host" placeholder="Host (e.g., ftp.example.com)" spellcheck="false">
            <div id="ftp-bar-row">
              <input type="text" id="ftp-port" placeholder="Port" value="21" spellcheck="false">
              <input type="text" id="ftp-user" placeholder="Username" spellcheck="false">
            </div>
            <input type="password" id="ftp-pass" placeholder="Password">
            <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:#8b949e;margin:4px 0;"><input type="checkbox" id="ftp-secure"> Secure (FTPS)</label>
            <div id="ftp-bar-actions">
              <button id="ftp-save-btn" onclick="saveConnection()">Save</button>
              <button id="ftp-delete-saved-btn" onclick="deleteSavedConnection()" style="display:none;">Delete</button>
              <button id="ftp-connect-btn" onclick="connectFtp()">Connect</button>
              <button id="ftp-disconnect-btn" onclick="disconnectFtp()" style="display:none;">Disconnect</button>
            </div>
            <div id="ftp-progress-bar"><div id="ftp-progress-fill"></div></div>
            <div id="ftp-status" style="margin-top:8px;">Not connected</div>
          </div>
        </div>
      </div>

      <!-- Vault Tab (LastPass) -->
      <div id="left-tab-vault" class="left-tab-content">
        <div id="vault-panel" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
          <div class="left-tab-header">
            LastPass Vault
            <button onclick="vaultRefresh()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:12px;margin-left:auto;" title="Refresh">↻</button>
          </div>

          <!-- Not Installed State -->
          <div id="vault-not-installed" style="display:none;padding:12px;font-size:12px;color:#8b949e;">
            <p style="margin:0 0 8px;">LastPass CLI (<code style="background:#161b22;padding:2px 4px;border-radius:3px;color:#d1d5db;">lpass</code>) is not installed.</p>
            <p style="margin:0 0 12px;">Install it via Homebrew:</p>
            <code style="display:block;background:#0d1117;padding:8px;border-radius:4px;color:#58a6ff;font-size:11px;margin-bottom:12px;">brew install lastpass-cli</code>
            <button onclick="vaultRunInstall()" style="background:#238636;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;width:100%;">Run in Terminal</button>
          </div>

          <!-- Login State -->
          <div id="vault-login" style="display:none;padding:12px;">
            <p style="font-size:12px;color:#8b949e;margin:0 0 8px;">Sign in to your LastPass account:</p>
            <input type="email" id="vault-email" placeholder="LastPass email" spellcheck="false" style="width:100%;padding:6px;background:#0d1117;border:1px solid #30363d;color:#d1d5db;font-size:12px;border-radius:4px;margin-bottom:8px;box-sizing:border-box;">
            <button onclick="vaultLogin()" style="background:#238636;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;width:100%;">Login via Terminal</button>
            <p style="font-size:10px;color:#6e7681;margin:8px 0 0;">Master password will be entered in the terminal for security.</p>
          </div>

          <!-- Logged In State -->
          <div id="vault-main" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
            <div style="padding:8px;border-bottom:1px solid #30363d;">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
                <span style="font-size:11px;color:#3fb950;">●</span>
                <span id="vault-user-email" style="font-size:11px;color:#d1d5db;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                <button onclick="vaultLogout()" style="background:none;border:1px solid #30363d;color:#8b949e;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Logout</button>
              </div>
              <input type="text" id="vault-search" placeholder="Search vault..." spellcheck="false" oninput="vaultFilterEntries()" style="width:100%;padding:6px;background:#0d1117;border:1px solid #30363d;color:#d1d5db;font-size:12px;border-radius:4px;box-sizing:border-box;">
            </div>
            <div id="vault-entries" style="flex:1;overflow-y:auto;padding:4px 0;"></div>
          </div>

          <!-- Entry Detail View -->
          <div id="vault-detail" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
            <div style="padding:8px;border-bottom:1px solid #30363d;display:flex;align-items:center;gap:8px;">
              <button onclick="vaultBackToList()" style="background:none;border:none;color:#8b949e;cursor:pointer;font-size:14px;">←</button>
              <span id="vault-detail-title" style="font-size:12px;color:#d1d5db;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
            </div>
            <div id="vault-detail-content" style="flex:1;overflow-y:auto;padding:8px;"></div>
          </div>

          <div id="vault-status" style="padding:4px 8px;font-size:10px;color:#6e7681;border-top:1px solid #30363d;display:none;"></div>
        </div>
      </div>

      <!-- Collab Tab -->
      <div id="left-tab-collab" class="left-tab-content">
        <div id="collab-panel">
          <div class="left-tab-header">Live Collaboration</div>

          <!-- Not in session -->
          <div id="collab-lobby">
            <div class="collab-section">
              <h3>Start a Session</h3>
              <p>Share your current file for real-time collaborative editing. Others can join with the access code.</p>
              <input type="text" id="collab-display-name" placeholder="Your display name" spellcheck="false">
              <button class="btn-collab btn-collab-primary" onclick="collabCreateRoom()" style="width:100%;">Share Current File</button>
            </div>

            <div class="collab-section">
              <h3>Join a Session</h3>
              <p>Enter an access code to join someone else's editing session.</p>
              <input type="text" id="collab-join-code" placeholder="Access code (e.g., ABC123)" spellcheck="false" style="text-transform:uppercase; letter-spacing:2px; text-align:center; font-weight:600;">
              <button class="btn-collab btn-collab-secondary" onclick="collabJoinRoom()" style="width:100%;">Join Session</button>
            </div>
          </div>

          <!-- Active session -->
          <div id="collab-session" style="display:none;">
            <div class="collab-section">
              <h3>Access Code</h3>
              <div id="collab-code-display"></div>
              <button class="btn-collab btn-collab-secondary" onclick="collabCopyCode()" style="width:100%; margin-top:4px;">Copy Code</button>
            </div>

            <div class="collab-section">
              <h3>File</h3>
              <div id="collab-filename" style="font-size:12px; color:#d1d5db; word-break:break-all;"></div>
              <div id="collab-status-bar">
                <span class="status-dot"></span>
                <span id="collab-status-text">Connected</span>
              </div>
            </div>

            <div class="collab-section" style="flex:1;">
              <h3>Collaborators</h3>
              <ul id="collab-users-list"></ul>
            </div>

            <button class="btn-collab btn-collab-danger" onclick="collabLeaveRoom()" style="width:100%;">Leave Session</button>
          </div>

          <div id="collab-error" style="color:#f85149; font-size:11px; padding:4px 0; display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Left Resizer -->
  <div class="panel-resizer" id="left-resizer"></div>
  <!-- Left Panel Toggle -->
  <div class="panel-toggle" id="left-toggle" onclick="toggleLeftPanel()" title="Toggle left panel">
    <span class="toggle-icon">◀</span>
  </div>
  <!-- Swap Panel Sizes Button -->
  <div class="panel-toggle" id="swap-toggle" onclick="swapPanelSizes()" title="Swap panel sizes (⌘⇧S)">
    <span class="toggle-icon">⇄</span>
  </div>

  <!-- Main Area -->
  <div id="main-area">
    <!-- Editor Area -->
    <div id="editor-area">
      <div id="editor-tabs"></div>
      <div id="editor-container"></div>
      <div id="md-preview-container"></div>
    </div>

    <div id="resizer"></div>

    <!-- Terminal Area -->
    <div id="terminal-area">
      <div id="terminal-tabs">
        <button id="new-term-btn" onclick="createTerminal()">+</button>
        <div class="term-profiles" id="term-profiles">
          <button class="term-profile-btn" onclick="showSshDialog()" title="SSH Connection">ssh</button>
        </div>
      </div>
      <div id="terminal-container">
        <div id="terminal-search">
          <input type="text" id="terminal-search-input" placeholder="Search..." onkeydown="handleTerminalSearchKey(event)">
          <button onclick="terminalSearchPrev()">↑</button>
          <button onclick="terminalSearchNext()">↓</button>
          <span class="search-count" id="terminal-search-count"></span>
          <button onclick="closeTerminalSearch()">✕</button>
        </div>
      </div>
    </div>
    <!-- Status Bar -->
    <div id="status-bar">
      <div class="status-item clickable" id="sb-branch" onclick="showLeftTab('git')" title="Git branch"></div>
      <div class="status-item" id="sb-dir" title="Current directory"></div>
      <div class="status-spacer"></div>
      <div class="status-item" id="sb-lang" title="Language"></div>
      <div class="status-item" id="sb-encoding">UTF-8</div>
      <div class="status-item" id="sb-indent" title="Indentation">Spaces: 2</div>
      <div class="status-item" id="sb-cursor" title="Cursor position"></div>
      <div class="status-item" id="sb-terminals" title="Open terminals"></div>
    </div>
  </div>

  <!-- Right panel removed — single sidebar layout -->
  </div><!-- End app-container -->

  <!-- Context Menu (File Manager) -->
  <div id="context-menu">
    <button onclick="openSelectedFile()">Open</button>
    <button onclick="previewSelectedFile()">Preview</button>
    <button id="ctx-download" style="display:none;" onclick="downloadFtpFile()">Download</button>
    <button id="ctx-upload" style="display:none;" onclick="uploadFtpFile()">Upload File</button>
    <button onclick="copyFile()">Copy</button>
    <button onclick="cutFile()">Cut</button>
    <button onclick="pasteFile()">Paste</button>
    <button onclick="renameFile()">Rename</button>
    <button onclick="pinToFavorites()">Pin to Favorites</button>
    <button onclick="compareWithFile()">Compare with...</button>
    <button onclick="deleteFile()" class="danger">Delete</button>
  </div>

  <!-- Terminal Context Menu -->
  <div id="terminal-context-menu">
    <button onclick="terminalCopy()">Copy</button>
    <button onclick="terminalPaste()">Paste</button>
    <button onclick="terminalSelectAll()">Select All</button>
    <button onclick="terminalClear()">Clear</button>
    <hr style="border:none;border-top:1px solid #30363d;margin:4px 0;">
    <button onclick="splitFromMenu('vertical')">Split Right</button>
    <button onclick="splitFromMenu('horizontal')">Split Down</button>
  </div>

  <!-- Command Palette -->
  <div id="command-palette">
    <input type="text" id="command-palette-input" placeholder="Type a command or search..." oninput="filterCommands()" onkeydown="handleCommandKey(event)">
    <div id="command-palette-list"></div>
  </div>

  <!-- File Preview -->
  <div id="file-preview-overlay" onclick="if(event.target===this)closeFilePreview()">
    <button id="file-preview-close" onclick="closeFilePreview()">✕</button>
    <div id="file-preview-container"></div>
  </div>

  <!-- Input Dialog -->
  <div id="input-dialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#21262d; padding:20px; border-radius:8px; border:1px solid #30363d; min-width:300px;">
      <div id="input-dialog-title" style="margin-bottom:12px; font-size:14px; color:#d1d5db;"></div>
      <input type="text" id="input-dialog-input" style="width:100%; padding:8px; background:#0d1117; border:1px solid #30363d; border-radius:4px; color:#d1d5db; font-size:14px; outline:none;">
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button onclick="closeInputDialog()" style="padding:6px 12px; background:#30363d; border:none; border-radius:4px; color:#d1d5db; cursor:pointer;">Cancel</button>
        <button onclick="confirmInputDialog()" style="padding:6px 12px; background:#0066cc; border:none; border-radius:4px; color:#fff; cursor:pointer;">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Overlay -->
  <!-- Notification Toast -->
  <div id="notif-toast">
    <span class="toast-close" onclick="dismissToast()">&times;</span>
    <div class="toast-title" id="toast-title">New Reply</div>
    <div class="toast-body" id="toast-body"></div>
  </div>

  <!-- Contact Modal -->
  <div id="contact-overlay" onclick="if(event.target===this)closeContact()">
    <div id="contact-panel">
      <h2>Contact</h2>

      <!-- Send message form -->
      <div id="contact-form-section">
        <label>From</label>
        <input type="text" id="contact-from" readonly style="opacity:0.7;">

        <label>Subject</label>
        <select id="contact-subject">
          <option value="Bug">Bug Report</option>
          <option value="Idea">Feature Idea</option>
        </select>

        <label>Message</label>
        <textarea id="contact-message" placeholder="Describe the bug or share your idea..."></textarea>

        <div id="contact-sent"></div>
        <div id="contact-error"></div>

        <div class="contact-btn-row">
          <button onclick="closeContact()" style="background:#30363d; color:#d1d5db;">Cancel</button>
          <button onclick="sendContactMessage()" style="background:#238636; color:#fff;">Send</button>
        </div>
      </div>

      <!-- Previous messages -->
      <div id="my-messages-section" style="margin-top:20px; border-top:1px solid #30363d; padding-top:16px;">
        <label style="font-size:13px; color:#f0f6fc; font-weight:600; margin-bottom:8px;">My Messages</label>
        <div id="my-messages-list"></div>
      </div>
    </div>
  </div>

  <div id="about-overlay" onclick="if(event.target===this)closeAbout()">
    <div id="about-panel">
      <div class="about-logo">&#9000;</div>
      <h2>dTerm</h2>
      <div class="about-version" id="about-version">Version 1.2.1</div>
      <div class="about-desc">A developer workspace combining terminal, file browser, code editor, FTP, notes, live collaboration, and more — all in one window.</div>
      <div class="about-info">
        Built by David Kaufman
      </div>
      <button class="about-close" onclick="closeAbout()">Close</button>
    </div>
  </div>

  <div id="settings-overlay" onclick="if(event.target===this)closeSettings()">
    <div id="settings-panel">
      <h2>Settings</h2>
      <div id="settings-photo-section" class="settings-photo-section" style="display:none;">
        <img id="settings-photo-preview" class="settings-photo-preview" style="display:none;">
        <div id="settings-photo-initials" class="settings-photo-initials"></div>
        <div class="settings-photo-actions">
          <button class="photo-btn" onclick="document.getElementById('photo-file-input').click()">Change Photo</button>
          <input type="file" id="photo-file-input" accept="image/*" style="display:none;" onchange="uploadProfilePhoto(this)">
          <span id="photo-upload-status" class="settings-photo-status"></span>
        </div>
      </div>
      <div class="settings-group">
        <label>Editor Font Size</label>
        <input type="number" id="setting-font-size" value="14" min="10" max="24">
      </div>
      <div class="settings-group">
        <label>Default Shell</label>
        <select id="setting-shell">
        </select>
      </div>
      <div class="settings-group">
        <label>Browser Home Page</label>
        <input type="text" id="setting-browser-home" value="https://duckduckgo.com" placeholder="https://duckduckgo.com" style="width:100%; padding:6px 8px; background:#21262d; border:1px solid #30363d; border-radius:4px; color:#d1d5db; font-size:12px;">
      </div>
      <div class="btn-row">
        <button class="secondary" onclick="closeSettings()">Cancel</button>
        <button class="primary" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts Overlay (with inline editing) -->
  <div id="shortcuts-overlay" onclick="if(event.target===this)closeShortcuts()">
    <div id="shortcuts-panel">
      <h2>Keyboard Shortcuts</h2>
      <p style="font-size:11px; color:#8b949e; margin-bottom:12px;">Click a shortcut key to change it</p>
      <div id="shortcuts-list"></div>
      <div style="margin-top:16px; display:flex; gap:8px; justify-content:center;">
        <button class="secondary" onclick="resetShortcutsToDefaults()" style="padding:8px 16px; background:#21262d; border:1px solid #484f58; border-radius:4px; color:#f0883e; cursor:pointer; font-size:12px;">Reset All</button>
        <button class="secondary" onclick="closeShortcuts()" style="padding:8px 20px; background:#30363d; border:none; border-radius:4px; color:#d1d5db; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- User Guide -->
  <div id="guide-overlay" onclick="if(event.target===this)closeGuide()">
    <div id="guide-panel">
      <div class="guide-header">
        <h2>User Guide</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="text" id="guide-search" placeholder="Search guide..." oninput="filterGuide(this.value)">
          <button onclick="closeGuide()" style="background:#30363d;border:none;border-radius:4px;color:#d1d5db;padding:5px 12px;cursor:pointer;font-size:12px;">Close</button>
        </div>
      </div>
      <div class="guide-toc" id="guide-toc"></div>
      <div id="guide-body"></div>
    </div>
  </div>

  <!-- SSH Connection Dialog -->
  <div id="ssh-dialog" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:none;align-items:center;justify-content:center;" onclick="if(event.target===this)closeSshDialog()">
    <div style="background:#21262d;border:1px solid #30363d;border-radius:8px;padding:20px;width:350px;">
      <h3 style="margin:0 0 12px;font-size:14px;color:#d1d5db;">SSH Connection</h3>
      <div id="ssh-saved-list" style="margin-bottom:12px;"></div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <input type="text" id="ssh-host" placeholder="Host (e.g. 192.168.1.1)" style="padding:6px 8px;background:#0d1117;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;">
        <div style="display:flex;gap:8px;">
          <input type="number" id="ssh-port" value="22" placeholder="Port" style="width:70px;padding:6px 8px;background:#0d1117;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;">
          <input type="text" id="ssh-user" placeholder="Username" style="flex:1;padding:6px 8px;background:#0d1117;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;">
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="text" id="ssh-keyfile" placeholder="Key file (optional)" style="flex:1;padding:6px 8px;background:#0d1117;border:1px solid #30363d;border-radius:4px;color:#d1d5db;font-size:12px;" readonly>
          <button onclick="pickSshKeyFile()" style="padding:6px 10px;background:#30363d;border:none;border-radius:4px;color:#d1d5db;cursor:pointer;font-size:11px;white-space:nowrap;">Browse</button>
        </div>
        <label style="font-size:11px;color:#8b949e;display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="ssh-save-conn"> Save this connection
        </label>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button onclick="closeSshDialog()" style="flex:1;padding:6px;background:#30363d;border:none;border-radius:4px;color:#d1d5db;cursor:pointer;">Cancel</button>
          <button onclick="connectSsh()" style="flex:1;padding:6px;background:#0066cc;border:none;border-radius:4px;color:#fff;cursor:pointer;">Connect</button>
        </div>
      </div>
    </div>
  </div>

  <script src="node_modules/xterm/lib/xterm.js"></script>
  <script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="node_modules/xterm-addon-search/lib/xterm-addon-search.js"></script>
  <script src="node_modules/xterm-addon-serialize/lib/xterm-addon-serialize.js"></script>
  <script>
    // Monaco Editor loader
    const monacoLoader = document.createElement('script');
    monacoLoader.src = 'node_modules/monaco-editor/min/vs/loader.js';
    monacoLoader.onload = () => {
      require.config({ paths: { vs: 'node_modules/monaco-editor/min/vs' } });
      require(['vs/editor/editor.main'], () => {
        monacoReady = true;
        monaco.editor.setTheme('vs-dark');
        // Init notes editor now that Monaco is available
        initNotes();
      });
    };
    document.head.appendChild(monacoLoader);

    let monacoReady = false;
    let monacoEditor = null;
    let currentPath = '';
    let selectedFile = null;
    let terminals = [];
    let openFiles = [];
    let activeFileIndex = -1;
    // Collab state (declared early for editor callback access)
    let collabState = null;
    let collabPushPending = false;
    let collabIgnoreNextChange = false;
    let showHidden = false;
    let allFiles = [];
    let clipboard = { file: null, action: null };
    const isWindows = true;
    const isMac = false;
    const defaultShell = 'powershell.exe';

    let settings = {
      fontSize: 14,
      shell: defaultShell,
      theme: 'dark',
      browserHome: 'https://duckduckgo.com',
      minimap: false,
      shortcuts: {},
      panelWidthPercent: 40
    };

    // Default keyboard shortcut definitions
    const DEFAULT_SHORTCUTS = {
      'run-file':              { meta: true, shift: false, alt: false, key: 'r',          label: 'Run current file' },
      'save-file':             { meta: true, shift: false, alt: false, key: 's',          label: 'Save file' },
      'new-terminal':          { meta: true, shift: false, alt: false, key: 't',          label: 'New terminal' },
      'close-tab':             { meta: true, shift: false, alt: false, key: 'w',          label: 'Close tab' },
      'toggle-sidebar':        { meta: true, shift: true,  alt: false, key: 'b',          label: 'Toggle sidebar' },
      'swap-panels':           { meta: true, shift: true,  alt: false, key: 'x',          label: 'Swap panel sizes' },
      'focus-mode':            { meta: true, shift: true,  alt: false, key: 'f',          label: 'Focus mode' },
      'split-vertical':        { meta: true, shift: false, alt: false, key: '\\',         label: 'Split terminal vertical' },
      'split-horizontal':      { meta: true, shift: true,  alt: false, key: '\\',         label: 'Split terminal horizontal' },
      'settings':              { meta: true, shift: false, alt: false, key: ',',           label: 'Settings' },
      'shortcuts':             { meta: true, shift: false, alt: false, key: '/',           label: 'Shortcuts help' },
      'command-palette':       { meta: true, shift: true,  alt: false, key: 'p',           label: 'Command palette' },
      'command-palette-alt':   { meta: true, shift: false, alt: false, key: 'p',           label: 'Command palette (alt)' },
      'terminal-search':       { meta: true, shift: false, alt: false, key: 'f',           label: 'Find in terminal' },
      'terminal-line-start':   { meta: true, shift: false, alt: false, key: 'ArrowLeft',   label: 'Terminal: line start' },
      'terminal-line-end':     { meta: true, shift: false, alt: false, key: 'ArrowRight',  label: 'Terminal: line end' },
      'terminal-word-back':    { meta: true, shift: false, alt: true,  key: 'ArrowLeft',   label: 'Terminal: word back' },
      'terminal-word-forward': { meta: true, shift: false, alt: true,  key: 'ArrowRight',  label: 'Terminal: word forward' },
      'panel-set-width':       { meta: true, shift: true,  alt: false, key: 'l',           label: 'Open left panel to %' },
      'panel-close':           { meta: true, shift: true,  alt: false, key: 'c',           label: 'Close left panel' },
    };

    function getShortcuts() {
      const merged = {};
      for (const [id, def] of Object.entries(DEFAULT_SHORTCUTS)) {
        const override = settings.shortcuts?.[id];
        merged[id] = override
          ? { ...def, meta: override.meta, shift: override.shift, alt: override.alt, key: override.key }
          : { ...def };
      }
      return merged;
    }

    function formatShortcut(combo) {
      let s = '';
      if (combo.meta) s += '⌘';
      if (combo.shift) s += '⇧';
      if (combo.alt) s += '⌥';
      const keyMap = {
        'ArrowLeft': '←', 'ArrowRight': '→', 'ArrowUp': '↑', 'ArrowDown': '↓',
        '\\': '\\', ',': ',', '/': '/', ' ': 'Space'
      };
      s += keyMap[combo.key] || combo.key.toUpperCase();
      return s;
    }

    // Shortcut editor state
    let shortcutRecorderActive = false;
    let shortcutRecorderTarget = null;
    let pendingShortcuts = {};

    // activeRightTab removed — all tabs are in the left panel now

    // File watcher state
    let watchedDir = null;

    // FTP mode state
    let appMode = 'local'; // 'local' or 'ftp'
    let ftpRemoteHost = '';

    // Switch to FTP mode - called when connecting from the FTP tab
    function switchToFtpMode(host) {
      appMode = 'ftp';
      ftpRemoteHost = host;
      currentPath = '/';
      document.getElementById('ftp-mode-badge').classList.add('visible');
      loadFtpFileBrowser();
    }

    // Switch back to local mode
    function switchToLocalMode() {
      appMode = 'local';
      ftpRemoteHost = '';
      document.getElementById('ftp-mode-badge').classList.remove('visible');
      window.api.fs.getHome().then(home => {
        currentPath = home;
        loadFiles();
      });
    }

    async function loadFtpFileBrowser() {
      const fileList = document.getElementById('file-list');
      if (!fileList) return;

      const pathEl = document.querySelector('#fm-path span');
      if (pathEl) pathEl.textContent = `FTP: ${ftpRemoteHost}${currentPath}`;

      fileList.innerHTML = '';

      try {
        const files = await window.api.ftp.list(currentPath);
        allFiles = files.map(f => ({
          name: f.name,
          path: currentPath === '/' ? '/' + f.name : currentPath + '/' + f.name,
          isDirectory: f.isDirectory,
          isFile: !f.isDirectory,
          size: f.size || 0
        }));

        // Add parent directory
        if (currentPath !== '/') {
          const upDiv = document.createElement('div');
          upDiv.className = 'file-item';
          upDiv.innerHTML = '<span>📁</span><span>..</span>';
          upDiv.ondblclick = () => {
            currentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
            loadFtpFileBrowser();
          };
          fileList.appendChild(upDiv);
        }

        const sortedFiles = [...allFiles].filter(f => showHidden || !f.name.startsWith('.'));
        sortedFiles.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        sortedFiles.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          const icon = file.isDirectory ? '📁' : '📄';
          const sizeStr = file.isFile ? formatSize(file.size) : '';
          div.innerHTML = `<span>${icon}</span><span class="file-name">${file.name}</span><span class="file-info">${sizeStr}</span>`;
          div.onclick = (e) => handleClick(file, e);
          div.ondblclick = () => handleDoubleClick(file);
          div.oncontextmenu = (e) => showContextMenu(e, file);
          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    async function openFtpFile(file) {
      const existingIndex = openFiles.findIndex(f => f.path === file.path);
      if (existingIndex !== -1) {
        activateFile(existingIndex);
        return;
      }
      try {
        const content = await window.api.ftp.readFile(file.path);
        openFiles.push({ path: file.path, name: file.name, content: content, modified: false, ftpFile: true });
        activeFileIndex = openFiles.length - 1;
        updateEditorTabs();
        showEditor();
        setEditorContent(content, file.name);
        updateStatusBar();
      } catch (err) {
        document.getElementById('status-file').textContent = `Error: ${err.message}`;
      }
    }

    // Load settings
    function loadSettings() {
      const saved = localStorage.getItem('dterm-settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        document.getElementById('setting-font-size').value = settings.fontSize;
        document.getElementById('setting-shell').value = settings.shell;
        const themeEl = document.getElementById('setting-theme');
        if (themeEl) themeEl.value = settings.theme;
        applyTheme();
      }
      // Always apply browser home page setting to the input field
      document.getElementById('setting-browser-home').value = settings.browserHome;
      // Apply browser home page to active webview
      const webview = getActiveWebview();
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = settings.browserHome;
      if (urlInput) urlInput.value = settings.browserHome;
    }

    function saveSettings() {
      settings.fontSize = parseInt(document.getElementById('setting-font-size').value);
      settings.shell = document.getElementById('setting-shell').value;
      let browserHome = document.getElementById('setting-browser-home').value.trim();
      if (browserHome && !browserHome.startsWith('http://') && !browserHome.startsWith('https://')) {
        browserHome = 'https://' + browserHome;
      }
      settings.browserHome = browserHome || 'https://duckduckgo.com';
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      if (monacoEditor) {
        monacoEditor.updateOptions({ fontSize: settings.fontSize });
      }
      // Apply new home page to active browser tab
      const bWebview = getActiveWebview();
      if (bWebview) bWebview.src = settings.browserHome;
      document.getElementById('mini-browser-url').value = settings.browserHome;
      syncNow();
      closeSettings();
    }

    function applyTheme() {
      if (settings.theme === 'light') {
        document.body.style.background = '#f5f5f5';
        document.body.style.color = '#333';
        if (monacoReady) monaco.editor.setTheme('vs');
      } else {
        document.body.style.background = '#0d1117';
        document.body.style.color = '#d1d5db';
        if (monacoReady) monaco.editor.setTheme('vs-dark');
      }
    }

    function showSettings() {
      document.getElementById('setting-font-size').value = settings.fontSize;
      document.getElementById('setting-shell').value = settings.shell;
      document.getElementById('setting-browser-home').value = settings.browserHome;
      document.getElementById('settings-overlay').style.display = 'flex';
      updateSettingsPhoto();
    }

    function closeSettings() {
      document.getElementById('settings-overlay').style.display = 'none';
    }

    function showShortcuts() {
      pendingShortcuts = JSON.parse(JSON.stringify(settings.shortcuts || {}));
      shortcutRecorderActive = false;
      shortcutRecorderTarget = null;
      renderShortcutsList();
      document.getElementById('shortcuts-overlay').style.display = 'flex';
    }

    function closeShortcuts() {
      shortcutRecorderActive = false;
      shortcutRecorderTarget = null;
      document.getElementById('shortcuts-overlay').style.display = 'none';
    }

    function renderShortcutsList() {
      const list = document.getElementById('shortcuts-list');
      list.innerHTML = '';
      for (const [id, def] of Object.entries(DEFAULT_SHORTCUTS)) {
        const override = pendingShortcuts[id];
        const current = override || { meta: def.meta, shift: def.shift, alt: def.alt, key: def.key };
        const isCustom = !!override;
        const isRecording = shortcutRecorderTarget === id;

        const row = document.createElement('div');
        row.className = 'shortcut-row';

        // Special: panel-set-width gets a percentage input
        const extraHtml = id === 'panel-set-width'
          ? `<input type="number" id="sc-panel-pct" min="10" max="90" value="${settings.panelWidthPercent || 40}"
              style="width:50px; padding:2px 4px; background:#0d1117; border:1px solid #30363d; border-radius:4px; color:#d1d5db; font-size:12px; text-align:center;"
              title="Panel width percentage">
             <span style="color:#8b949e; font-size:11px;">%</span>`
          : '';

        row.innerHTML = `
          <span>${def.label}</span>
          <span class="shortcut-key-group">
            ${extraHtml}
            <span class="shortcut-key clickable ${isRecording ? 'recording' : ''}" id="sc-key-${id}" title="Click to change">
              ${isRecording ? 'Press keys...' : formatShortcut(current)}
            </span>
            ${isCustom ? `<span class="shortcut-reset-btn" data-id="${id}" title="Reset to default">✕</span>` : ''}
          </span>
        `;
        row.querySelector('.shortcut-key').onclick = () => startRecording(id);
        if (isCustom) row.querySelector('.shortcut-reset-btn').onclick = (ev) => { ev.stopPropagation(); resetSingleShortcut(id); };

        // Wire up percentage input
        if (id === 'panel-set-width') {
          const pctInput = row.querySelector('#sc-panel-pct');
          pctInput.onclick = (ev) => ev.stopPropagation();
          pctInput.onchange = () => {
            let val = parseInt(pctInput.value) || 40;
            val = Math.max(10, Math.min(90, val));
            pctInput.value = val;
            settings.panelWidthPercent = val;
            localStorage.setItem('dterm-settings', JSON.stringify(settings));
            syncNow();
          };
        }

        list.appendChild(row);
      }
    }

    function startRecording(actionId) {
      shortcutRecorderActive = true;
      shortcutRecorderTarget = actionId;
      renderShortcutsList();
    }

    function captureShortcutCombo(e) {
      e.preventDefault();
      e.stopPropagation();

      // Ignore bare modifier presses
      if (['Meta', 'Control', 'Shift', 'Alt'].includes(e.key)) return;

      // Escape cancels recording
      if (e.key === 'Escape') {
        shortcutRecorderActive = false;
        shortcutRecorderTarget = null;
        renderShortcutsList();
        return;
      }

      const combo = {
        meta: e.metaKey || e.ctrlKey,
        shift: e.shiftKey,
        alt: e.altKey,
        key: e.key
      };

      // Check for conflicts
      const conflict = findShortcutConflict(combo, shortcutRecorderTarget);
      if (conflict) {
        const el = document.getElementById(`sc-key-${shortcutRecorderTarget}`);
        if (el) {
          el.textContent = `Conflicts with: ${DEFAULT_SHORTCUTS[conflict].label}`;
          el.classList.add('conflict');
          setTimeout(() => { el.classList.remove('conflict'); renderShortcutsList(); }, 1500);
        }
        shortcutRecorderActive = false;
        shortcutRecorderTarget = null;
        return;
      }

      // If same as default, remove override
      const def = DEFAULT_SHORTCUTS[shortcutRecorderTarget];
      if (combo.meta === def.meta && combo.shift === def.shift && combo.alt === def.alt && combo.key.toLowerCase() === def.key.toLowerCase()) {
        delete pendingShortcuts[shortcutRecorderTarget];
      } else {
        pendingShortcuts[shortcutRecorderTarget] = combo;
      }

      shortcutRecorderActive = false;
      shortcutRecorderTarget = null;

      // Auto-save when a shortcut is changed
      settings.shortcuts = Object.keys(pendingShortcuts).length > 0 ? { ...pendingShortcuts } : {};
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      syncNow();

      renderShortcutsList();
    }

    function findShortcutConflict(combo, excludeId) {
      for (const [id, def] of Object.entries(DEFAULT_SHORTCUTS)) {
        if (id === excludeId) continue;
        const current = pendingShortcuts[id] || def;
        if (current.meta === combo.meta && current.shift === combo.shift &&
            current.alt === combo.alt && current.key.toLowerCase() === combo.key.toLowerCase()) {
          return id;
        }
      }
      return null;
    }

    function resetSingleShortcut(actionId) {
      delete pendingShortcuts[actionId];
      settings.shortcuts = Object.keys(pendingShortcuts).length > 0 ? { ...pendingShortcuts } : {};
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      syncNow();
      renderShortcutsList();
    }

    function resetShortcutsToDefaults() {
      pendingShortcuts = {};
      settings.shortcuts = {};
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      syncNow();
      renderShortcutsList();
    }

    function showAbout() {
      document.getElementById('about-overlay').style.display = 'flex';
    }

    function closeAbout() {
      document.getElementById('about-overlay').style.display = 'none';
    }

    // ==========================================
    // USER GUIDE (fetched from server)
    // ==========================================
    let guideLoaded = false;
    let guideHtml = '';

    async function showGuide() {
      const overlay = document.getElementById('guide-overlay');
      overlay.style.display = 'flex';
      if (!guideLoaded) {
        const body = document.getElementById('guide-body');
        body.innerHTML = '<p style="text-align:center;color:#8b949e;padding:40px;">Loading guide...</p>';
        document.getElementById('guide-toc').innerHTML = '';
        try {
          const result = await api.cloud.getGuide();
          if (result.guide_content) {
            guideHtml = result.guide_content;
          }
        } catch (e) {}
        if (guideHtml) {
          body.innerHTML = guideHtml;
        } else {
          body.innerHTML = '<p style="text-align:center;color:#8b949e;padding:40px;">No guide content available. Ask your admin to add content at /dterm/admin/guide.php</p>';
        }
        // Build TOC from h1/h2 headings
        const headings = body.querySelectorAll('h1, h2');
        const tocLinks = [];
        headings.forEach((h, i) => {
          const id = 'guide-heading-' + i;
          h.id = id;
          h.style.scrollMarginTop = '10px';
          tocLinks.push('<a href="#" onclick="document.getElementById(\'' + id + '\').scrollIntoView({behavior:\'smooth\'});return false;">' + h.textContent + '</a>');
        });
        document.getElementById('guide-toc').innerHTML = tocLinks.join('');
        guideLoaded = true;
      }
      document.getElementById('guide-search').value = '';
      filterGuide('');
    }

    function closeGuide() {
      document.getElementById('guide-overlay').style.display = 'none';
    }

    function filterGuide(query) {
      const q = query.toLowerCase().trim();
      const body = document.getElementById('guide-body');
      const allEls = body.children;
      for (let i = 0; i < allEls.length; i++) {
        const el = allEls[i];
        if (!q) { el.style.display = ''; continue; }
        // Show/hide based on text content of nearby elements
        const text = el.textContent.toLowerCase();
        el.style.display = text.includes(q) ? '' : 'none';
      }
    }

    function toggleMenu() {
      const dd = document.getElementById('menu-dropdown');
      dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    }

    function closeMenu() {
      document.getElementById('menu-dropdown').style.display = 'none';
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const wrapper = document.getElementById('menu-dropdown-wrapper');
      if (wrapper && !wrapper.contains(e.target)) closeMenu();
    });

    // Windows UI initialization
    function initPlatformUI() {
      // Shell selector options
      const shellSelect = document.getElementById('setting-shell');
      shellSelect.innerHTML = '<option value="powershell.exe">PowerShell</option><option value="cmd.exe">CMD</option>';

      // Terminal profile buttons
      const profiles = document.getElementById('term-profiles');
      profiles.insertAdjacentHTML('afterbegin',
        '<button class="term-profile-btn" onclick="createTerminal(\'powershell.exe\')" title="PowerShell">ps</button>' +
        '<button class="term-profile-btn" onclick="createTerminal(\'cmd.exe\')" title="CMD">cmd</button>' +
        '<button class="term-profile-btn" onclick="createTerminal(\'node\')" title="Node">node</button>' +
        '<button class="term-profile-btn" onclick="createTerminal(\'python\')" title="Python">py</button>'
      );

      // Titlebar padding
      const titleBar = document.getElementById('title-bar');
      if (titleBar) titleBar.style.paddingLeft = '14px';
    }

    // Initialize
    async function init() {
      // Platform-aware setup
      initPlatformUI();
      loadSettings();
      loadBookmarks();
      currentPath = await window.api.fs.getHome();
      setupResizer();
      setupPanelResizers();
      setupTerminalDropZone();
      setupFileManagerDropZone();
      // Default to files tab
      setupPanelDragDrop();
      // Restore previous session (terminals, editor files, browser URL, etc.)
      await restoreSession();
      // If no terminals were restored, create a default one
      if (!terminals || terminals.length === 0) {
        createTerminal();
      }
      // Defer terminal fit to ensure layout has settled at full height
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          terminals.forEach(t => t.fitAddon.fit());
        });
      });
    }

    // Recent files/folders
    let recentFolders = JSON.parse(localStorage.getItem('dterm-recent-folders') || '[]');
    let recentFiles = JSON.parse(localStorage.getItem('dterm-recent-files') || '[]');
    const MAX_RECENT = 10;

    function addRecentFolder(path) {
      recentFolders = recentFolders.filter(p => p !== path);
      recentFolders.unshift(path);
      if (recentFolders.length > MAX_RECENT) recentFolders.pop();
      localStorage.setItem('dterm-recent-folders', JSON.stringify(recentFolders));
      syncNow();
    }

    function addRecentFile(path) {
      recentFiles = recentFiles.filter(p => p !== path);
      recentFiles.unshift(path);
      if (recentFiles.length > MAX_RECENT) recentFiles.pop();
      localStorage.setItem('dterm-recent-files', JSON.stringify(recentFiles));
      syncNow();
    }

    function showRecentMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById('recent-menu');
      menu.innerHTML = '';

      if (recentFolders.length === 0 && recentFiles.length === 0) {
        menu.innerHTML = '<div class="recent-item" style="color:#666">No recent items</div>';
      } else {
        if (recentFolders.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Folders</div>';
          recentFolders.forEach(path => {
            const name = path.split('/').pop() || path;
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = '📁 ' + name;
            item.title = path;
            item.onclick = () => { currentPath = path; loadFiles(); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        if (recentFiles.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Files</div>';
          recentFiles.forEach(path => {
            const name = path.split('/').pop();
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = '📄 ' + name;
            item.title = path;
            item.onclick = () => { openFileInEditor(path); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        const clear = document.createElement('div');
        clear.className = 'recent-clear';
        clear.textContent = 'Clear Recent';
        clear.onclick = () => {
          recentFolders = [];
          recentFiles = [];
          localStorage.removeItem('dterm-recent-folders');
          localStorage.removeItem('dterm-recent-files');
          hideRecentMenu();
        };
        menu.appendChild(clear);
      }

      menu.classList.add('visible');
    }

    function hideRecentMenu() {
      document.getElementById('recent-menu').classList.remove('visible');
    }

    document.addEventListener('click', hideRecentMenu);

    // Bookmarks
    let bookmarks = JSON.parse(localStorage.getItem('dterm-bookmarks') || '[]');

    function loadBookmarks() {
      const bar = document.getElementById('bookmarks-bar');
      bar.innerHTML = '';
      // Folder bookmarks
      bookmarks.forEach((path, i) => {
        const name = path.split('/').pop() || path;
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        item.innerHTML = `<span>📁 ${name}</span><span class="remove-bookmark" onclick="removeBookmark(${i}, event)">✕</span>`;
        item.onclick = () => goToBookmark(path);
        item.title = path;
        bar.appendChild(item);
      });
      // File bookmarks (pinned files)
      const fileBookmarks = JSON.parse(localStorage.getItem('dterm-file-bookmarks') || '[]');
      fileBookmarks.forEach((path, i) => {
        const name = path.split('/').pop() || path;
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        item.innerHTML = `<span>📄 ${name}</span><span class="remove-bookmark" onclick="removeFileBookmark(${i}, event)">✕</span>`;
        item.onclick = () => openFileByPath(path);
        item.title = path;
        bar.appendChild(item);
      });
      updateBookmarkButton();
    }

    function toggleBookmark() {
      const index = bookmarks.indexOf(currentPath);
      if (index >= 0) {
        bookmarks.splice(index, 1);
      } else {
        bookmarks.push(currentPath);
      }
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
      syncNow();
    }

    function removeBookmark(index, e) {
      e.stopPropagation();
      bookmarks.splice(index, 1);
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
      syncNow();
    }

    function goToBookmark(path) {
      currentPath = path;
      loadFiles();
    }

    function updateBookmarkButton() {
      const btn = document.querySelector('#fm-path button');
      if (btn) {
        btn.textContent = bookmarks.includes(currentPath) ? '★' : '☆';
        btn.style.color = bookmarks.includes(currentPath) ? '#f90' : '#666';
      }
    }

    // File Manager
    async function loadFiles() {
      if (appMode === 'ftp') {
        loadFtpFileBrowser();
        return;
      }
      if (!currentPath) {
        currentPath = await window.api.fs.getHome();
      }
      // Update file watcher to current directory
      if (watchedDir && watchedDir !== currentPath) {
        api.fs.unwatch(watchedDir);
      }
      if (currentPath !== watchedDir) {
        api.fs.watch(currentPath);
        watchedDir = currentPath;
      }
      renderBreadcrumb(currentPath);
      updateBookmarkButton();
      addRecentFolder(currentPath);
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';

      try {
        const files = await window.api.fs.readDir(currentPath);
        allFiles = files;

        let filtered = files;
        if (!showHidden) {
          filtered = files.filter(f => !f.name.startsWith('.'));
        }

        const searchTerm = document.getElementById('fm-search').value.toLowerCase();
        if (searchTerm) {
          filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
        }

        filtered.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        // Get git status
        const gitBranch = await window.api.git.getBranch(currentPath);
        const gitStatus = await window.api.git.getStatus(currentPath);

        // Update git branch display
        const branchEl = document.getElementById('git-branch');
        const branchNameEl = document.getElementById('git-branch-name');
        if (gitBranch) {
          branchNameEl.textContent = gitBranch;
          branchEl.classList.add('visible');
        } else {
          branchEl.classList.remove('visible');
        }

        filtered.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.draggable = true;
          if (clipboard.file && clipboard.file.path === file.path && clipboard.action === 'cut') {
            div.classList.add('cut');
          }

          // Check git status for this file
          let gitIndicator = '';
          if (gitStatus) {
            const relPath = file.name;
            const status = gitStatus[relPath] || gitStatus[relPath + '/'];
            if (status) {
              if (status.includes('M') || status.includes('m')) {
                div.classList.add('git-modified');
                gitIndicator = '<span class="git-indicator modified">M</span>';
              } else if (status.includes('A')) {
                div.classList.add('git-added');
                gitIndicator = '<span class="git-indicator added">A</span>';
              } else if (status.includes('?')) {
                div.classList.add('git-untracked');
                gitIndicator = '<span class="git-indicator untracked">?</span>';
              } else if (status.includes('D')) {
                div.classList.add('git-deleted');
                gitIndicator = '<span class="git-indicator modified">D</span>';
              }
            }
          }

          const sizeStr = file.isDirectory ? '' : formatSize(file.size);
          div.innerHTML = `
            <span>${file.isDirectory ? '📁' : '📄'}</span>
            <span class="file-name">${file.name}</span>
            ${gitIndicator}
            <span class="file-info">${sizeStr}</span>
          `;
          div.onclick = (e) => handleClick(file, e);
          div.ondblclick = () => handleDoubleClick(file);
          div.oncontextmenu = (e) => showContextMenu(e, file);
          div.ondragstart = (e) => handleDragStart(e, file);
          div.ondragend = (e) => handleDragEnd(e);

          // Image preview tooltip on hover
          if (!file.isDirectory && appMode === 'local') {
            const ext = file.name.split('.').pop().toLowerCase();
            if (imageExtensions.includes(ext)) {
              div.onmouseenter = (e) => showImageTooltip(e, file.path);
              div.onmouseleave = () => hideImageTooltip();
              div.onmousemove = (e) => {
                if (imgPreviewTooltip && imgPreviewTooltip.style.display === 'block') {
                  imgPreviewTooltip.style.left = (e.clientX + 12) + 'px';
                  imgPreviewTooltip.style.top = (e.clientY + 12) + 'px';
                }
              };
            }
          }

          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    function formatSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
      return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' GB';
    }

    function filterFiles() {
      loadFiles();
    }

    function toggleHidden() {
      showHidden = !showHidden;
      document.getElementById('hidden-toggle').classList.toggle('active', showHidden);
      loadFiles();
    }

    function handleClick(file, e) {
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
      e.currentTarget.classList.add('selected');
      selectedFile = file;
    }

    async function handleDoubleClick(file) {
      if (file.isDirectory) {
        currentPath = file.path;
        loadFiles();
      } else if (canPreview(file.name)) {
        showFilePreview(file);
      } else {
        addRecentFile(file.path);
        await openFileInEditor(file);
      }
    }

    // Drag and drop for terminal
    function handleDragStart(e, file) {
      e.dataTransfer.setData('text/plain', file.path);
      e.dataTransfer.setData('application/x-dterm-file', JSON.stringify(file));
      e.dataTransfer.effectAllowed = 'copy';
      e.currentTarget.classList.add('dragging');
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
    }

    function setupFileManagerDropZone() {
      const fileList = document.getElementById('file-list');

      fileList.addEventListener('dragover', (e) => {
        // Only handle external drops (from Finder), not internal dTerm drags
        if (e.dataTransfer.types.includes('application/x-dterm-file')) return;
        if (e.dataTransfer.types.includes('Files')) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          fileList.classList.add('drop-over');
        }
      });

      fileList.addEventListener('dragleave', (e) => {
        if (!fileList.contains(e.relatedTarget)) {
          fileList.classList.remove('drop-over');
        }
      });

      fileList.addEventListener('drop', async (e) => {
        fileList.classList.remove('drop-over');
        if (e.dataTransfer.types.includes('application/x-dterm-file')) return;
        if (!e.dataTransfer.files || e.dataTransfer.files.length === 0) return;
        e.preventDefault();

        const files = Array.from(e.dataTransfer.files);

        if (appMode === 'ftp') {
          // Upload each dropped file to current FTP directory
          for (const file of files) {
            const localPath = file.path;
            const fileName = file.name;
            const remotePath = currentPath === '/' ? '/' + fileName : currentPath + '/' + fileName;
            try {
              await window.api.ftp.uploadFromLocal(localPath, remotePath);
              document.getElementById('ftp-status').textContent = `Uploaded: ${fileName}`;
            } catch (err) {
              alert('Upload failed for ' + fileName + ': ' + err.message);
            }
          }
          loadFiles();
        } else {
          // Copy each dropped file to current local directory
          for (const file of files) {
            const srcPath = file.path;
            const fileName = file.name;
            const destPath = currentPath + '/' + fileName;
            if (srcPath === destPath) continue;
            try {
              await window.api.fs.copy(srcPath, destPath);
            } catch (err) {
              alert('Copy failed for ' + fileName + ': ' + err.message);
            }
          }
          loadFiles();
        }
      });
    }

    function setupTerminalDropZone() {
      const container = document.getElementById('terminal-container');

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        container.classList.add('drag-over');
      });

      container.addEventListener('dragleave', (e) => {
        container.classList.remove('drag-over');
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.classList.remove('drag-over');

        // Determine target terminal
        let activeTerminal;
        if (paneTree && paneTree.type === 'split') {
          const targetPane = e.target.closest('.pane-container');
          const targetId = targetPane ? targetPane.dataset.termId : activePaneId;
          activeTerminal = terminals.find(t => t.id === targetId);
        } else {
          activeTerminal = terminals.find(t =>
            document.getElementById(t.id).classList.contains('active')
          );
        }
        if (!activeTerminal) return;

        // Handle internal dTerm drag (text/plain path)
        const filePath = e.dataTransfer.getData('text/plain');
        if (filePath) {
          const escapedPath = escapePathForShell(filePath);
          activeTerminal.term.paste(escapedPath);
          activeTerminal.term.focus();
          return;
        }

        // Handle external file drops (from Finder)
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          const paths = Array.from(e.dataTransfer.files).map(f => escapePathForShell(f.path));
          activeTerminal.term.paste(paths.join(' '));
          activeTerminal.term.focus();
        }
      });
    }

    function escapePathForShell(path) {
      // Escape special characters for shell: spaces, quotes, parentheses, etc.
      return path.replace(/([ '"\\()&;|<>$`!#*?[\]{}])/g, '\\$1');
    }

    // Clipboard operations
    function copyFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'copy' };
        loadFiles();
      }
    }

    function cutFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'cut' };
        loadFiles();
      }
    }

    async function pasteFile() {
      hideContextMenu();
      if (!clipboard.file) return;

      const destPath = currentPath + '/' + clipboard.file.name;
      try {
        if (clipboard.action === 'copy') {
          await window.api.fs.copy(clipboard.file.path, destPath);
        } else {
          await window.api.fs.rename(clipboard.file.path, destPath);
          clipboard = { file: null, action: null };
        }
        loadFiles();
      } catch (err) {
        alert('Could not paste: ' + err.message);
      }
    }

    // Editor with Monaco
    async function openFileInEditor(file) {
      if (appMode === 'ftp' || file.ftpFile) {
        return openFtpFile(file);
      }
      const existingIndex = openFiles.findIndex(f => f.path === file.path);
      if (existingIndex !== -1) {
        activateFile(existingIndex);
        return;
      }

      try {
        const content = await window.api.fs.readFile(file.path);
        openFiles.push({
          path: file.path,
          name: file.name,
          content: content,
          modified: false
        });
        activeFileIndex = openFiles.length - 1;
        updateEditorTabs();
        showEditor();
        setEditorContent(content, file.name);
        updateStatusBar();
      } catch (err) {
        alert('Could not open file: ' + err.message);
      }
    }

    function setEditorContent(content, filename) {
      const container = document.getElementById('editor-container');

      if (!monacoReady) {
        // Fallback to textarea if Monaco not loaded
        container.innerHTML = `<textarea id="editor-fallback" style="width:100%;height:100%;background:#0d1117;color:#d1d5db;border:none;outline:none;resize:none;font-family:Menlo,Monaco,monospace;font-size:13px;padding:10px;">${content}</textarea>`;
        return;
      }

      if (monacoEditor) {
        monacoEditor.dispose();
      }
      if (diffEditor) { diffEditor.dispose(); diffEditor = null; diffViewActive = false; }

      const language = getLanguage(filename);
      monacoEditor = monaco.editor.create(container, {
        value: content,
        language: language,
        theme: settings.theme === 'light' ? 'vs' : 'vs-dark',
        fontSize: settings.fontSize,
        minimap: { enabled: settings.minimap },
        automaticLayout: true,
        scrollBeyondLastLine: false,
        wordWrap: 'on'
      });

      monacoEditor.onDidChangeModelContent(() => {
        if (collabIgnoreNextChange) return;
        if (activeFileIndex >= 0) {
          openFiles[activeFileIndex].modified = true;
          openFiles[activeFileIndex].content = monacoEditor.getValue();
          updateEditorTabs();
          // Live markdown preview update
          if (mdPreviewActive) {
            clearTimeout(window._mdPreviewTimer);
            window._mdPreviewTimer = setTimeout(updateMdPreview, 300);
          }
        }
        // Push collab changes immediately (debounced 150ms)
        if (collabState) {
          collabPushPending = true;
          collabSchedulePush();
        }
      });

      monacoEditor.onDidChangeCursorPosition((e) => {
        const pos = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
        document.getElementById('status-line').textContent = pos;
        const sbCursor = document.getElementById('sb-cursor');
        if (sbCursor) sbCursor.textContent = pos;
      });
    }

    function getLanguage(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const langMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'py': 'python',
        'rb': 'ruby',
        'java': 'java',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'c',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'php': 'php',
        'html': 'html',
        'htm': 'html',
        'css': 'css',
        'scss': 'scss',
        'less': 'less',
        'json': 'json',
        'xml': 'xml',
        'yaml': 'yaml',
        'yml': 'yaml',
        'md': 'markdown',
        'sql': 'sql',
        'sh': 'shell',
        'bash': 'shell',
        'zsh': 'shell',
        'ps1': 'powershell',
        'swift': 'swift',
        'kt': 'kotlin',
        'r': 'r',
        'lua': 'lua',
        'pl': 'perl',
        'dockerfile': 'dockerfile'
      };
      return langMap[ext] || 'plaintext';
    }

    function updateEditorTabs() {
      const tabsContainer = document.getElementById('editor-tabs');
      tabsContainer.innerHTML = '';

      openFiles.forEach((file, index) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (index === activeFileIndex ? ' active' : '') + (file.modified ? ' modified' : '');
        tab.innerHTML = `${getFileIcon(file.name)}<span>${file.name}</span><span class="tab-close" onclick="closeEditorTab(${index}, event)">✕</span>`;
        tab.onclick = () => activateFile(index);
        tabsContainer.appendChild(tab);
      });

      // Add markdown preview toggle if active file is .md
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        const ext = openFiles[activeFileIndex].name.split('.').pop().toLowerCase();
        if (ext === 'md' || ext === 'markdown') {
          const toggle = document.createElement('button');
          toggle.id = 'md-preview-toggle';
          toggle.textContent = mdPreviewActive ? '◀ Editor' : 'Preview ▶';
          if (mdPreviewActive) toggle.classList.add('active');
          toggle.onclick = () => toggleMdPreview();
          tabsContainer.appendChild(toggle);
        } else if (mdPreviewActive) {
          // Turn off preview if switched away from .md file
          mdPreviewActive = false;
          document.getElementById('md-preview-container').classList.remove('visible');
          document.getElementById('editor-container').style.display = '';
        }
      }

      // Add diff toggle when a file is open
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        const diffToggle = document.createElement('button');
        diffToggle.id = 'diff-toggle';
        diffToggle.textContent = diffViewActive ? '◀ Editor' : 'Diff ▶';
        if (diffViewActive) diffToggle.classList.add('active');
        if (!openFiles[activeFileIndex].modified) {
          diffToggle.style.opacity = '0.4';
          diffToggle.style.cursor = 'default';
        }
        if (!tabsContainer.querySelector('#md-preview-toggle')) {
          diffToggle.style.marginLeft = 'auto';
        }
        diffToggle.onclick = () => {
          if (openFiles[activeFileIndex] && openFiles[activeFileIndex].modified) toggleDiffView();
        };
        tabsContainer.appendChild(diffToggle);
      }
      if (!openFiles[activeFileIndex]?.modified && diffViewActive) {
        closeDiffViewSilent();
      }

      updateStatusBar();
    }

    function activateFile(index) {
      // Close diff view if active
      if (diffViewActive) {
        if (diffEditor) {
          openFiles[activeFileIndex].content = diffEditor.getModifiedEditor().getValue();
          diffEditor.dispose();
          diffEditor = null;
        }
        diffViewActive = false;
        document.getElementById('editor-container').innerHTML = '';
      }

      if (activeFileIndex >= 0 && openFiles[activeFileIndex] && monacoEditor) {
        openFiles[activeFileIndex].content = monacoEditor.getValue();
      }

      activeFileIndex = index;
      setEditorContent(openFiles[index].content, openFiles[index].name);
      updateEditorTabs();
      updateStatusBar();
    }

    function closeEditorTab(index, e) {
      e.stopPropagation();

      // Clean up diff view if closing the active diff tab
      if (index === activeFileIndex && diffViewActive) {
        diffViewActive = false;
        if (diffEditor) { diffEditor.dispose(); diffEditor = null; }
      }

      if (openFiles[index].modified) {
        if (!confirm(`Save changes to ${openFiles[index].name}?`)) {
          // Don't save
        } else {
          saveCurrentFile();
        }
      }

      openFiles.splice(index, 1);

      if (openFiles.length === 0) {
        activeFileIndex = -1;
        hideEditor();
        if (monacoEditor) {
          monacoEditor.dispose();
          monacoEditor = null;
        }
      } else {
        activeFileIndex = Math.min(index, openFiles.length - 1);
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }
      updateEditorTabs();
      updateStatusBar();
    }

    function showEditor() {
      document.getElementById('editor-area').classList.add('visible');
      document.getElementById('terminal-area').classList.add('with-editor');
      document.getElementById('resizer').style.display = 'block';
      terminals.forEach(t => t.fitAddon.fit());
    }

    function hideEditor() {
      document.getElementById('editor-area').classList.remove('visible');
      document.getElementById('terminal-area').classList.remove('with-editor');
      document.getElementById('resizer').style.display = 'none';
      terminals.forEach(t => t.fitAddon.fit());
    }

    async function saveCurrentFile() {
      if (activeFileIndex < 0) return;
      const file = openFiles[activeFileIndex];
      if (diffViewActive && diffEditor) {
        file.content = diffEditor.getModifiedEditor().getValue();
      } else if (monacoEditor) {
        file.content = monacoEditor.getValue();
      }
      if (file.ftpFile || appMode === 'ftp') {
        await window.api.ftp.writeFile(file.path, file.content);
      } else {
        await window.api.fs.writeFile(file.path, file.content);
      }
      file.modified = false;
      // Close diff view after save — nothing to diff anymore
      if (diffViewActive) {
        closeDiffViewSilent();
      }
      updateEditorTabs();
    }

    function updateStatusBar() {
      if (activeFileIndex >= 0) {
        const file = openFiles[activeFileIndex];
        const prefix = file.ftpFile ? 'FTP: ' : '';
        document.getElementById('status-file').textContent = prefix + file.path;
      } else {
        document.getElementById('status-file').textContent = 'No file open';
        document.getElementById('status-line').textContent = '';
      }
    }

    // Resizers
    function setupResizer() {
      const resizer = document.getElementById('resizer');
      const editorArea = document.getElementById('editor-area');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ns-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const mainArea = document.getElementById('main-area');
        const rect = mainArea.getBoundingClientRect();
        const editorHeight = e.clientY - rect.top;
        const minHeight = 100;
        const maxHeight = rect.height - 150;

        if (editorHeight > minHeight && editorHeight < maxHeight) {
          editorArea.style.flex = 'none';
          editorArea.style.height = editorHeight + 'px';
          terminals.forEach(t => t.fitAddon.fit());
        }
      });

      document.addEventListener('mouseup', () => {
        isResizing = false;
        document.body.style.cursor = '';
      });
    }

    // Panel collapse/expand toggles
    let leftPanelWidth = null;
    // rightPanelWidth removed — single sidebar layout

    function toggleLeftPanel() {
      const panel = document.getElementById('left-panel');
      const resizer = document.getElementById('left-resizer');
      const isCollapsed = panel.classList.contains('collapsed');

      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.width = (leftPanelWidth || 500) + 'px';
        resizer.style.display = '';
      } else {
        leftPanelWidth = panel.offsetWidth;
        panel.classList.add('collapsed');
        resizer.style.display = 'none';
      }
      updateToggleIcons();
      setTimeout(() => terminals.forEach(t => t.fitAddon.fit()), 250);
    }

    // Right panel removed — toggleRightPanel kept as no-op for compat
    function toggleRightPanel() { toggleLeftPanel(); }

    let swapSavedWidth = null;

    function swapPanelSizes() {
      const leftPanel = document.getElementById('left-panel');
      const appContainer = document.getElementById('app-container');
      if (leftPanel.classList.contains('collapsed')) return;

      const totalW = appContainer.offsetWidth;

      if (swapSavedWidth) {
        // Restore original size
        leftPanel.style.width = swapSavedWidth + 'px';
        leftPanelWidth = swapSavedWidth;
        swapSavedWidth = null;
      } else {
        // Save current width, then expand to 75% of total
        swapSavedWidth = leftPanel.offsetWidth;
        const expandedW = Math.round(totalW * 0.75);
        leftPanel.style.width = expandedW + 'px';
        leftPanelWidth = expandedW;
      }

      setTimeout(() => {
        terminals.forEach(t => t.fitAddon.fit());
        if (monacoEditor) monacoEditor.layout();
      }, 250);
    }

    function updateToggleIcons() {
      const leftPanel = document.getElementById('left-panel');
      const leftToggle = document.getElementById('left-toggle');
      if (!leftToggle) return;
      const leftCollapsed = leftPanel.classList.contains('collapsed');
      leftToggle.querySelector('.toggle-icon').textContent = leftCollapsed ? '▶' : '◀';
    }

    function toggleFocusMode() {
      toggleLeftPanel();
    }

    // Panel drag-drop removed — single sidebar layout
    function setupPanelDragDrop() { /* no-op */ }

    function setupPanelResizers() {
      const ghost = document.getElementById('resize-ghost');
      const leftResizer = document.getElementById('left-resizer');
      const leftPanel = document.getElementById('left-panel');
      let leftResizing = false;
      let leftTargetWidth = 0;

      function disableWebviewPointerEvents() {
        document.querySelectorAll('webview, iframe').forEach(el => { el.style.pointerEvents = 'none'; });
      }
      function enableWebviewPointerEvents() {
        document.querySelectorAll('webview, iframe').forEach(el => { el.style.pointerEvents = ''; });
      }

      leftResizer.addEventListener('mousedown', () => {
        leftResizing = true;
        leftTargetWidth = 0;
        document.body.style.cursor = 'ew-resize';
        ghost.classList.add('visible');
        disableWebviewPointerEvents();
      });

      document.addEventListener('mousemove', (e) => {
        if (leftResizing) {
          const width = e.clientX;
          if (width >= 200 && width <= 600) {
            leftTargetWidth = width;
            ghost.style.left = e.clientX + 'px';
          }
        }
      });

      document.addEventListener('mouseup', () => {
        if (leftResizing && leftTargetWidth) {
          leftPanel.style.width = leftTargetWidth + 'px';
          terminals.forEach(t => t.fitAddon.fit());
        }
        leftResizing = false;
        ghost.classList.remove('visible');
        document.body.style.cursor = '';
        enableWebviewPointerEvents();
      });
    }

    async function goHome() {
      if (appMode === 'ftp') {
        currentPath = '/';
        loadFiles();
      } else {
        currentPath = await window.api.fs.getHome();
        loadFiles();
      }
    }

    // Mini Browser — Tabbed Browsing
    let browserTabs = [];
    let activeBrowserTabId = null;
    let browserTabCounter = 0;

    function getActiveWebview() {
      const tab = browserTabs.find(t => t.id === activeBrowserTabId);
      return tab ? tab.webview : null;
    }

    function createBrowserTab(url) {
      const id = ++browserTabCounter;
      const homeUrl = url || settings.browserHome || 'https://duckduckgo.com';

      const webview = document.createElement('webview');
      webview.setAttribute('allowpopups', '');
      webview.className = 'browser-webview';
      webview.src = homeUrl;
      document.getElementById('mini-browser-content').appendChild(webview);

      const loadingEl = document.getElementById('mini-browser-loading');

      webview.addEventListener('did-start-loading', () => {
        if (activeBrowserTabId === id) loadingEl.classList.add('visible');
      });
      webview.addEventListener('did-stop-loading', () => {
        if (activeBrowserTabId === id) loadingEl.classList.remove('visible');
      });
      webview.addEventListener('did-navigate', (e) => {
        const tab = browserTabs.find(t => t.id === id);
        if (tab) tab.url = e.url;
        if (activeBrowserTabId === id) {
          document.getElementById('mini-browser-url').value = e.url;
        }
      });
      webview.addEventListener('did-navigate-in-page', (e) => {
        const tab = browserTabs.find(t => t.id === id);
        if (tab) tab.url = e.url;
        if (activeBrowserTabId === id) {
          document.getElementById('mini-browser-url').value = e.url;
        }
      });
      webview.addEventListener('page-title-updated', (e) => {
        const tab = browserTabs.find(t => t.id === id);
        if (tab) {
          tab.title = e.title;
          renderBrowserTabs();
        }
      });

      browserTabs.push({ id, webview, title: 'New Tab', url: homeUrl });
      switchBrowserTab(id);
      return id;
    }

    function switchBrowserTab(id) {
      activeBrowserTabId = id;
      browserTabs.forEach(t => {
        t.webview.classList.toggle('active', t.id === id);
      });
      const tab = browserTabs.find(t => t.id === id);
      if (tab) {
        document.getElementById('mini-browser-url').value = tab.url || '';
      }
      renderBrowserTabs();
    }

    function closeBrowserTab(id, e) {
      if (e) { e.stopPropagation(); }
      const idx = browserTabs.findIndex(t => t.id === id);
      if (idx === -1) return;

      const tab = browserTabs[idx];
      tab.webview.remove();
      browserTabs.splice(idx, 1);

      if (browserTabs.length === 0) {
        createBrowserTab();
        return;
      }

      if (activeBrowserTabId === id) {
        const newIdx = Math.min(idx, browserTabs.length - 1);
        switchBrowserTab(browserTabs[newIdx].id);
      } else {
        renderBrowserTabs();
      }
    }

    function renderBrowserTabs() {
      const bar = document.getElementById('browser-tab-bar');
      const addBtn = document.getElementById('browser-new-tab');
      // Remove all tab elements but keep the + button
      bar.querySelectorAll('.browser-tab').forEach(el => el.remove());

      browserTabs.forEach(t => {
        const el = document.createElement('div');
        el.className = 'browser-tab' + (t.id === activeBrowserTabId ? ' active' : '');
        el.onclick = () => switchBrowserTab(t.id);
        el.innerHTML = '<span class="browser-tab-title">' + (t.title || 'New Tab').replace(/</g, '&lt;') + '</span><span class="tab-close" onclick="closeBrowserTab(' + t.id + ', event)">&times;</span>';
        bar.insertBefore(el, addBtn);
      });
    }

    function miniBrowserGo() {
      const webview = getActiveWebview();
      if (!webview) return;
      let url = document.getElementById('mini-browser-url').value.trim();
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      webview.src = url;
    }

    function miniBrowserBack() {
      const webview = getActiveWebview();
      if (webview && webview.canGoBack()) webview.goBack();
    }

    function miniBrowserForward() {
      const webview = getActiveWebview();
      if (webview && webview.canGoForward()) webview.goForward();
    }

    function miniBrowserRefresh() {
      const webview = getActiveWebview();
      if (webview) webview.reload();
    }

    function miniBrowserHome() {
      const webview = getActiveWebview();
      if (!webview) return;
      webview.src = settings.browserHome;
      document.getElementById('mini-browser-url').value = settings.browserHome;
    }

    const devicePresets = {
      desktop: { width: '100%', userAgent: null, label: '100%' },
      tablet: { width: '768px', userAgent: 'Mozilla/5.0 (iPad; CPU OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1', label: '768px' },
      mobile: { width: '375px', userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1', label: '375px' }
    };

    function setBrowserDevice(device) {
      const webview = getActiveWebview();
      const preset = devicePresets[device];
      if (!webview || !preset) return;

      document.querySelectorAll('.device-tab').forEach(el => el.classList.remove('active'));
      const btn = document.querySelector(`.device-tab[data-device="${device}"]`);
      if (btn) btn.classList.add('active');

      document.getElementById('browser-viewport-label').textContent = preset.label;

      if (preset.width === '100%') {
        webview.style.width = '100%';
        webview.style.maxWidth = '';
        webview.style.margin = '';
      } else {
        webview.style.width = preset.width;
        webview.style.maxWidth = preset.width;
        webview.style.margin = '0 auto';
      }

      if (preset.userAgent) {
        webview.setUserAgent(preset.userAgent);
      } else {
        webview.setUserAgent('');
      }

      webview.reload();
    }

    // Initialize browser with one tab — deferred to session restore
    (async function() {
      try {
        const session = await window.api.session.load();
        if (session && session.browserTabs && session.browserTabs.length > 0) {
          session.browserTabs.forEach((bt, i) => {
            createBrowserTab(bt.url || settings.browserHome);
          });
          // Restore active tab
          const activeIdx = session.activeBrowserTabIndex || 0;
          if (browserTabs[activeIdx]) switchBrowserTab(browserTabs[activeIdx].id);
        } else if (session && session.browserUrl && session.browserUrl !== 'about:blank') {
          // Legacy single-tab session
          createBrowserTab(session.browserUrl);
        } else {
          createBrowserTab();
        }
      } catch (e) {
        createBrowserTab();
      }
    })();

    function goUp() {
      const parent = currentPath.split('/').slice(0, -1).join('/') || '/';
      currentPath = parent;
      loadFiles();
    }

    async function openFolder() {
      const path = await window.api.dialog.openFolder();
      if (path) {
        currentPath = path;
        loadFiles();
      }
    }

    function refresh() {
      loadFiles();
    }

    function showContextMenu(e, file) {
      e.preventDefault();
      selectedFile = file;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      // Show/hide FTP-specific options
      document.getElementById('ctx-download').style.display = appMode === 'ftp' && !file.isDirectory ? 'block' : 'none';
      document.getElementById('ctx-upload').style.display = appMode === 'ftp' ? 'block' : 'none';
    }

    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
      document.getElementById('terminal-context-menu').style.display = 'none';
    }

    // Terminal context menu
    let activeTerminalForMenu = null;

    function showTerminalContextMenu(e, termId) {
      hideContextMenu();
      activeTerminalForMenu = termId;
      const menu = document.getElementById('terminal-context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
    }

    function terminalCopy() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData && termData.term.hasSelection()) {
        navigator.clipboard.writeText(termData.term.getSelection());
      }
    }

    function terminalPaste() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        navigator.clipboard.readText().then(text => {
          termData.term.paste(text);
        });
      }
    }

    function terminalSelectAll() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.selectAll();
      }
    }

    function terminalClear() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.clear();
      }
    }

    function splitFromMenu(direction) {
      hideContextMenu();
      if (activeTerminalForMenu) {
        activePaneId = activeTerminalForMenu;
      }
      splitTerminal(direction);
    }

    // Command Palette
    const commands = [
      { name: 'New Terminal', icon: '💻', action: () => createTerminal(), scId: 'new-terminal' },
      { name: 'New File', icon: '📄', action: () => newFile() },
      { name: 'New Folder', icon: '📁', action: () => newFolder() },
      { name: 'Open Folder', icon: '📂', action: () => openFolder() },
      { name: 'Save File', icon: '💾', action: () => saveCurrentFile(), scId: 'save-file' },
      { name: 'Toggle Sidebar', icon: '◀', action: () => toggleLeftPanel(), scId: 'toggle-sidebar' },
      { name: 'Swap Panel Sizes', icon: '⇄', action: () => swapPanelSizes(), scId: 'swap-panels' },
      { name: 'Focus Mode', icon: '⊞', action: () => toggleFocusMode(), scId: 'focus-mode' },
      { name: 'Split Terminal Vertical', icon: '▏', action: () => splitTerminal('vertical'), scId: 'split-vertical' },
      { name: 'Split Terminal Horizontal', icon: '▁', action: () => splitTerminal('horizontal'), scId: 'split-horizontal' },
      { name: 'Settings', icon: '⚙', action: () => showSettings(), scId: 'settings' },
      { name: 'Keyboard Shortcuts', icon: '⌨', action: () => showShortcuts(), scId: 'shortcuts' },
      { name: 'User Guide', icon: '📖', action: () => showGuide() },
      { name: 'Search in Terminal', icon: '🔍', action: () => openTerminalSearch(), scId: 'terminal-search' },
      { name: 'Clear Terminal', icon: '🧹', action: () => { const t = getActiveTerminalData(); if(t) t.term.clear(); } },
      { name: 'Go Home', icon: '🏠', action: () => goHome() },
      { name: 'Refresh Files', icon: '🔄', action: () => refresh() },
      { name: 'Toggle Hidden Files', icon: '👁', action: () => toggleHidden() },
      { name: 'Notes', icon: '📝', action: () => showLeftTab('notes') },
      { name: 'Tools', icon: '🔧', action: () => showLeftTab('tools') },
      { name: 'AI Chat', icon: '🤖', action: () => showLeftTab('ai') },
      { name: 'FTP', icon: '🌐', action: () => showLeftTab('ftp') },
      { name: 'Run Current File', icon: '▶', action: () => runCurrentFile(), scId: 'run-file' },
      { name: 'Code Runner', icon: '▶', action: () => showLeftTab('runner') },
      { name: 'Compare Files', icon: '⇔', action: () => compareCurrentFile() },
      { name: 'Snippets', icon: '📋', action: () => showLeftTab('snippets') },
      { name: 'Processes', icon: '⊞', action: () => showLeftTab('processes') },
      { name: 'SSH Connection', icon: '🔗', action: () => showSshDialog() },
      { name: 'Save Workspace', icon: '💾', action: () => saveWorkspace() },
      { name: 'Load Workspace', icon: '📂', action: () => loadWorkspace() },
      { name: 'Delete Workspace', icon: '🗑', action: () => deleteWorkspace() },
      { name: 'Open Left Panel to %', icon: '◀', action: () => SHORTCUT_ACTIONS['panel-set-width'](), scId: 'panel-set-width' },
      { name: 'Close Left Panel', icon: '✕', action: () => SHORTCUT_ACTIONS['panel-close'](), scId: 'panel-close' },
    ];

    let selectedCommandIndex = 0;
    let filteredCommands = [...commands];



    function showCommandPalette() {
      document.getElementById('command-palette').classList.add('visible');
      document.getElementById('command-palette-input').value = '';
      document.getElementById('command-palette-input').focus();
      selectedCommandIndex = 0;
      filteredCommands = [...commands];
      renderCommands();
    }

    function hideCommandPalette() {
      document.getElementById('command-palette').classList.remove('visible');
    }

    function filterCommands() {
      const query = document.getElementById('command-palette-input').value.toLowerCase();
      filteredCommands = commands.filter(c => c.name.toLowerCase().includes(query));
      selectedCommandIndex = 0;
      renderCommands();
    }

    function renderCommands() {
      const list = document.getElementById('command-palette-list');
      list.innerHTML = '';
      const shortcuts = getShortcuts();
      filteredCommands.forEach((cmd, i) => {
        const div = document.createElement('div');
        div.className = 'command-item' + (i === selectedCommandIndex ? ' selected' : '');
        const scDisplay = cmd.scId && shortcuts[cmd.scId] ? formatShortcut(shortcuts[cmd.scId]) : '';
        div.innerHTML = `
          <span class="command-icon">${cmd.icon}</span>
          <span class="command-name">${cmd.name}</span>
          ${scDisplay ? `<span class="command-shortcut">${scDisplay}</span>` : ''}
        `;
        div.onclick = () => executeCommand(i);
        div.onmouseenter = () => {
          selectedCommandIndex = i;
          renderCommands();
        };
        list.appendChild(div);
      });
    }

    function executeCommand(index) {
      const cmd = filteredCommands[index];
      if (cmd) {
        hideCommandPalette();
        cmd.action();
      }
    }

    function handleCommandKey(e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommands();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommands();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeCommand(selectedCommandIndex);
      } else if (e.key === 'Escape') {
        hideCommandPalette();
      }
    }

    // File Preview
    const previewableExtensions = {
      image: ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'],
      video: ['mp4', 'webm', 'mov', 'avi'],
      audio: ['mp3', 'wav', 'ogg', 'flac', 'm4a']
    };

    function canPreview(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return previewableExtensions.image.includes(ext) ||
             previewableExtensions.video.includes(ext) ||
             previewableExtensions.audio.includes(ext);
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (previewableExtensions.image.includes(ext)) return 'image';
      if (previewableExtensions.video.includes(ext)) return 'video';
      if (previewableExtensions.audio.includes(ext)) return 'audio';
      return null;
    }

    function showFilePreview(file) {
      const container = document.getElementById('file-preview-container');
      const type = getFileType(file.name);
      const fileUrl = 'file://' + file.path;

      if (type === 'image') {
        container.innerHTML = `<img src="${fileUrl}" alt="${file.name}"><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'video') {
        container.innerHTML = `<video src="${fileUrl}" controls autoplay><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'audio') {
        container.innerHTML = `<div style="padding:40px;text-align:center;"><div style="font-size:48px;margin-bottom:20px;">🎵</div><audio src="${fileUrl}" controls autoplay></audio><div id="file-preview-name">${file.name}</div></div>`;
      }

      document.getElementById('file-preview-overlay').classList.add('visible');
    }

    function closeFilePreview() {
      document.getElementById('file-preview-overlay').classList.remove('visible');
      document.getElementById('file-preview-container').innerHTML = '';
    }

    // Terminal search
    function openTerminalSearch() {
      const searchEl = document.getElementById('terminal-search');
      searchEl.classList.add('visible');
      document.getElementById('terminal-search-input').focus();
    }

    function closeTerminalSearch() {
      document.getElementById('terminal-search').classList.remove('visible');
      document.getElementById('terminal-search-input').value = '';
      document.getElementById('terminal-search-count').textContent = '';
    }

    function getActiveTerminalData() {
      return terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
    }

    function terminalSearchNext() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findNext(query);
      }
    }

    function terminalSearchPrev() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findPrevious(query);
      }
    }

    function handleTerminalSearchKey(e) {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          terminalSearchPrev();
        } else {
          terminalSearchNext();
        }
      } else if (e.key === 'Escape') {
        closeTerminalSearch();
      }
    }

    function openSelectedFile() {
      hideContextMenu();
      if (selectedFile) {
        handleDoubleClick(selectedFile);
      }
    }

    function previewSelectedFile() {
      hideContextMenu();
      if (selectedFile && canPreview(selectedFile.name)) {
        showFilePreview(selectedFile);
      }
    }

    async function deleteFile() {
      hideContextMenu();
      if (selectedFile && confirm(`Delete "${selectedFile.name}"?`)) {
        try {
          if (appMode === 'ftp') {
            await window.api.ftp.delete(selectedFile.path, selectedFile.isDirectory);
          } else {
            await window.api.fs.delete(selectedFile.path);
          }
          loadFiles();
        } catch (err) {
          alert('Delete failed: ' + err.message);
        }
      }
    }

    async function downloadFtpFile() {
      hideContextMenu();
      if (!selectedFile || selectedFile.isDirectory) return;
      try {
        const localPath = await window.api.dialog.saveFile(selectedFile.name);
        if (!localPath) return;
        await window.api.ftp.downloadToLocal(selectedFile.path, localPath);
        document.getElementById('ftp-status').textContent = `Downloaded: ${selectedFile.name}`;
      } catch (err) {
        alert('Download failed: ' + err.message);
      }
    }

    async function uploadFtpFile() {
      hideContextMenu();
      try {
        const localPath = await window.api.dialog.openFile();
        if (!localPath) return;
        const fileName = localPath.split('/').pop();
        const remotePath = currentPath === '/' ? '/' + fileName : currentPath + '/' + fileName;
        await window.api.ftp.uploadFromLocal(localPath, remotePath);
        document.getElementById('ftp-status').textContent = `Uploaded: ${fileName}`;
        loadFiles();
      } catch (err) {
        alert('Upload failed: ' + err.message);
      }
    }

    document.addEventListener('click', (e) => {
      hideContextMenu();
      if (!e.target.closest('#command-palette')) {
        hideCommandPalette();
      }
    });

    // Input dialog
    let inputDialogCallback = null;

    function showInputDialog(title, defaultValue = '') {
      return new Promise((resolve) => {
        document.getElementById('input-dialog-title').textContent = title;
        document.getElementById('input-dialog-input').value = defaultValue;
        document.getElementById('input-dialog').style.display = 'flex';
        document.getElementById('input-dialog-input').focus();
        inputDialogCallback = resolve;
      });
    }

    function closeInputDialog() {
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(null);
        inputDialogCallback = null;
      }
    }

    function confirmInputDialog() {
      const value = document.getElementById('input-dialog-input').value;
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(value);
        inputDialogCallback = null;
      }
    }

    document.getElementById('input-dialog-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmInputDialog();
      if (e.key === 'Escape') closeInputDialog();
    });

    async function newFile() {
      const name = await showInputDialog('Enter file name:');
      if (name && name.trim()) {
        const filePath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.writeFile(filePath, '');
          loadFiles();
          await openFileInEditor({ path: filePath, name: name.trim(), isDirectory: false });
        } catch (err) {
          alert('Could not create file: ' + err.message);
        }
      }
    }

    async function newFolder() {
      const name = await showInputDialog('Enter folder name:');
      if (name && name.trim()) {
        const folderPath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.mkdir(folderPath);
          loadFiles();
        } catch (err) {
          alert('Could not create folder: ' + err.message);
        }
      }
    }

    async function renameFile() {
      hideContextMenu();
      if (!selectedFile) return;
      const newName = await showInputDialog('Enter new name:', selectedFile.name);
      if (newName && newName.trim() && newName !== selectedFile.name) {
        const newPath = currentPath + '/' + newName.trim();
        try {
          await window.api.fs.rename(selectedFile.path, newPath);
          loadFiles();
        } catch (err) {
          alert('Could not rename: ' + err.message);
        }
      }
    }

    // Terminal
    // Split pane tree system
    let paneTree = null; // Root of split tree
    let activePaneId = null; // Currently focused pane's terminal ID

    function createPaneContainer(terminalId) {
      const pane = document.createElement('div');
      pane.className = 'pane-container';
      pane.dataset.termId = terminalId;
      pane.addEventListener('mousedown', () => setActivePane(terminalId));
      return pane;
    }

    function setActivePane(terminalId) {
      activePaneId = terminalId;
      document.querySelectorAll('.pane-container').forEach(el => el.classList.remove('active-pane'));
      const pane = document.querySelector(`.pane-container[data-term-id="${terminalId}"]`);
      if (pane) pane.classList.add('active-pane');
      // Focus the terminal so it receives keyboard input
      const termData = terminals.find(t => t.id === terminalId);
      if (termData) termData.term.focus();
    }

    function findPaneNode(node, terminalId) {
      if (!node) return null;
      if (node.type === 'terminal' && node.terminalId === terminalId) return node;
      if (node.type === 'split') {
        return findPaneNode(node.children[0], terminalId) || findPaneNode(node.children[1], terminalId);
      }
      return null;
    }

    function findPaneParent(node, terminalId, parent) {
      if (!node) return null;
      if (node.type === 'terminal' && node.terminalId === terminalId) return parent;
      if (node.type === 'split') {
        return findPaneParent(node.children[0], terminalId, node) || findPaneParent(node.children[1], terminalId, node);
      }
      return null;
    }

    function dismantlePaneTree() {
      // Move all terminal panels back to flat mode in #terminal-container
      const container = document.getElementById('terminal-container');
      // Collect elements before detaching (getElementById won't find detached nodes)
      const collected = {};
      terminals.forEach(t => {
        const el = document.getElementById(t.id);
        if (el && el.parentNode) {
          el.parentNode.removeChild(el);
          collected[t.id] = el;
        }
      });
      container.innerHTML = '';
      terminals.forEach(t => {
        const el = collected[t.id];
        if (el) {
          container.appendChild(el);
        }
      });
      paneTree = null;
    }

    let _detachedTerminals = {};

    function rebuildPaneDOM() {
      const container = document.getElementById('terminal-container');
      // Detach all terminal panels first (preserve their DOM and xterm state)
      _detachedTerminals = {};
      terminals.forEach(t => {
        const el = document.getElementById(t.id);
        if (el && el.parentNode) {
          el.parentNode.removeChild(el);
          _detachedTerminals[t.id] = el;
        }
      });
      // Clear container of any leftover pane structure
      container.innerHTML = '';
      if (paneTree) {
        renderPaneNode(paneTree, container);
      }
      _detachedTerminals = {};
      // Fit all terminals after DOM rebuild
      setTimeout(() => terminals.forEach(t => t.fitAddon.fit()), 50);
    }

    function renderPaneNode(node, parent) {
      if (node.type === 'terminal') {
        const pane = createPaneContainer(node.terminalId);
        const termEl = _detachedTerminals[node.terminalId] || document.getElementById(node.terminalId);
        if (termEl) pane.appendChild(termEl);
        parent.appendChild(pane);
        // ResizeObserver for fit
        const termData = terminals.find(t => t.id === node.terminalId);
        if (termData) {
          new ResizeObserver(() => termData.fitAddon.fit()).observe(pane);
        }
        if (node.terminalId === activePaneId) pane.classList.add('active-pane');
      } else if (node.type === 'split') {
        const splitEl = document.createElement('div');
        splitEl.className = 'split-pane ' + node.direction;

        // First child with flex ratio
        const child1Wrap = document.createElement('div');
        child1Wrap.style.flex = node.ratio || 0.5;
        child1Wrap.style.display = 'flex';
        child1Wrap.style.minWidth = '0';
        child1Wrap.style.minHeight = '0';
        child1Wrap.style.overflow = 'hidden';
        renderPaneNode(node.children[0], child1Wrap);
        splitEl.appendChild(child1Wrap);

        // Divider
        const divider = document.createElement('div');
        divider.className = node.direction === 'vertical' ? 'split-divider-v' : 'split-divider-h';
        setupSplitDivider(divider, splitEl, node, child1Wrap);
        splitEl.appendChild(divider);

        // Second child with flex ratio
        const child2Wrap = document.createElement('div');
        child2Wrap.style.flex = 1 - (node.ratio || 0.5);
        child2Wrap.style.display = 'flex';
        child2Wrap.style.minWidth = '0';
        child2Wrap.style.minHeight = '0';
        child2Wrap.style.overflow = 'hidden';
        renderPaneNode(node.children[1], child2Wrap);
        splitEl.appendChild(child2Wrap);

        parent.appendChild(splitEl);
      }
    }

    function setupSplitDivider(divider, splitEl, node, child1Wrap) {
      let dragging = false;
      divider.addEventListener('mousedown', (e) => {
        dragging = true;
        e.preventDefault();
        document.body.style.cursor = node.direction === 'vertical' ? 'col-resize' : 'row-resize';
        // Disable webview pointer events
        document.querySelectorAll('webview, iframe').forEach(el => { el.style.pointerEvents = 'none'; });
      });
      const onMove = (e) => {
        if (!dragging) return;
        const rect = splitEl.getBoundingClientRect();
        let ratio;
        if (node.direction === 'vertical') {
          ratio = (e.clientX - rect.left) / rect.width;
        } else {
          ratio = (e.clientY - rect.top) / rect.height;
        }
        ratio = Math.max(0.15, Math.min(0.85, ratio));
        node.ratio = ratio;
        child1Wrap.style.flex = ratio;
        child1Wrap.nextElementSibling.nextElementSibling.style.flex = 1 - ratio;
        terminals.forEach(t => t.fitAddon.fit());
      };
      const onUp = () => {
        if (!dragging) return;
        dragging = false;
        document.body.style.cursor = '';
        document.querySelectorAll('webview, iframe').forEach(el => { el.style.pointerEvents = ''; });
      };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    function splitTerminal(direction) {
      // Find which terminal to split
      const targetId = activePaneId || (terminals.length > 0 ? terminals[terminals.length - 1].id : null);
      if (!targetId) return;

      // Create the new terminal element and xterm instance
      const newId = 'term-' + Date.now();
      const newContainer = document.createElement('div');
      newContainer.className = 'terminal-panel';
      newContainer.id = newId;

      const term = new Terminal({
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        theme: { background: '#0d1117', foreground: '#d1d5db', cursor: '#ffffff', cursorAccent: '#0d1117', selectionBackground: '#0066cc' },
        cursorBlink: true
      });
      const fitAddon = new FitAddon.FitAddon();
      const searchAddon = new SearchAddon.SearchAddon();
      const serializeAddon = new SerializeAddon.SerializeAddon();
      term.loadAddon(fitAddon);
      term.loadAddon(searchAddon);
      term.loadAddon(serializeAddon);

      const shellToUse = settings.shell || defaultShell;
      const shellName = shellToUse.split('/').pop();
      const termData = { id: newId, term, fitAddon, searchAddon, serializeAddon, name: shellName };
      terminals.push(termData);

      // Add tab
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.id = 'tab-' + newId;
      tab.innerHTML = `<span>${shellName}</span><span class="tab-close" onclick="closeTerminal('${newId}', event)">✕</span>`;
      tab.onclick = () => activateTerminal(newId);
      document.getElementById('terminal-tabs').insertBefore(tab, document.getElementById('new-term-btn'));

      // Build or update the pane tree
      if (!paneTree || paneTree.type !== 'split') {
        // First split: create tree with target + new
        paneTree = {
          type: 'split',
          direction: direction,
          ratio: 0.5,
          children: [
            { type: 'terminal', terminalId: targetId },
            { type: 'terminal', terminalId: newId }
          ]
        };
      } else {
        // Already have splits — find target node and split it further
        const replaceInTree = (node) => {
          if (node.type === 'split') {
            for (let i = 0; i < node.children.length; i++) {
              if (node.children[i].type === 'terminal' && node.children[i].terminalId === targetId) {
                node.children[i] = {
                  type: 'split', direction, ratio: 0.5,
                  children: [
                    { type: 'terminal', terminalId: targetId },
                    { type: 'terminal', terminalId: newId }
                  ]
                };
                return true;
              }
              if (replaceInTree(node.children[i])) return true;
            }
          }
          return false;
        };
        replaceInTree(paneTree);
      }

      // Temporarily add the new container to the DOM so rebuildPaneDOM can find it
      document.getElementById('terminal-container').appendChild(newContainer);
      // Open the terminal now so it has content
      term.open(newContainer);

      // Rebuild the pane DOM (moves all terminals into pane containers)
      rebuildPaneDOM();

      // Start the shell process
      window.api.terminal.create(newId, shellToUse, null);
      term.onData(data => window.api.terminal.write(newId, data));
      term.onResize(({ cols, rows }) => window.api.terminal.resize(newId, cols, rows));

      term.attachCustomKeyEventHandler((e) => {
        if (e.type === 'keydown' && e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          window.api.terminal.write(newId, '\n');
          return false;
        }
        return true;
      });

      newContainer.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showTerminalContextMenu(e, newId);
      });

      activePaneId = newId;
      activateTerminal(newId);
    }

    function removePaneFromTree(terminalId) {
      if (!paneTree) return;
      if (paneTree.type === 'terminal') {
        if (paneTree.terminalId === terminalId) paneTree = null;
        return;
      }
      const replaceInParent = (node) => {
        if (node.type !== 'split') return false;
        for (let i = 0; i < node.children.length; i++) {
          if (node.children[i].type === 'terminal' && node.children[i].terminalId === terminalId) {
            // Replace the split with the other child
            const other = node.children[1 - i];
            Object.assign(node, other);
            delete node.children;
            return true;
          }
          if (replaceInParent(node.children[i])) return true;
        }
        return false;
      };
      // Check if root split contains the terminal directly
      if (paneTree.type === 'split') {
        for (let i = 0; i < paneTree.children.length; i++) {
          if (paneTree.children[i].type === 'terminal' && paneTree.children[i].terminalId === terminalId) {
            paneTree = paneTree.children[1 - i];
            return;
          }
        }
        replaceInParent(paneTree);
      }
    }

    function createTerminal(shell, cwd) {
      const id = 'term-' + Date.now();
      const container = document.createElement('div');
      container.className = 'terminal-panel';
      container.id = id;

      const term = new Terminal({
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        theme: {
          background: '#0d1117',
          foreground: '#d1d5db',
          cursor: '#ffffff',
          cursorAccent: '#0d1117',
          selectionBackground: '#0066cc'
        },
        cursorBlink: true
      });

      const fitAddon = new FitAddon.FitAddon();
      const searchAddon = new SearchAddon.SearchAddon();
      const serializeAddon = new SerializeAddon.SerializeAddon();
      term.loadAddon(fitAddon);
      term.loadAddon(searchAddon);
      term.loadAddon(serializeAddon);

      const shellToUse = shell || settings.shell || defaultShell;
      window.api.terminal.create(id, shellToUse, cwd || null);

      term.onData(data => window.api.terminal.write(id, data));
      term.onResize(({ cols, rows }) => window.api.terminal.resize(id, cols, rows));

      term.attachCustomKeyEventHandler((e) => {
        if (e.type === 'keydown' && e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          window.api.terminal.write(id, '\n');
          return false;
        }
        return true;
      });

      const shellName = shellToUse.split('/').pop();
      const termData = { id, term, fitAddon, searchAddon, serializeAddon, name: shellName, cwd: cwd || '' };
      terminals.push(termData);

      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.id = 'tab-' + id;
      tab.innerHTML = `<span class="tab-label">${shellName}</span><span class="tab-close" onclick="closeTerminal('${id}', event)">✕</span>`;
      tab.onclick = () => activateTerminal(id);
      document.getElementById('terminal-tabs').insertBefore(tab, document.getElementById('new-term-btn'));

      // If there are active splits, dismantle the pane tree first
      // New tab-created terminals use simple show/hide, not pane tree
      if (paneTree && paneTree.type === 'split') {
        dismantlePaneTree();
      }

      document.getElementById('terminal-container').appendChild(container);
      term.open(container);
      fitAddon.fit();

      activateTerminal(id);
      new ResizeObserver(() => fitAddon.fit()).observe(container);
      new ResizeObserver(() => fitAddon.fit()).observe(document.getElementById('terminal-container'));

      container.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showTerminalContextMenu(e, id);
      });
    }

    // Periodically update terminal tab labels with CWD
    function updateTerminalCwds() {
      terminals.forEach(async (t) => {
        try {
          const cwd = await window.api.terminal.getCwd(t.id);
          if (cwd && cwd !== t.cwd) {
            t.cwd = cwd;
            const basename = cwd.split('/').pop() || cwd;
            const tabEl = document.getElementById('tab-' + t.id);
            if (tabEl) {
              const label = tabEl.querySelector('.tab-label');
              if (label) label.textContent = `${t.name}: ${basename}`;
            }
          }
        } catch (e) { /* terminal may have exited */ }
      });
    }
    setInterval(updateTerminalCwds, 3000);

    function activateTerminal(id) {
      // Update tab bar
      document.querySelectorAll('#terminal-tabs .tab').forEach(el => el.classList.remove('active'));
      const tabEl = document.getElementById('tab-' + id);
      if (tabEl) tabEl.classList.add('active');

      activePaneId = id;

      if (paneTree && paneTree.type === 'split') {
        // Split mode: highlight the active pane, all terminals visible in their panes
        document.querySelectorAll('.pane-container').forEach(el => el.classList.remove('active-pane'));
        const pane = document.querySelector(`.pane-container[data-term-id="${id}"]`);
        if (pane) pane.classList.add('active-pane');
      } else {
        // Non-split mode: show/hide terminal panels
        document.querySelectorAll('.terminal-panel').forEach(el => el.classList.remove('active'));
        const termEl = document.getElementById(id);
        if (termEl) termEl.classList.add('active');
      }

      const termData = terminals.find(t => t.id === id);
      if (termData) {
        termData.fitAddon.fit();
        termData.term.focus();
      }
    }

    function closeTerminal(id, e) {
      e.stopPropagation();
      window.api.terminal.kill(id);

      const idx = terminals.findIndex(t => t.id === id);
      if (idx !== -1) {
        terminals[idx].term.dispose();
        terminals.splice(idx, 1);
      }

      const el = document.getElementById(id);
      if (el) el.remove();
      const tabEl = document.getElementById('tab-' + id);
      if (tabEl) tabEl.remove();

      // Remove from pane tree
      if (paneTree) {
        removePaneFromTree(id);
        // If tree collapsed to a single terminal, switch back to flat mode
        if (paneTree && paneTree.type === 'terminal') {
          dismantlePaneTree();
        } else if (paneTree && paneTree.type === 'split') {
          rebuildPaneDOM();
        }
      }

      if (terminals.length > 0) {
        activateTerminal(terminals[terminals.length - 1].id);
      }
    }

    window.api.terminal.onData((id, data) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) { termData.term.write(data); return; }
      if (leftTerminalData && leftTerminalData.id === id) leftTerminalData.term.write(data);
    });

    window.api.terminal.onExit((id, code) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) termData.term.write(`\r\n[Process exited with code ${code}]\r\n`);
    });

    // Right Panel
    // Left panel tabs
    let activeLeftTab = null;
    let leftTerminalData = null;

    function showLeftTab(tab) {
      activeLeftTab = tab;
      document.querySelectorAll('.left-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

      const panel = document.getElementById('left-tab-' + tab);
      if (panel) panel.classList.add('active');
      const icon = document.querySelector(`.nav-tab[data-panel="${tab}"]`);
      if (icon) icon.classList.add('active');

      // Expand left panel if collapsed
      const leftPanel = document.getElementById('left-panel');
      if (leftPanel.classList.contains('collapsed')) {
        toggleLeftPanel();
      }

      // Files tab: load files
      if (tab === 'files') {
        loadFiles();
      }

      // Create left terminal if needed
      if (tab === 'terminal' && !leftTerminalData) {
        createLeftTerminal();
      }
      if (tab === 'terminal' && leftTerminalData) {
        setTimeout(() => leftTerminalData.fitAddon.fit(), 50);
      }

      // AI tab: load webview on first show
      if (tab === 'ai') {
        const aiFrame = document.getElementById('ai-frame');
        const aiSelect = document.getElementById('ai-select');
        if (aiFrame && aiFrame.src === 'about:blank' && aiSelect) {
          aiFrame.src = aiSelect.value;
        }
      }

      // Runner tab: refresh on show
      if (tab === 'runner') {
        refreshRunner();
      }

      // Snippets tab: load snippets
      if (tab === 'snippets') {
        loadSnippets();
      }

      // Processes tab: refresh
      if (tab === 'processes') {
        refreshProcesses();
      }

      // Tools tab: show list or active tool content
      if (tab === 'tools') {
        const toolsContent = document.getElementById('tools-content');
        const toolsPanel = document.getElementById('tools-panel');
        if (activeToolName) {
          toolsPanel.style.display = 'none';
          toolsContent.style.display = 'flex';
        } else {
          toolsPanel.style.display = 'flex';
          toolsContent.style.display = 'none';
        }
      }

      // Vault tab: check status on first show
      if (tab === 'vault') {
        vaultInit();
      }
    }

    function createLeftTerminal() {
      const container = document.getElementById('left-terminal-container');
      const term = new Terminal({
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        theme: {
          background: '#0d1117',
          foreground: '#d1d5db',
          cursor: '#ffffff',
          cursorAccent: '#0d1117',
          selectionBackground: '#0066cc'
        },
        cursorBlink: true
      });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(container);
      fitAddon.fit();

      const id = 'left-term-' + Date.now();
      const shellToUse = settings.shell || defaultShell;
      window.api.terminal.create(id, shellToUse, null);
      term.onData(data => window.api.terminal.write(id, data));
      term.onResize(({ cols, rows }) => window.api.terminal.resize(id, cols, rows));

      leftTerminalData = { id, term, fitAddon };
      new ResizeObserver(() => fitAddon.fit()).observe(container);
    }

    // Git panel functions
    async function loadGitStatus() {
      const resultsEl = document.getElementById('git-changes-list');
      resultsEl.innerHTML = '<span style="color:#8b949e;font-size:11px;padding:4px;">Loading...</span>';
      try {
        const result = await window.api.git.statusPorcelain(currentPath);
        if (!result || result.error || !result.stdout) {
          resultsEl.innerHTML = '<span style="color:#8b949e;font-size:11px;padding:4px;">Not a git repository or no changes</span>';
          return;
        }
        const lines = result.stdout.trim().split('\n').filter(l => l);
        if (lines.length === 0) {
          resultsEl.innerHTML = '<span style="color:#4ec94e;font-size:11px;padding:4px;">Working tree clean</span>';
          return;
        }
        resultsEl.innerHTML = lines.map(line => {
          const status = line.substring(0, 2).trim();
          const file = line.substring(3);
          let cls = 'git-status-u';
          if (status === 'M' || status === 'MM') cls = 'git-status-m';
          else if (status === 'A' || status === '??') cls = status === 'A' ? 'git-status-a' : 'git-status-u';
          else if (status === 'D') cls = 'git-status-d';
          const safePath = (currentPath + '/' + file).replace(/'/g, "\\'");
          const safeName = file.split('/').pop().replace(/'/g, "\\'");
          return `<div class="git-file-item" onclick="openFileInEditor({path:'${safePath}',name:'${safeName}',isFile:true})"><span class="${cls}">${status}</span> ${file}</div>`;
        }).join('');
      } catch (e) {
        resultsEl.innerHTML = '<span style="color:#f44;font-size:11px;padding:4px;">Error: ' + e.message + '</span>';
      }
    }

    async function gitCommitAll() {
      const msg = document.getElementById('git-commit-msg').value.trim();
      if (!msg) return;
      try {
        const result = await window.api.git.commitAll(currentPath, msg);
        if (result.error) { console.error('Git commit failed:', result.error); return; }
        document.getElementById('git-commit-msg').value = '';
        loadGitStatus();
      } catch (e) { console.error('Git commit failed:', e); }
    }

    async function gitPush() {
      try { await window.api.git.push(currentPath); } catch (e) { console.error('Git push failed:', e); }
    }

    async function gitPull() {
      try {
        await window.api.git.pull(currentPath);
        loadGitStatus();
      } catch (e) { console.error('Git pull failed:', e); }
    }

    // Git log
    async function loadGitLog() {
      const listEl = document.getElementById('git-log-list');
      listEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">Loading...</span>';
      try {
        const result = await window.api.git.log(currentPath);
        if (result.error || !result.commits.length) {
          listEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">No commits found</span>';
          return;
        }
        listEl.innerHTML = result.commits.map(c => `<div class="git-log-item" onclick="gitShowCommitDiff('${c.hash}')" title="${c.hash}"><span style="color:#f90;">${c.short}</span> <span style="color:#d1d5db;">${c.message}</span><div style="color:#6e7681;font-size:10px;">${c.author} &middot; ${c.date}</div></div>`).join('');
      } catch (e) {
        listEl.innerHTML = '<span style="color:#f44;font-size:11px;">Error loading log</span>';
      }
    }

    function toggleGitLog() {
      const section = document.getElementById('git-log-section');
      const changes = document.getElementById('git-changes-list');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        changes.style.display = 'none';
        loadGitLog();
      } else {
        section.style.display = 'none';
        changes.style.display = 'block';
      }
    }

    async function gitShowCommitDiff(hash) {
      try {
        const result = await window.api.git.diff(currentPath, `${hash}~1 ${hash}`);
        if (result.stdout) {
          // Open diff as read-only in editor
          const diffTab = openFileInEditor({ name: `${hash.substring(0,7)}.diff`, path: '__diff__' + hash, isFile: true, virtual: true });
          if (window.monacoEditor) {
            const model = monaco.editor.createModel(result.stdout, 'diff');
            window.monacoEditor.setModel(model);
          }
        }
      } catch (e) { console.error('Failed to load commit diff:', e); }
    }

    // Git branches
    async function toggleGitBranches() {
      const el = document.getElementById('git-branch-selector');
      if (el.style.display === 'none') {
        el.style.display = 'block';
        loadGitBranches();
      } else {
        el.style.display = 'none';
      }
    }

    async function loadGitBranches() {
      const listEl = document.getElementById('git-branch-list');
      listEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">Loading...</span>';
      try {
        const result = await window.api.git.listBranches(currentPath);
        if (result.error || !result.branches.length) {
          listEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">No branches</span>';
          return;
        }
        listEl.innerHTML = result.branches.map(b => {
          const isCurrent = b.current;
          const style = isCurrent ? 'color:#4ec94e;font-weight:bold;' : 'color:#d1d5db;';
          const prefix = isCurrent ? '● ' : '';
          return `<div class="git-branch-item" style="${style}cursor:pointer;padding:3px 4px;border-radius:3px;" ${isCurrent ? '' : `onclick="gitCheckout('${b.name.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#21262d'" onmouseout="this.style.background=''"`}>${prefix}${b.name} <span style="color:#6e7681;font-size:10px;">${b.hash}</span></div>`;
        }).join('');
      } catch (e) {
        listEl.innerHTML = '<span style="color:#f44;font-size:11px;">Error</span>';
      }
    }

    async function gitCheckout(branch) {
      try {
        const result = await window.api.git.checkout(currentPath, branch);
        if (result.error) { console.error('Checkout failed:', result.error); return; }
        loadGitBranches();
        loadGitStatus();
        // Update branch display
        const branchName = document.getElementById('git-branch-name');
        if (branchName) branchName.textContent = branch;
      } catch (e) { console.error('Checkout failed:', e); }
    }

    async function gitCreateNewBranch() {
      const input = document.getElementById('git-new-branch');
      const name = input.value.trim();
      if (!name) return;
      try {
        const result = await window.api.git.createBranch(currentPath, name);
        if (result.error) { console.error('Create branch failed:', result.error); return; }
        input.value = '';
        loadGitBranches();
        loadGitStatus();
        const branchName = document.getElementById('git-branch-name');
        if (branchName) branchName.textContent = name;
      } catch (e) { console.error('Create branch failed:', e); }
    }

    // Git diff for file (clicking a changed file)
    async function gitDiffFile(filePath) {
      try {
        const result = await window.api.git.diffFile(currentPath, filePath);
        if (result.stdout) {
          openFileInEditor({ name: filePath.split('/').pop() + '.diff', path: '__gitdiff__' + filePath, isFile: true });
          if (window.monacoEditor) {
            const model = monaco.editor.createModel(result.stdout, 'diff');
            window.monacoEditor.setModel(model);
          }
        }
      } catch (e) { console.error('Git diff failed:', e); }
    }

    // Search panel functions
    async function globalSearch() {
      const query = document.getElementById('global-search-input').value.trim();
      if (!query) return;
      const resultsEl = document.getElementById('search-results');
      resultsEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">Searching...</span>';
      const useRegex = document.getElementById('search-regex').checked;
      const caseSensitive = document.getElementById('search-case').checked;
      try {
        const result = await window.api.search.grep(currentPath, query, useRegex, caseSensitive);
        if (!result || result.error || !result.stdout || !result.stdout.trim()) {
          resultsEl.innerHTML = '<span style="color:#8b949e;font-size:11px;">No results found</span>';
          return;
        }
        const lines = result.stdout.trim().split('\n');
        const grouped = {};
        lines.forEach(line => {
          const match = line.match(/^(.+?):(\d+):(.*)$/);
          if (match) {
            const file = match[1].replace(currentPath + '/', '');
            if (!grouped[file]) grouped[file] = [];
            grouped[file].push({ line: match[2], text: match[3] });
          }
        });
        let html = '';
        for (const [file, matches] of Object.entries(grouped)) {
          const safePath = (currentPath + '/' + file).replace(/'/g, "\\'");
          const safeName = file.split('/').pop().replace(/'/g, "\\'");
          html += `<div class="search-result-file" onclick="openFileInEditor({path:'${safePath}',name:'${safeName}',isFile:true})">${file} (${matches.length})</div>`;
          matches.slice(0, 5).forEach(m => {
            const escaped = m.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html += `<div class="search-result-line" onclick="openFileInEditor({path:'${safePath}',name:'${safeName}',isFile:true})">${m.line}: ${escaped}</div>`;
          });
          if (matches.length > 5) {
            html += `<div class="search-result-line" style="color:#484f58;">... ${matches.length - 5} more</div>`;
          }
        }
        resultsEl.innerHTML = html;
      } catch (e) {
        resultsEl.innerHTML = '<span style="color:#f44;font-size:11px;">Error: ' + e.message + '</span>';
      }
    }

    // Legacy compat: redirect to showLeftTab
    function showRightTab(tab) {
      showLeftTab(tab);
    }

    // Tools panel - native implementations
    let activeToolName = null;
    let toolMonitorInterval = null;

    function openTool(name) {
      if (toolMonitorInterval) { clearInterval(toolMonitorInterval); toolMonitorInterval = null; }
      activeToolName = name;
      const toolsContent = document.getElementById('tools-content');
      const toolsPanel = document.getElementById('tools-panel');
      if (toolsPanel) toolsPanel.style.display = 'none';
      toolsContent.style.display = 'flex';
      const renderer = toolRenderers[name];
      if (renderer) renderer(toolsContent);
      else toolsContent.innerHTML = '<div class="tool-header"><button class="tool-back-btn" onclick="showToolsList()">←</button><span class="tool-title">Unknown Tool</span></div>';
    }

    function showToolsList() {
      if (toolMonitorInterval) { clearInterval(toolMonitorInterval); toolMonitorInterval = null; }
      activeToolName = null;
      const toolsContent = document.getElementById('tools-content');
      const toolsPanel = document.getElementById('tools-panel');
      toolsContent.style.display = 'none';
      toolsContent.innerHTML = '';
      if (toolsPanel) toolsPanel.style.display = 'flex';
    }

    function toolHeader(title) {
      return `<div class="tool-header"><button class="tool-back-btn" onclick="showToolsList()">←</button><span class="tool-title">${title}</span></div>`;
    }

    function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    const toolRenderers = {

      // ========== NETWORK ==========

      'ping': (el) => {
        el.innerHTML = toolHeader('Ping') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-ping-host" placeholder="e.g. google.com">
          <label>Count</label><input class="tool-input" id="t-ping-count" value="4" placeholder="4">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPing()">Ping</button></div>
          <div class="tool-output" id="t-ping-out" style="display:none;"></div></div>`;
      },

      'traceroute': (el) => {
        el.innerHTML = toolHeader('Traceroute') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-trace-host" placeholder="e.g. google.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunTraceroute()">Trace</button></div>
          <div class="tool-output" id="t-trace-out" style="display:none;"></div></div>`;
      },

      'dns-lookup': (el) => {
        el.innerHTML = toolHeader('DNS Lookup') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-dns-host" placeholder="e.g. example.com">
          <label>Record Type</label>
          <select class="tool-input" id="t-dns-type"><option>A</option><option>AAAA</option><option>MX</option><option>NS</option><option>TXT</option><option>CNAME</option><option>SOA</option><option>ANY</option></select>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDns()">Lookup</button></div>
          <div class="tool-output" id="t-dns-out" style="display:none;"></div></div>`;
      },

      'reverse-dns': (el) => {
        el.innerHTML = toolHeader('Reverse DNS') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-rdns-ip" placeholder="e.g. 8.8.8.8">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunReverseDns()">Lookup</button></div>
          <div class="tool-output" id="t-rdns-out" style="display:none;"></div></div>`;
      },

      'port-scanner': (el) => {
        el.innerHTML = toolHeader('Port Scanner') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-port-host" placeholder="e.g. example.com">
          <label>Ports (comma-separated)</label><input class="tool-input" id="t-port-ports" value="21,22,25,53,80,110,143,443,993,995,3306,3389,5432,8080,8443" placeholder="80,443,...">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPortScan()">Scan</button></div>
          <div class="tool-output" id="t-port-out" style="display:none;"></div></div>`;
      },

      'ip-info': (el) => {
        el.innerHTML = toolHeader('IP Info') + `<div class="tool-body">
          <label>IP or Domain (blank for your IP)</label><input class="tool-input" id="t-ipinfo-host" placeholder="Leave blank for your public IP">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunIpInfo()">Lookup</button></div>
          <div id="t-ipinfo-out"></div></div>`;
      },

      'whois': (el) => {
        el.innerHTML = toolHeader('Whois') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-whois-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunWhois()">Lookup</button></div>
          <div class="tool-output" id="t-whois-out" style="display:none;"></div></div>`;
      },

      'mac-lookup': (el) => {
        el.innerHTML = toolHeader('MAC Lookup') + `<div class="tool-body">
          <label>MAC Address</label><input class="tool-input" id="t-mac-addr" placeholder="e.g. 00:1A:2B:3C:4D:5E">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMacLookup()">Lookup</button></div>
          <div class="tool-output" id="t-mac-out" style="display:none;"></div></div>`;
      },

      'subnet-calc': (el) => {
        el.innerHTML = toolHeader('Subnet Calculator') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-subnet-ip" placeholder="e.g. 192.168.1.0">
          <label>CIDR / Mask</label><input class="tool-input" id="t-subnet-cidr" value="24" placeholder="24 or 255.255.255.0">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSubnet()">Calculate</button></div>
          <div id="t-subnet-out"></div></div>`;
      },

      'ping-monitor': (el) => {
        el.innerHTML = toolHeader('Ping Monitor') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-pingmon-host" placeholder="e.g. google.com">
          <label>Interval (seconds)</label><input class="tool-input" id="t-pingmon-int" value="5">
          <div class="tool-row"><button class="tool-run-btn" id="t-pingmon-btn" onclick="toolTogglePingMonitor()">Start</button></div>
          <div class="tool-output" id="t-pingmon-out" style="display:none;"></div></div>`;
      },

      'uptime-monitor': (el) => {
        el.innerHTML = toolHeader('Uptime Monitor') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-upmon-url" placeholder="e.g. https://example.com">
          <label>Interval (seconds)</label><input class="tool-input" id="t-upmon-int" value="10">
          <div class="tool-row"><button class="tool-run-btn" id="t-upmon-btn" onclick="toolToggleUptimeMonitor()">Start</button></div>
          <div class="tool-output" id="t-upmon-out" style="display:none;"></div></div>`;
      },

      'blacklist-check': (el) => {
        el.innerHTML = toolHeader('Blacklist Check') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-bl-ip" placeholder="e.g. 1.2.3.4">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBlacklist()">Check</button></div>
          <div class="tool-output" id="t-bl-out" style="display:none;"></div></div>`;
      },

      // ========== SSL / SECURITY ==========

      'ssl-checker': (el) => {
        el.innerHTML = toolHeader('SSL Checker') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-ssl-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSslCheck()">Check</button></div>
          <div class="tool-output" id="t-ssl-out" style="display:none;"></div></div>`;
      },

      'ssl-expiry': (el) => {
        el.innerHTML = toolHeader('SSL Expiry') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-sslexp-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSslExpiry()">Check</button></div>
          <div class="tool-output" id="t-sslexp-out" style="display:none;"></div></div>`;
      },

      'security-headers': (el) => {
        el.innerHTML = toolHeader('Security Headers') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-sechdr-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSecHeaders()">Check</button></div>
          <div id="t-sechdr-out"></div></div>`;
      },

      'password-generator': (el) => {
        el.innerHTML = toolHeader('Password Generator') + `<div class="tool-body">
          <label>Length</label><input class="tool-input" id="t-pwgen-len" type="number" value="16">
          <label>Options</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <label style="margin:0;color:#d1d5db;font-size:12px;"><input type="checkbox" id="t-pwgen-upper" checked> A-Z</label>
            <label style="margin:0;color:#d1d5db;font-size:12px;"><input type="checkbox" id="t-pwgen-lower" checked> a-z</label>
            <label style="margin:0;color:#d1d5db;font-size:12px;"><input type="checkbox" id="t-pwgen-digits" checked> 0-9</label>
            <label style="margin:0;color:#d1d5db;font-size:12px;"><input type="checkbox" id="t-pwgen-symbols" checked> !@#$</label>
          </div>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPwGen()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyPw()">Copy</button></div>
          <div class="tool-output" id="t-pwgen-out" style="display:none;font-size:14px;"></div></div>`;
      },

      'password-checker': (el) => {
        el.innerHTML = toolHeader('Password Checker') + `<div class="tool-body">
          <label>Password</label><input class="tool-input" id="t-pwchk-pw" type="text" placeholder="Enter password to check">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPwCheck()">Check</button></div>
          <div id="t-pwchk-out"></div></div>`;
      },

      'hash-generator': (el) => {
        el.innerHTML = toolHeader('Hash Generator') + `<div class="tool-body">
          <label>Input Text</label><textarea class="tool-textarea" id="t-hash-input" placeholder="Text to hash..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunHash()">Generate</button></div>
          <div id="t-hash-out"></div></div>`;
      },

      // ========== WEB / SEO ==========

      'seo-analyzer': (el) => {
        el.innerHTML = toolHeader('SEO Analyzer') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-seo-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSeo()">Analyze</button></div>
          <div id="t-seo-out"></div></div>`;
      },

      'page-speed': (el) => {
        el.innerHTML = toolHeader('Page Speed') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-speed-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPageSpeed()">Test</button></div>
          <div id="t-speed-out"></div></div>`;
      },

      'broken-links': (el) => {
        el.innerHTML = toolHeader('Broken Links') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-blinks-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBrokenLinks()">Check</button></div>
          <div class="tool-output" id="t-blinks-out" style="display:none;"></div></div>`;
      },

      'http-headers': (el) => {
        el.innerHTML = toolHeader('HTTP Headers') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-hdrs-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunHttpHeaders()">Fetch</button></div>
          <div class="tool-output" id="t-hdrs-out" style="display:none;"></div></div>`;
      },

      'open-graph': (el) => {
        el.innerHTML = toolHeader('Open Graph') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-og-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunOpenGraph()">Fetch</button></div>
          <div id="t-og-out"></div></div>`;
      },

      'meta-tags': (el) => {
        el.innerHTML = toolHeader('Meta Tags') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-meta-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMetaTags()">Fetch</button></div>
          <div id="t-meta-out"></div></div>`;
      },

      'robots-txt': (el) => {
        el.innerHTML = toolHeader('Robots.txt') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-robots-url" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunRobots()">Fetch</button></div>
          <div class="tool-output" id="t-robots-out" style="display:none;"></div></div>`;
      },

      'sitemap-generator': (el) => {
        el.innerHTML = toolHeader('Sitemap Generator') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-sitemap-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSitemap()">Crawl</button></div>
          <div class="tool-output" id="t-sitemap-out" style="display:none;"></div></div>`;
      },

      'domain-expiry': (el) => {
        el.innerHTML = toolHeader('Domain Expiry') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-domexp-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDomainExpiry()">Check</button></div>
          <div class="tool-output" id="t-domexp-out" style="display:none;"></div></div>`;
      },

      // ========== DEVELOPER ==========

      'api-tester': (el) => {
        el.innerHTML = toolHeader('API Tester') + `<div class="tool-body">
          <label>Method</label>
          <select class="tool-input" id="t-api-method"><option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option><option>HEAD</option></select>
          <label>URL</label><input class="tool-input" id="t-api-url" placeholder="https://api.example.com/data">
          <label>Headers (JSON)</label><textarea class="tool-textarea" id="t-api-headers" placeholder='{"Content-Type": "application/json"}'></textarea>
          <label>Body</label><textarea class="tool-textarea" id="t-api-body" placeholder='{"key": "value"}'></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunApi()">Send</button></div>
          <div class="tool-output" id="t-api-out" style="display:none;"></div></div>`;
      },

      'json-formatter': (el) => {
        el.innerHTML = toolHeader('JSON Formatter') + `<div class="tool-body">
          <label>Input JSON</label><textarea class="tool-textarea" id="t-json-input" style="min-height:100px;" placeholder='{"key":"value"}'></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunJsonFormat()">Format</button><button class="tool-secondary-btn" onclick="toolJsonMinify()">Minify</button></div>
          <div class="tool-output" id="t-json-out" style="display:none;"></div></div>`;
      },

      'code-beautifier': (el) => {
        el.innerHTML = toolHeader('Code Beautifier') + `<div class="tool-body">
          <label>Code</label><textarea class="tool-textarea" id="t-beautify-input" style="min-height:120px;" placeholder="Paste code here..."></textarea>
          <label>Indent</label>
          <select class="tool-input" id="t-beautify-indent"><option value="2">2 spaces</option><option value="4">4 spaces</option><option value="tab">Tab</option></select>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBeautify()">Beautify</button></div>
          <div class="tool-output" id="t-beautify-out" style="display:none;"></div></div>`;
      },

      'regex-tester': (el) => {
        el.innerHTML = toolHeader('Regex Tester') + `<div class="tool-body">
          <label>Pattern</label><input class="tool-input" id="t-regex-pattern" placeholder="e.g. \\d+">
          <label>Flags</label><input class="tool-input" id="t-regex-flags" value="g" placeholder="g, i, m...">
          <label>Test String</label><textarea class="tool-textarea" id="t-regex-input" placeholder="Text to test against..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunRegex()">Test</button></div>
          <div class="tool-output" id="t-regex-out" style="display:none;"></div></div>`;
      },

      'base64': (el) => {
        el.innerHTML = toolHeader('Base64') + `<div class="tool-body">
          <label>Input</label><textarea class="tool-textarea" id="t-b64-input" style="min-height:80px;" placeholder="Text to encode/decode..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunB64Encode()">Encode</button><button class="tool-secondary-btn" onclick="toolRunB64Decode()">Decode</button></div>
          <label>Output</label><textarea class="tool-textarea" id="t-b64-output" style="min-height:80px;" readonly></textarea></div>`;
      },

      'jwt-decoder': (el) => {
        el.innerHTML = toolHeader('JWT Decoder') + `<div class="tool-body">
          <label>JWT Token</label><textarea class="tool-textarea" id="t-jwt-input" placeholder="eyJhbGciOiJIUzI1NiIs..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunJwt()">Decode</button></div>
          <div id="t-jwt-out"></div></div>`;
      },

      'cron-parser': (el) => {
        el.innerHTML = toolHeader('Cron Parser') + `<div class="tool-body">
          <label>Cron Expression</label><input class="tool-input" id="t-cron-input" placeholder="e.g. */5 * * * *">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunCron()">Parse</button></div>
          <div class="tool-output" id="t-cron-out" style="display:none;"></div></div>`;
      },

      'uuid-generator': (el) => {
        el.innerHTML = toolHeader('UUID Generator') + `<div class="tool-body">
          <label>Count</label><input class="tool-input" id="t-uuid-count" type="number" value="1" min="1" max="100">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunUuid()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyUuid()">Copy</button></div>
          <div class="tool-output" id="t-uuid-out" style="display:none;"></div></div>`;
      },

      'timestamp-converter': (el) => {
        el.innerHTML = toolHeader('Timestamp Converter') + `<div class="tool-body">
          <label>Unix Timestamp</label><input class="tool-input" id="t-ts-unix" placeholder="e.g. 1700000000">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunTsToDate()">→ Date</button><button class="tool-secondary-btn" onclick="toolRunTsNow()">Now</button></div>
          <label>Date String</label><input class="tool-input" id="t-ts-date" placeholder="e.g. 2024-01-15 12:00:00">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDateToTs()">→ Timestamp</button></div>
          <div class="tool-output" id="t-ts-out" style="display:none;"></div></div>`;
      },

      // ========== UTILITIES ==========

      'markdown-preview': (el) => {
        el.innerHTML = toolHeader('Markdown Preview') + `<div class="tool-body">
          <label>Markdown</label><textarea class="tool-textarea" id="t-md-input" style="min-height:120px;" placeholder="# Hello World"></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMarkdown()">Preview</button></div>
          <div id="t-md-out" style="margin-top:10px;padding:8px;background:#21262d;border-radius:4px;color:#d1d5db;font-size:12px;"></div></div>`;
      },

      'lorem-ipsum': (el) => {
        el.innerHTML = toolHeader('Lorem Ipsum') + `<div class="tool-body">
          <label>Paragraphs</label><input class="tool-input" id="t-lorem-count" type="number" value="3" min="1" max="20">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunLorem()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyLorem()">Copy</button></div>
          <div class="tool-output" id="t-lorem-out" style="display:none;color:#d1d5db;"></div></div>`;
      },

      'qr-generator': (el) => {
        el.innerHTML = toolHeader('QR Generator') + `<div class="tool-body">
          <label>Text / URL</label><input class="tool-input" id="t-qr-input" placeholder="Enter text or URL">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunQr()">Generate</button></div>
          <div id="t-qr-out" style="margin-top:10px;text-align:center;"></div></div>`;
      },

      'color-picker': (el) => {
        el.innerHTML = toolHeader('Color Picker') + `<div class="tool-body">
          <label>Color</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="color" id="t-color-picker" value="#0066cc" style="width:40px;height:32px;border:none;background:none;cursor:pointer;">
            <input class="tool-input" id="t-color-hex" value="#0066cc" style="flex:1;" oninput="toolUpdateColor()">
          </div>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolConvertColor()">Convert</button></div>
          <div id="t-color-out"></div></div>`;
        document.getElementById('t-color-picker').addEventListener('input', (e) => {
          document.getElementById('t-color-hex').value = e.target.value;
        });
      },

      'env-viewer': (el) => {
        el.innerHTML = toolHeader('Environment Variables') + `<div class="tool-body">
          <input class="tool-input" id="t-env-search" placeholder="Search variables..." oninput="filterEnvVars()">
          <div class="tool-row"><button class="tool-run-btn" onclick="loadEnvVars()">Refresh</button></div>
          <div id="t-env-list" style="max-height:500px;overflow-y:auto;"></div></div>`;
        loadEnvVars();
      },
    };

    // ========== TOOL FUNCTION IMPLEMENTATIONS ==========

    // --- Network ---
    async function toolRunPing() {
      const host = document.getElementById('t-ping-host').value.trim();
      const count = document.getElementById('t-ping-count').value || '4';
      if (!host) return;
      const out = document.getElementById('t-ping-out');
      out.style.display = 'block'; out.textContent = 'Pinging...';
      const r = await window.api.tools.exec(`ping -c ${parseInt(count)} ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No response';
      if (r.error && !r.stdout) out.classList.add('error'); else out.classList.remove('error');
    }

    async function toolRunTraceroute() {
      const host = document.getElementById('t-trace-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-trace-out');
      out.style.display = 'block'; out.textContent = 'Tracing route... (may take a moment)';
      const r = await window.api.tools.exec(`traceroute -m 20 ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No response';
    }

    async function toolRunDns() {
      const host = document.getElementById('t-dns-host').value.trim();
      const type = document.getElementById('t-dns-type').value;
      if (!host) return;
      const out = document.getElementById('t-dns-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`dig ${host} ${type} +noall +answer`);
      out.textContent = r.stdout || r.stderr || r.error || 'No records found';
    }

    async function toolRunReverseDns() {
      const ip = document.getElementById('t-rdns-ip').value.trim();
      if (!ip) return;
      const out = document.getElementById('t-rdns-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`dig -x ${ip} +noall +answer`);
      out.textContent = r.stdout || r.stderr || r.error || 'No PTR record found';
    }

    async function toolRunPortScan() {
      const host = document.getElementById('t-port-host').value.trim();
      const ports = document.getElementById('t-port-ports').value.trim();
      if (!host || !ports) return;
      const out = document.getElementById('t-port-out');
      out.style.display = 'block'; out.textContent = 'Scanning ports...';
      const portList = ports.split(',').map(p => p.trim()).filter(p => p);
      let results = '';
      for (const port of portList) {
        const r = await window.api.tools.exec(`nc -z -w 2 ${host} ${port}`);
        const open = !r.error;
        results += `Port ${port}: ${open ? '✓ OPEN' : '✗ closed'}\n`;
        out.textContent = results;
      }
    }

    async function toolRunIpInfo() {
      const host = document.getElementById('t-ipinfo-host').value.trim();
      const out = document.getElementById('t-ipinfo-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const url = host ? `http://ip-api.com/json/${host}` : 'http://ip-api.com/json/';
      const r = await window.api.tools.exec(`curl -s "${url}"`);
      try {
        const d = JSON.parse(r.stdout);
        out.innerHTML = `<table class="tool-result-table">
          <tr><td>IP</td><td>${escHtml(d.query||'')}</td></tr>
          <tr><td>Country</td><td>${escHtml(d.country||'')} (${escHtml(d.countryCode||'')})</td></tr>
          <tr><td>Region</td><td>${escHtml(d.regionName||'')}</td></tr>
          <tr><td>City</td><td>${escHtml(d.city||'')}</td></tr>
          <tr><td>ZIP</td><td>${escHtml(d.zip||'')}</td></tr>
          <tr><td>ISP</td><td>${escHtml(d.isp||'')}</td></tr>
          <tr><td>Org</td><td>${escHtml(d.org||'')}</td></tr>
          <tr><td>AS</td><td>${escHtml(d.as||'')}</td></tr>
          <tr><td>Timezone</td><td>${escHtml(d.timezone||'')}</td></tr>
          <tr><td>Lat/Lon</td><td>${d.lat}, ${d.lon}</td></tr></table>`;
      } catch { out.innerHTML = `<div class="tool-output">${escHtml(r.stdout || r.error || 'Error')}</div>`; }
    }

    async function toolRunWhois() {
      const host = document.getElementById('t-whois-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-whois-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`whois ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No data';
    }

    async function toolRunMacLookup() {
      const mac = document.getElementById('t-mac-addr').value.trim();
      if (!mac) return;
      const out = document.getElementById('t-mac-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const prefix = mac.replace(/[^a-fA-F0-9]/g, '').substring(0, 6);
      const r = await window.api.tools.exec(`curl -s "https://api.macvendors.com/${encodeURIComponent(mac)}"`);
      out.textContent = r.stdout || 'Vendor not found';
    }

    function toolRunSubnet() {
      const ipStr = document.getElementById('t-subnet-ip').value.trim();
      const cidrStr = document.getElementById('t-subnet-cidr').value.trim();
      if (!ipStr) return;
      const out = document.getElementById('t-subnet-out');
      let cidr = parseInt(cidrStr);
      if (cidrStr.includes('.')) {
        const parts = cidrStr.split('.').map(Number);
        cidr = parts.reduce((a, b) => a + (b >>> 0).toString(2).split('1').length - 1, 0);
      }
      if (isNaN(cidr) || cidr < 0 || cidr > 32) { out.innerHTML = '<div class="tool-status fail">Invalid CIDR</div>'; return; }
      const ip = ipStr.split('.').map(Number);
      const ipNum = (ip[0]<<24 | ip[1]<<16 | ip[2]<<8 | ip[3]) >>> 0;
      const mask = cidr === 0 ? 0 : (0xFFFFFFFF << (32 - cidr)) >>> 0;
      const network = (ipNum & mask) >>> 0;
      const broadcast = (network | ~mask) >>> 0;
      const firstHost = (network + 1) >>> 0;
      const lastHost = (broadcast - 1) >>> 0;
      const hosts = cidr <= 30 ? Math.pow(2, 32 - cidr) - 2 : (cidr === 31 ? 2 : 1);
      const toIp = n => [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.');
      const toMask = c => { const m = c===0?0:(0xFFFFFFFF<<(32-c))>>>0; return toIp(m); };
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Network</td><td>${toIp(network)}/${cidr}</td></tr>
        <tr><td>Netmask</td><td>${toMask(cidr)}</td></tr>
        <tr><td>Wildcard</td><td>${toIp(~mask >>> 0)}</td></tr>
        <tr><td>Broadcast</td><td>${toIp(broadcast)}</td></tr>
        <tr><td>First Host</td><td>${toIp(firstHost)}</td></tr>
        <tr><td>Last Host</td><td>${toIp(lastHost)}</td></tr>
        <tr><td>Usable Hosts</td><td>${hosts.toLocaleString()}</td></tr>
        <tr><td>IP Class</td><td>${ip[0]<128?'A':ip[0]<192?'B':ip[0]<224?'C':ip[0]<240?'D':'E'}</td></tr></table>`;
    }

    async function toolTogglePingMonitor() {
      const btn = document.getElementById('t-pingmon-btn');
      if (toolMonitorInterval) {
        clearInterval(toolMonitorInterval); toolMonitorInterval = null;
        btn.textContent = 'Start'; return;
      }
      const host = document.getElementById('t-pingmon-host').value.trim();
      const interval = parseInt(document.getElementById('t-pingmon-int').value) || 5;
      if (!host) return;
      btn.textContent = 'Stop';
      const out = document.getElementById('t-pingmon-out');
      out.style.display = 'block'; out.textContent = '';
      const doPing = async () => {
        const time = new Date().toLocaleTimeString();
        const r = await window.api.tools.exec(`ping -c 1 -W 2 ${host}`);
        const match = r.stdout && r.stdout.match(/time[=<]([\d.]+)/);
        const ms = match ? match[1] + ' ms' : 'timeout';
        out.textContent += `[${time}] ${host}: ${ms}\n`;
        out.scrollTop = out.scrollHeight;
      };
      await doPing();
      toolMonitorInterval = setInterval(doPing, interval * 1000);
    }

    async function toolToggleUptimeMonitor() {
      const btn = document.getElementById('t-upmon-btn');
      if (toolMonitorInterval) {
        clearInterval(toolMonitorInterval); toolMonitorInterval = null;
        btn.textContent = 'Start'; return;
      }
      const url = document.getElementById('t-upmon-url').value.trim();
      const interval = parseInt(document.getElementById('t-upmon-int').value) || 10;
      if (!url) return;
      btn.textContent = 'Stop';
      const out = document.getElementById('t-upmon-out');
      out.style.display = 'block'; out.textContent = '';
      const doCheck = async () => {
        const time = new Date().toLocaleTimeString();
        const r = await window.api.tools.exec(`curl -o /dev/null -s -w "%{http_code} %{time_total}s" "${url}"`);
        out.textContent += `[${time}] ${r.stdout || 'error'}\n`;
        out.scrollTop = out.scrollHeight;
      };
      await doCheck();
      toolMonitorInterval = setInterval(doCheck, interval * 1000);
    }

    async function toolRunBlacklist() {
      const ip = document.getElementById('t-bl-ip').value.trim();
      if (!ip) return;
      const out = document.getElementById('t-bl-out');
      out.style.display = 'block'; out.textContent = 'Checking blacklists...';
      const reversed = ip.split('.').reverse().join('.');
      const dnsbls = ['zen.spamhaus.org','bl.spamcop.net','b.barracudacentral.org','dnsbl.sorbs.net','spam.dnsbl.sorbs.net'];
      let results = '';
      for (const bl of dnsbls) {
        const r = await window.api.tools.exec(`dig +short ${reversed}.${bl}`);
        const listed = r.stdout && r.stdout.trim().length > 0;
        results += `${bl}: ${listed ? '⚠ LISTED' : '✓ Clean'}\n`;
        out.textContent = results;
      }
    }

    // --- SSL / Security ---
    async function toolRunSslCheck() {
      const host = document.getElementById('t-ssl-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-ssl-out');
      out.style.display = 'block'; out.textContent = 'Checking SSL...';
      const r = await window.api.tools.exec(`openssl s_client -connect ${host}:443 -servername ${host} </dev/null 2>/dev/null | openssl x509 -noout -subject -issuer -dates -serial`);
      out.textContent = r.stdout || r.stderr || r.error || 'Could not connect';
    }

    async function toolRunSslExpiry() {
      const host = document.getElementById('t-sslexp-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-sslexp-out');
      out.style.display = 'block'; out.textContent = 'Checking...';
      const r = await window.api.tools.exec(`openssl s_client -connect ${host}:443 -servername ${host} </dev/null 2>/dev/null | openssl x509 -noout -dates`);
      if (r.stdout) {
        const lines = r.stdout.trim().split('\n');
        let text = '';
        lines.forEach(line => {
          if (line.startsWith('notBefore=')) text += 'Issued: ' + line.replace('notBefore=', '') + '\n';
          if (line.startsWith('notAfter=')) {
            const dateStr = line.replace('notAfter=', '');
            const expiry = new Date(dateStr);
            const now = new Date();
            const days = Math.floor((expiry - now) / 86400000);
            text += 'Expires: ' + dateStr + '\n';
            text += days > 0 ? `${days} days remaining` : `EXPIRED ${Math.abs(days)} days ago`;
          }
        });
        out.textContent = text;
      } else { out.textContent = r.error || 'Could not connect'; out.classList.add('error'); }
    }

    async function toolRunSecHeaders() {
      const url = document.getElementById('t-sechdr-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-sechdr-out');
      out.innerHTML = '<div class="tool-status">Checking...</div>';
      const r = await window.api.tools.exec(`curl -sI "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not connect</div>'; return; }
      const headers = r.stdout.toLowerCase();
      const checks = [
        ['Strict-Transport-Security', 'strict-transport-security'],
        ['Content-Security-Policy', 'content-security-policy'],
        ['X-Frame-Options', 'x-frame-options'],
        ['X-Content-Type-Options', 'x-content-type-options'],
        ['X-XSS-Protection', 'x-xss-protection'],
        ['Referrer-Policy', 'referrer-policy'],
        ['Permissions-Policy', 'permissions-policy'],
      ];
      let html = '<table class="tool-result-table"><tr><th>Header</th><th>Status</th></tr>';
      checks.forEach(([name, key]) => {
        const found = headers.includes(key);
        html += `<tr><td>${name}</td><td class="tool-status ${found?'ok':'fail'}">${found?'✓ Present':'✗ Missing'}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    function toolRunPwGen() {
      const len = parseInt(document.getElementById('t-pwgen-len').value) || 16;
      let chars = '';
      if (document.getElementById('t-pwgen-upper').checked) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      if (document.getElementById('t-pwgen-lower').checked) chars += 'abcdefghijklmnopqrstuvwxyz';
      if (document.getElementById('t-pwgen-digits').checked) chars += '0123456789';
      if (document.getElementById('t-pwgen-symbols').checked) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
      if (!chars) chars = 'abcdefghijklmnopqrstuvwxyz';
      const arr = new Uint32Array(len);
      crypto.getRandomValues(arr);
      let pw = '';
      for (let i = 0; i < len; i++) pw += chars[arr[i] % chars.length];
      const out = document.getElementById('t-pwgen-out');
      out.style.display = 'block'; out.textContent = pw;
    }

    function toolCopyPw() {
      const text = document.getElementById('t-pwgen-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunPwCheck() {
      const pw = document.getElementById('t-pwchk-pw').value;
      const out = document.getElementById('t-pwchk-out');
      if (!pw) { out.innerHTML = ''; return; }
      const len = pw.length;
      const hasUpper = /[A-Z]/.test(pw);
      const hasLower = /[a-z]/.test(pw);
      const hasDigit = /\d/.test(pw);
      const hasSymbol = /[^A-Za-z0-9]/.test(pw);
      let pool = 0;
      if (hasUpper) pool += 26;
      if (hasLower) pool += 26;
      if (hasDigit) pool += 10;
      if (hasSymbol) pool += 32;
      const entropy = Math.floor(len * Math.log2(pool || 1));
      let strength = 'Weak', cls = 'fail';
      if (entropy >= 60) { strength = 'Moderate'; cls = 'warn'; }
      if (entropy >= 80) { strength = 'Strong'; cls = 'ok'; }
      if (entropy >= 100) { strength = 'Very Strong'; cls = 'ok'; }
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Length</td><td>${len}</td></tr>
        <tr><td>Uppercase</td><td>${hasUpper?'✓':'✗'}</td></tr>
        <tr><td>Lowercase</td><td>${hasLower?'✓':'✗'}</td></tr>
        <tr><td>Digits</td><td>${hasDigit?'✓':'✗'}</td></tr>
        <tr><td>Symbols</td><td>${hasSymbol?'✓':'✗'}</td></tr>
        <tr><td>Entropy</td><td>${entropy} bits</td></tr>
        <tr><td>Strength</td><td class="tool-status ${cls}">${strength}</td></tr></table>`;
    }

    async function toolRunHash() {
      const input = document.getElementById('t-hash-input').value;
      const out = document.getElementById('t-hash-out');
      if (!input) { out.innerHTML = ''; return; }
      const enc = new TextEncoder();
      const data = enc.encode(input);
      const algos = ['SHA-1', 'SHA-256', 'SHA-384', 'SHA-512'];
      let html = '<table class="tool-result-table">';
      for (const algo of algos) {
        const hash = await crypto.subtle.digest(algo, data);
        const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        html += `<tr><td>${algo}</td><td style="word-break:break-all;">${hex}</td></tr>`;
      }
      // MD5 via command
      const r = await window.api.tools.exec(`echo -n "${input.replace(/"/g, '\\"')}" | md5`);
      if (r.stdout) html = `<tr><td>MD5</td><td>${escHtml(r.stdout.trim())}</td></tr>` + html;
      html = '<table class="tool-result-table">' + html.replace('<table class="tool-result-table">', '') + '</table>';
      out.innerHTML = html;
    }

    // --- Web / SEO ---
    async function toolRunSeo() {
      const url = document.getElementById('t-seo-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-seo-out');
      out.innerHTML = '<div class="tool-status">Analyzing...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch page</div>'; return; }
      const html = r.stdout;
      const getTag = (tag) => { const m = html.match(new RegExp(`<${tag}[^>]*>([^<]*)</${tag}>`, 'i')); return m ? m[1].trim() : 'Not found'; };
      const getMeta = (name) => { const m = html.match(new RegExp(`<meta[^>]*name=["']${name}["'][^>]*content=["']([^"']*)["']`, 'i')) || html.match(new RegExp(`<meta[^>]*content=["']([^"']*)["'][^>]*name=["']${name}["']`, 'i')); return m ? m[1] : 'Not found'; };
      const title = getTag('title');
      const h1s = (html.match(/<h1[^>]*>[^<]*<\/h1>/gi) || []).length;
      const h2s = (html.match(/<h2[^>]*>[^<]*<\/h2>/gi) || []).length;
      const imgs = (html.match(/<img /gi) || []).length;
      const imgsNoAlt = (html.match(/<img (?![^>]*alt=)[^>]*>/gi) || []).length;
      const links = (html.match(/<a /gi) || []).length;
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Title</td><td>${escHtml(title)} (${title.length} chars)</td></tr>
        <tr><td>Description</td><td>${escHtml(getMeta('description'))}</td></tr>
        <tr><td>Keywords</td><td>${escHtml(getMeta('keywords'))}</td></tr>
        <tr><td>H1 Tags</td><td>${h1s}</td></tr>
        <tr><td>H2 Tags</td><td>${h2s}</td></tr>
        <tr><td>Images</td><td>${imgs} (${imgsNoAlt} missing alt)</td></tr>
        <tr><td>Links</td><td>${links}</td></tr>
        <tr><td>Viewport</td><td>${escHtml(getMeta('viewport'))}</td></tr></table>`;
    }

    async function toolRunPageSpeed() {
      const url = document.getElementById('t-speed-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-speed-out');
      out.innerHTML = '<div class="tool-status">Testing...</div>';
      const r = await window.api.tools.exec(`curl -o /dev/null -s -w "DNS: %{time_namelookup}s\\nConnect: %{time_connect}s\\nTLS: %{time_appconnect}s\\nFirst Byte: %{time_starttransfer}s\\nTotal: %{time_total}s\\nSize: %{size_download} bytes\\nHTTP Code: %{http_code}" "${url}"`);
      if (r.stdout) {
        const lines = r.stdout.split('\n');
        let html = '<table class="tool-result-table">';
        lines.forEach(l => { const [k,v] = l.split(': '); if(k&&v) html += `<tr><td>${escHtml(k)}</td><td>${escHtml(v)}</td></tr>`; });
        html += '</table>';
        out.innerHTML = html;
      } else { out.innerHTML = '<div class="tool-status fail">Could not connect</div>'; }
    }

    async function toolRunBrokenLinks() {
      const url = document.getElementById('t-blinks-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-blinks-out');
      out.style.display = 'block'; out.textContent = 'Fetching page...';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.textContent = 'Could not fetch page'; return; }
      const matches = r.stdout.match(/href=["']([^"']+)["']/gi) || [];
      const links = [...new Set(matches.map(m => m.match(/href=["']([^"']+)["']/i)[1]).filter(l => l.startsWith('http')))].slice(0, 20);
      out.textContent = `Found ${links.length} links. Checking...\n\n`;
      for (const link of links) {
        const c = await window.api.tools.exec(`curl -o /dev/null -s -w "%{http_code}" -L "${link}"`);
        const code = (c.stdout || '').trim();
        const ok = code.startsWith('2') || code.startsWith('3');
        out.textContent += `${ok ? '✓' : '✗'} [${code}] ${link}\n`;
        out.scrollTop = out.scrollHeight;
      }
    }

    async function toolRunHttpHeaders() {
      const url = document.getElementById('t-hdrs-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-hdrs-out');
      out.style.display = 'block'; out.textContent = 'Fetching...';
      const r = await window.api.tools.exec(`curl -sI "${url}"`);
      out.textContent = r.stdout || r.error || 'Could not connect';
    }

    async function toolRunOpenGraph() {
      const url = document.getElementById('t-og-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-og-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch</div>'; return; }
      const ogTags = r.stdout.match(/<meta[^>]*property=["']og:[^"']*["'][^>]*>/gi) || [];
      if (ogTags.length === 0) { out.innerHTML = '<div class="tool-status warn">No Open Graph tags found</div>'; return; }
      let html = '<table class="tool-result-table">';
      ogTags.forEach(tag => {
        const prop = (tag.match(/property=["']([^"']*)["']/i) || [])[1] || '';
        const content = (tag.match(/content=["']([^"']*)["']/i) || [])[1] || '';
        html += `<tr><td>${escHtml(prop)}</td><td>${escHtml(content)}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    async function toolRunMetaTags() {
      const url = document.getElementById('t-meta-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-meta-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch</div>'; return; }
      const metaTags = r.stdout.match(/<meta[^>]*>/gi) || [];
      let html = '<table class="tool-result-table">';
      metaTags.forEach(tag => {
        const name = (tag.match(/(?:name|property|http-equiv)=["']([^"']*)["']/i) || [])[1] || '';
        const content = (tag.match(/content=["']([^"']*)["']/i) || [])[1] || '';
        if (name || content) html += `<tr><td>${escHtml(name)}</td><td>${escHtml(content)}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    async function toolRunRobots() {
      let domain = document.getElementById('t-robots-url').value.trim();
      if (!domain) return;
      if (!domain.startsWith('http')) domain = 'https://' + domain;
      const out = document.getElementById('t-robots-out');
      out.style.display = 'block'; out.textContent = 'Fetching...';
      const r = await window.api.tools.exec(`curl -sL "${domain}/robots.txt"`);
      out.textContent = r.stdout || 'No robots.txt found';
    }

    async function toolRunSitemap() {
      let url = document.getElementById('t-sitemap-url').value.trim();
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;
      const out = document.getElementById('t-sitemap-out');
      out.style.display = 'block'; out.textContent = 'Fetching sitemap...';
      // Try common sitemap locations
      const locations = ['/sitemap.xml', '/sitemap_index.xml', '/sitemap/sitemap.xml'];
      for (const loc of locations) {
        const r = await window.api.tools.exec(`curl -sL "${url}${loc}"`);
        if (r.stdout && r.stdout.includes('<urlset') || r.stdout && r.stdout.includes('<sitemapindex')) {
          const urls = (r.stdout.match(/<loc>([^<]+)<\/loc>/g) || []).map(m => m.replace(/<\/?loc>/g, ''));
          out.textContent = `Found at ${url}${loc}\n${urls.length} URLs:\n\n${urls.join('\n')}`;
          return;
        }
      }
      out.textContent = 'No sitemap found at common locations.';
    }

    async function toolRunDomainExpiry() {
      const host = document.getElementById('t-domexp-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-domexp-out');
      out.style.display = 'block'; out.textContent = 'Checking...';
      const r = await window.api.tools.exec(`whois ${host}`);
      if (!r.stdout) { out.textContent = r.error || 'Could not lookup'; return; }
      const expiryMatch = r.stdout.match(/(?:expir|paid-till|validity)[^:]*:\s*(.+)/i);
      if (expiryMatch) {
        const expDate = new Date(expiryMatch[1].trim());
        const now = new Date();
        const days = Math.floor((expDate - now) / 86400000);
        out.textContent = `Domain: ${host}\nExpiry: ${expiryMatch[1].trim()}\n${days > 0 ? days + ' days remaining' : 'EXPIRED ' + Math.abs(days) + ' days ago'}`;
      } else {
        out.textContent = 'Could not find expiry date.\n\nFull WHOIS:\n' + r.stdout.substring(0, 2000);
      }
    }

    // --- Developer ---
    async function toolRunApi() {
      const method = document.getElementById('t-api-method').value;
      const url = document.getElementById('t-api-url').value.trim();
      if (!url) return;
      const headersStr = document.getElementById('t-api-headers').value.trim();
      const body = document.getElementById('t-api-body').value.trim();
      const out = document.getElementById('t-api-out');
      out.style.display = 'block'; out.textContent = 'Sending...';
      let cmd = `curl -s -w "\\n\\n--- Response Info ---\\nHTTP Code: %{http_code}\\nTime: %{time_total}s\\nSize: %{size_download} bytes" -X ${method}`;
      if (headersStr) {
        try {
          const hdrs = JSON.parse(headersStr);
          Object.entries(hdrs).forEach(([k, v]) => { cmd += ` -H "${k}: ${v}"`; });
        } catch {}
      }
      if (body && method !== 'GET' && method !== 'HEAD') cmd += ` -d '${body.replace(/'/g, "'\\''")}'`;
      cmd += ` "${url}"`;
      const r = await window.api.tools.exec(cmd);
      out.textContent = r.stdout || r.error || 'No response';
    }

    function toolRunJsonFormat() {
      const input = document.getElementById('t-json-input').value;
      const out = document.getElementById('t-json-out');
      out.style.display = 'block';
      try {
        const parsed = JSON.parse(input);
        out.textContent = JSON.stringify(parsed, null, 2);
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolJsonMinify() {
      const input = document.getElementById('t-json-input').value;
      const out = document.getElementById('t-json-out');
      out.style.display = 'block';
      try {
        out.textContent = JSON.stringify(JSON.parse(input));
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolRunBeautify() {
      const input = document.getElementById('t-beautify-input').value;
      const indentVal = document.getElementById('t-beautify-indent').value;
      const out = document.getElementById('t-beautify-out');
      out.style.display = 'block';
      // Try JSON first
      try {
        const indent = indentVal === 'tab' ? '\t' : parseInt(indentVal);
        out.textContent = JSON.stringify(JSON.parse(input), null, indent);
        return;
      } catch {}
      // Basic HTML/code beautifier
      let indent = 0;
      const indentStr = indentVal === 'tab' ? '\t' : ' '.repeat(parseInt(indentVal));
      const lines = input.replace(/>\s*</g, '>\n<').split('\n');
      const result = lines.map(line => {
        line = line.trim();
        if (line.startsWith('</')) indent = Math.max(0, indent - 1);
        const formatted = indentStr.repeat(indent) + line;
        if (line.startsWith('<') && !line.startsWith('</') && !line.startsWith('<!') && !line.endsWith('/>') && !line.includes('</')) indent++;
        return formatted;
      }).join('\n');
      out.textContent = result;
    }

    function toolRunRegex() {
      const pattern = document.getElementById('t-regex-pattern').value;
      const flags = document.getElementById('t-regex-flags').value;
      const input = document.getElementById('t-regex-input').value;
      const out = document.getElementById('t-regex-out');
      out.style.display = 'block';
      try {
        const re = new RegExp(pattern, flags);
        const matches = [];
        let m;
        if (flags.includes('g')) {
          while ((m = re.exec(input)) !== null) { matches.push({ match: m[0], index: m.index, groups: m.slice(1) }); if (!m[0]) break; }
        } else {
          m = re.exec(input);
          if (m) matches.push({ match: m[0], index: m.index, groups: m.slice(1) });
        }
        if (matches.length === 0) { out.textContent = 'No matches'; return; }
        let text = `${matches.length} match(es):\n\n`;
        matches.forEach((m, i) => {
          text += `Match ${i+1}: "${m.match}" at index ${m.index}\n`;
          if (m.groups.length) text += `  Groups: ${m.groups.map((g,j) => `$${j+1}="${g}"`).join(', ')}\n`;
        });
        out.textContent = text;
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolRunB64Encode() {
      const input = document.getElementById('t-b64-input').value;
      document.getElementById('t-b64-output').value = btoa(unescape(encodeURIComponent(input)));
    }

    function toolRunB64Decode() {
      const input = document.getElementById('t-b64-input').value;
      try { document.getElementById('t-b64-output').value = decodeURIComponent(escape(atob(input))); }
      catch { document.getElementById('t-b64-output').value = 'Error: Invalid Base64'; }
    }

    function toolRunJwt() {
      const token = document.getElementById('t-jwt-input').value.trim();
      const out = document.getElementById('t-jwt-out');
      if (!token) { out.innerHTML = ''; return; }
      try {
        const parts = token.split('.');
        if (parts.length < 2) throw new Error('Invalid JWT format');
        const decode = (s) => JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/')))));
        const header = decode(parts[0]);
        const payload = decode(parts[1]);
        let html = '<label style="margin-top:10px;">Header</label><div class="tool-output">' + escHtml(JSON.stringify(header, null, 2)) + '</div>';
        html += '<label>Payload</label><div class="tool-output">' + escHtml(JSON.stringify(payload, null, 2)) + '</div>';
        if (payload.exp) {
          const exp = new Date(payload.exp * 1000);
          const now = new Date();
          html += `<div class="tool-status ${exp > now ? 'ok' : 'fail'}">Expires: ${exp.toLocaleString()} (${exp > now ? 'valid' : 'EXPIRED'})</div>`;
        }
        if (payload.iat) html += `<div class="tool-status">Issued: ${new Date(payload.iat * 1000).toLocaleString()}</div>`;
        out.innerHTML = html;
      } catch (e) { out.innerHTML = `<div class="tool-status fail">Error: ${escHtml(e.message)}</div>`; }
    }

    function toolRunCron() {
      const expr = document.getElementById('t-cron-input').value.trim();
      const out = document.getElementById('t-cron-out');
      out.style.display = 'block';
      if (!expr) { out.textContent = ''; return; }
      const parts = expr.split(/\s+/);
      if (parts.length < 5) { out.textContent = 'Need 5 fields: min hour dom month dow'; return; }
      const [min, hour, dom, month, dow] = parts;
      const desc = (val, unit, names) => {
        if (val === '*') return `every ${unit}`;
        if (val.includes('/')) return `every ${val.split('/')[1]} ${unit}(s)`;
        if (val.includes(',')) return `at ${unit} ${val}`;
        if (val.includes('-')) return `${unit} ${val}`;
        if (names && names[parseInt(val)]) return names[parseInt(val)];
        return `at ${unit} ${val}`;
      };
      const dowNames = {0:'Sunday',1:'Monday',2:'Tuesday',3:'Wednesday',4:'Thursday',5:'Friday',6:'Saturday',7:'Sunday'};
      const monNames = {1:'January',2:'February',3:'March',4:'April',5:'May',6:'June',7:'July',8:'August',9:'September',10:'October',11:'November',12:'December'};
      let text = `Schedule: ${expr}\n\n`;
      text += `Minute: ${desc(min, 'minute')}\n`;
      text += `Hour: ${desc(hour, 'hour')}\n`;
      text += `Day of Month: ${desc(dom, 'day')}\n`;
      text += `Month: ${desc(month, 'month', monNames)}\n`;
      text += `Day of Week: ${desc(dow, 'day', dowNames)}\n`;
      // Generate next 5 run times (simplified)
      text += '\nHuman readable:\n';
      if (min === '*' && hour === '*') text += 'Runs every minute';
      else if (hour === '*') text += `Runs at minute ${min} of every hour`;
      else if (min !== '*' && hour !== '*' && dom === '*' && month === '*' && dow === '*') text += `Runs daily at ${hour.padStart(2,'0')}:${min.padStart(2,'0')}`;
      else text += 'Custom schedule';
      out.textContent = text;
    }

    function toolRunUuid() {
      const count = parseInt(document.getElementById('t-uuid-count').value) || 1;
      const out = document.getElementById('t-uuid-out');
      out.style.display = 'block';
      let uuids = [];
      for (let i = 0; i < Math.min(count, 100); i++) uuids.push(crypto.randomUUID());
      out.textContent = uuids.join('\n');
    }

    function toolCopyUuid() {
      const text = document.getElementById('t-uuid-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunTsToDate() {
      const ts = document.getElementById('t-ts-unix').value.trim();
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      if (!ts) { out.textContent = ''; return; }
      const num = parseInt(ts);
      const ms = num > 9999999999 ? num : num * 1000;
      const d = new Date(ms);
      out.textContent = `UTC: ${d.toUTCString()}\nLocal: ${d.toLocaleString()}\nISO: ${d.toISOString()}`;
    }

    function toolRunDateToTs() {
      const dateStr = document.getElementById('t-ts-date').value.trim();
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      if (!dateStr) { out.textContent = ''; return; }
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) { out.textContent = 'Invalid date'; return; }
      out.textContent = `Unix (seconds): ${Math.floor(d.getTime() / 1000)}\nUnix (ms): ${d.getTime()}\nISO: ${d.toISOString()}`;
    }

    function toolRunTsNow() {
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      const now = new Date();
      document.getElementById('t-ts-unix').value = Math.floor(now.getTime() / 1000);
      out.textContent = `Now: ${now.toLocaleString()}\nUnix: ${Math.floor(now.getTime() / 1000)}\nISO: ${now.toISOString()}`;
    }

    // --- Utilities ---
    function toolRunMarkdown() {
      const input = document.getElementById('t-md-input').value;
      const out = document.getElementById('t-md-out');
      // Simple markdown to HTML
      let html = escHtml(input);
      html = html.replace(/^### (.+)$/gm, '<h3 style="color:#fff;margin:8px 0 4px;">$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2 style="color:#fff;margin:8px 0 4px;">$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1 style="color:#fff;margin:8px 0 4px;">$1</h1>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/`(.+?)`/g, '<code style="background:#30363d;padding:1px 4px;border-radius:3px;">$1</code>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
      html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" style="color:#0088ff;">$1</a>');
      html = html.replace(/\n/g, '<br>');
      out.innerHTML = html;
    }

    function toolRunLorem() {
      const count = parseInt(document.getElementById('t-lorem-count').value) || 3;
      const out = document.getElementById('t-lorem-out');
      out.style.display = 'block';
      const paras = [
        'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.',
        'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
        'Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.',
        'Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.',
        'Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.',
        'Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?',
        'Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?',
        'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.',
      ];
      let result = [];
      for (let i = 0; i < count; i++) result.push(paras[i % paras.length]);
      out.textContent = result.join('\n\n');
    }

    function toolCopyLorem() {
      const text = document.getElementById('t-lorem-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunQr() {
      const input = document.getElementById('t-qr-input').value.trim();
      const out = document.getElementById('t-qr-out');
      if (!input) { out.innerHTML = ''; return; }
      // Simple QR using a free API (generates image)
      const size = 200;
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(input)}`;
      out.innerHTML = `<img src="${url}" alt="QR Code" style="border-radius:4px;background:#fff;padding:8px;">`;
    }

    function toolConvertColor() {
      const hex = document.getElementById('t-color-hex').value.trim();
      const out = document.getElementById('t-color-out');
      const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if (!m) { out.innerHTML = '<div class="tool-status fail">Invalid hex color</div>'; return; }
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      // HSL conversion
      const r1 = r/255, g1 = g/255, b1 = b/255;
      const max = Math.max(r1,g1,b1), min = Math.min(r1,g1,b1);
      let h, s, l = (max+min)/2;
      if (max === min) { h = s = 0; }
      else {
        const d = max - min;
        s = l > 0.5 ? d/(2-max-min) : d/(max+min);
        switch(max) {
          case r1: h = ((g1-b1)/d + (g1<b1?6:0))/6; break;
          case g1: h = ((b1-r1)/d + 2)/6; break;
          case b1: h = ((r1-g1)/d + 4)/6; break;
        }
      }
      const fullHex = '#' + m[1] + m[2] + m[3];
      document.getElementById('t-color-picker').value = fullHex;
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>HEX</td><td>${fullHex.toUpperCase()}</td></tr>
        <tr><td>RGB</td><td>rgb(${r}, ${g}, ${b})</td></tr>
        <tr><td>HSL</td><td>hsl(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%)</td></tr>
        <tr><td>Preview</td><td><div style="width:100%;height:24px;background:${fullHex};border-radius:3px;"></div></td></tr></table>`;
    }

    function toolUpdateColor() {
      const hex = document.getElementById('t-color-hex').value.trim();
      if (/^#?[a-f\d]{6}$/i.test(hex)) {
        document.getElementById('t-color-picker').value = hex.startsWith('#') ? hex : '#' + hex;
      }
    }

    // --- Environment Variables ---
    let envVarsData = [];
    async function loadEnvVars() {
      const out = document.getElementById('t-env-list');
      if (!out) return;
      out.innerHTML = '<div style="color:#8b949e;font-size:11px;">Loading...</div>';
      try {
        const result = await window.api.tools.exec('env | sort');
        const lines = (result.stdout || '').split('\n').filter(l => l.includes('='));
        envVarsData = lines.map(l => {
          const idx = l.indexOf('=');
          return { name: l.substring(0, idx), value: l.substring(idx + 1) };
        });
        renderEnvVars(envVarsData);
      } catch (e) {
        out.innerHTML = '<div class="tool-status fail">Error loading env vars</div>';
      }
    }

    function renderEnvVars(vars) {
      const out = document.getElementById('t-env-list');
      if (!out) return;
      if (vars.length === 0) {
        out.innerHTML = '<div style="color:#8b949e;font-size:11px;">No matching variables</div>';
        return;
      }
      out.innerHTML = '<table class="tool-result-table">' +
        vars.map(v => `<tr><td style="color:#58a6ff;white-space:nowrap;vertical-align:top;font-size:11px;">${escHtml(v.name)}</td><td style="word-break:break-all;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${escHtml(v.value)}" onclick="navigator.clipboard.writeText(this.title)" style="cursor:pointer;">${escHtml(v.value.length > 80 ? v.value.substring(0, 80) + '...' : v.value)}</td></tr>`
        ).join('') + '</table>';
    }

    function filterEnvVars() {
      const query = (document.getElementById('t-env-search')?.value || '').toLowerCase();
      if (!query) { renderEnvVars(envVarsData); return; }
      renderEnvVars(envVarsData.filter(v => v.name.toLowerCase().includes(query) || v.value.toLowerCase().includes(query)));
    }

    function switchAI() {
      const select = document.getElementById('ai-select');
      const frame = document.getElementById('ai-frame');
      frame.src = select.value;
    }

    // FTP
    let ftpConnected = false;
    let ftpCurrentPath = '/';

    async function connectFtp() {
      const host = document.getElementById('ftp-host').value.trim();
      const port = parseInt(document.getElementById('ftp-port').value) || 21;
      const user = document.getElementById('ftp-user').value.trim();
      const pass = document.getElementById('ftp-pass').value;
      const secure = document.getElementById('ftp-secure').checked;

      if (!host) {
        document.getElementById('ftp-status').textContent = 'Enter a host';
        document.getElementById('ftp-status').style.color = '#f44';
        return;
      }

      document.getElementById('ftp-status').textContent = 'Connecting...';
      document.getElementById('ftp-status').style.color = '#888';
      document.getElementById('ftp-connect-btn').disabled = true;

      try {
        await window.api.ftp.connect(host, port, user, pass, secure);
        ftpConnected = true;
        ftpCurrentPath = '/';
        document.getElementById('ftp-status').textContent = `Connected: ${host}`;
        document.getElementById('ftp-status').style.color = '#4c4';
        document.getElementById('ftp-connect-btn').style.display = 'none';
        document.getElementById('ftp-disconnect-btn').style.display = '';
        switchToFtpMode(host);
      } catch (err) {
        document.getElementById('ftp-status').textContent = 'Error: ' + err.message;
        document.getElementById('ftp-status').style.color = '#f44';
      }
      document.getElementById('ftp-connect-btn').disabled = false;
    }

    function disconnectFtp() {
      window.api.ftp.disconnect();
      ftpConnected = false;
      document.getElementById('ftp-status').textContent = 'Not connected';
      document.getElementById('ftp-status').style.color = '#666';
      document.getElementById('ftp-connect-btn').style.display = '';
      document.getElementById('ftp-disconnect-btn').style.display = 'none';
      switchToLocalMode();
    }

    // Saved FTP connections (file-based storage via IPC)
    let cachedConnections = [];

    async function loadSavedConnectionsFromFile() {
      cachedConnections = await window.api.ftpConnections.load();
      return cachedConnections;
    }

    async function saveConnectionsToFile(connections) {
      cachedConnections = connections;
      await window.api.ftpConnections.save(connections);
      syncNow();
    }

    async function renderSavedConnections() {
      const select = document.getElementById('ftp-saved');
      const connections = await loadSavedConnectionsFromFile();
      select.innerHTML = '<option value="">Saved...</option>';
      connections.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = c.label || `${c.user}@${c.host}`;
        select.appendChild(opt);
      });
    }

    function loadSavedConnection() {
      const select = document.getElementById('ftp-saved');
      const idx = select.value;
      if (idx === '') {
        document.getElementById('ftp-delete-saved-btn').style.display = 'none';
        return;
      }
      const c = cachedConnections[idx];
      if (c) {
        document.getElementById('ftp-host').value = c.host || '';
        document.getElementById('ftp-port').value = c.port || '21';
        document.getElementById('ftp-user').value = c.user || '';
        document.getElementById('ftp-pass').value = c.pass || '';
        document.getElementById('ftp-secure').checked = c.secure || false;
        document.getElementById('ftp-delete-saved-btn').style.display = '';
      }
    }

    async function saveConnection() {
      const host = document.getElementById('ftp-host').value.trim();
      const port = document.getElementById('ftp-port').value || '21';
      const user = document.getElementById('ftp-user').value.trim();
      const pass = document.getElementById('ftp-pass').value;
      const secure = document.getElementById('ftp-secure').checked;
      if (!host) return;
      const connections = [...cachedConnections];
      const existsIdx = connections.findIndex(c => c.host === host && c.user === user);
      if (existsIdx >= 0) {
        connections[existsIdx].port = port;
        connections[existsIdx].pass = pass;
        connections[existsIdx].secure = secure;
      } else {
        connections.push({ host, port, user, pass, secure, label: `${user}@${host}` });
      }
      await saveConnectionsToFile(connections);
      await renderSavedConnections();
      document.getElementById('ftp-status').textContent = 'Connection saved';
      document.getElementById('ftp-status').style.color = '#4c4';
    }

    async function deleteSavedConnection() {
      const select = document.getElementById('ftp-saved');
      const idx = parseInt(select.value);
      if (isNaN(idx)) return;
      const connections = [...cachedConnections];
      connections.splice(idx, 1);
      await saveConnectionsToFile(connections);
      await renderSavedConnections();
      document.getElementById('ftp-delete-saved-btn').style.display = 'none';
      document.getElementById('ftp-status').textContent = 'Connection deleted';
      document.getElementById('ftp-status').style.color = '#888';
    }

    // Load saved connections on startup
    renderSavedConnections();

    // Notes
    let notesEditor = null;
    async function initNotes() {
      if (!monacoReady) return; // Monaco not loaded yet
      const container = document.getElementById('notes-editor-container');
      if (!container) return;

      // Dispose previous instance if re-initializing (e.g. cloud pull)
      if (notesEditor) {
        notesEditor.dispose();
        notesEditor = null;
        container.innerHTML = '';
      }

      const saved = await window.api.notes.load();
      const content = (saved && saved.content) ? saved.content : '';

      notesEditor = monaco.editor.create(container, {
        value: content,
        language: 'markdown',
        theme: 'vs-dark',
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        minimap: { enabled: false },
        wordWrap: 'on',
        lineNumbers: 'off',
        scrollBeyondLastLine: false,
        renderWhitespace: 'none',
        overviewRulerLanes: 0,
        hideCursorInOverviewRuler: true,
        automaticLayout: true,
        padding: { top: 8 }
      });

      let saveTimeout;
      notesEditor.onDidChangeModelContent(() => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          window.api.notes.save({ content: notesEditor.getValue() });
          syncNow();
        }, 500);
      });
    }

    // ============ Favorites / File Bookmarks ============
    function pinToFavorites() {
      if (!selectedFile) return;
      hideContextMenu();
      if (selectedFile.isDirectory) {
        if (!bookmarks.includes(selectedFile.path)) {
          bookmarks.push(selectedFile.path);
          localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
          loadBookmarks();
          syncNow();
        }
      } else {
        const fileBookmarks = JSON.parse(localStorage.getItem('dterm-file-bookmarks') || '[]');
        if (!fileBookmarks.includes(selectedFile.path)) {
          fileBookmarks.push(selectedFile.path);
          localStorage.setItem('dterm-file-bookmarks', JSON.stringify(fileBookmarks));
          loadBookmarks();
          syncNow();
        }
      }
    }

    function removeFileBookmark(index, e) {
      e.stopPropagation();
      const fileBookmarks = JSON.parse(localStorage.getItem('dterm-file-bookmarks') || '[]');
      fileBookmarks.splice(index, 1);
      localStorage.setItem('dterm-file-bookmarks', JSON.stringify(fileBookmarks));
      loadBookmarks();
      syncNow();
    }

    async function openFileByPath(filePath) {
      try {
        const content = await window.api.fs.readFile(filePath);
        const name = filePath.split('/').pop();
        const existing = openFiles.findIndex(f => f.path === filePath);
        if (existing >= 0) {
          activateFile(existing);
          return;
        }
        openFiles.push({ name, path: filePath, content, modified: false });
        activeFileIndex = openFiles.length - 1;
        showEditor();
        setEditorContent(content, name);
        updateEditorTabs();
        document.getElementById('status-file').textContent = name;
      } catch (e) {
        console.error('Error opening file:', e);
      }
    }

    // ============ Side-by-Side Diff View ============
    let diffEditor = null;

    async function compareWithFile() {
      if (!selectedFile) return;
      hideContextMenu();
      const firstPath = selectedFile.path;
      const firstName = selectedFile.name;
      // Open a file dialog to pick the second file
      const secondPath = await window.api.dialog.openFile();
      if (!secondPath) return;
      try {
        const firstContent = await window.api.fs.readFile(firstPath);
        const secondContent = await window.api.fs.readFile(secondPath);
        const secondName = secondPath.split('/').pop();
        showDiffView(firstName, firstContent, secondName, secondContent);
      } catch (e) {
        console.error('Error comparing files:', e);
      }
    }

    async function compareCurrentFile() {
      if (activeFileIndex < 0 || !openFiles[activeFileIndex]) return;
      const file = openFiles[activeFileIndex];
      const secondPath = await window.api.dialog.openFile();
      if (!secondPath) return;
      try {
        const secondContent = await window.api.fs.readFile(secondPath);
        const secondName = secondPath.split('/').pop();
        showDiffView(file.name, file.content, secondName, secondContent);
      } catch (e) {
        console.error('Error comparing files:', e);
      }
    }

    function showDiffView(name1, content1, name2, content2) {
      if (!monacoReady) return;
      const container = document.getElementById('editor-container');
      if (monacoEditor) { monacoEditor.dispose(); monacoEditor = null; }
      if (diffEditor) { diffEditor.dispose(); diffEditor = null; }
      container.innerHTML = '';

      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '✕ Close Diff';
      closeBtn.style.cssText = 'position:absolute;top:4px;right:8px;z-index:10;background:#30363d;color:#d1d5db;border:1px solid #555;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:11px;';
      closeBtn.onclick = closeDiffView;
      container.style.position = 'relative';
      container.appendChild(closeBtn);

      diffEditor = monaco.editor.createDiffEditor(container, {
        theme: settings.theme === 'light' ? 'vs' : 'vs-dark',
        fontSize: settings.fontSize,
        automaticLayout: true,
        readOnly: true,
        renderSideBySide: true
      });

      diffEditor.setModel({
        original: monaco.editor.createModel(content1, getLanguage(name1)),
        modified: monaco.editor.createModel(content2, getLanguage(name2))
      });

      showEditor();
    }

    function closeDiffView() {
      if (diffEditor) { diffEditor.dispose(); diffEditor = null; }
      const container = document.getElementById('editor-container');
      container.innerHTML = '';
      container.style.position = '';
      // Re-open current file if any
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }
    }

    // ============ Path Autocomplete in Quick Run ============
    let recentCommands = JSON.parse(localStorage.getItem('dterm-recent-commands') || '[]');
    let autocompleteVisible = false;

    function setupRunnerAutocomplete() {
      const input = document.getElementById('runner-custom-cmd');
      if (!input) return;

      // Create dropdown
      let dropdown = document.getElementById('runner-autocomplete');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'runner-autocomplete';
        dropdown.className = 'autocomplete-dropdown';
        dropdown.style.cssText = 'display:none;position:absolute;background:#21262d;border:1px solid #30363d;border-radius:4px;max-height:200px;overflow-y:auto;z-index:100;width:calc(100% - 20px);left:10px;';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }

      input.addEventListener('input', () => {
        const val = input.value.trim().toLowerCase();
        if (!val) { dropdown.style.display = 'none'; autocompleteVisible = false; return; }
        const suggestions = getAutocompleteSuggestions(val);
        if (suggestions.length === 0) { dropdown.style.display = 'none'; autocompleteVisible = false; return; }
        dropdown.innerHTML = suggestions.map(s =>
          `<div style="padding:4px 8px;cursor:pointer;font-size:12px;color:#d1d5db;" onmousedown="selectAutocomplete('${s.replace(/'/g, "\\'")}')" onmouseenter="this.style.background='#2a2a2a'" onmouseleave="this.style.background=''">${s}</div>`
        ).join('');
        dropdown.style.display = 'block';
        autocompleteVisible = true;
      });

      input.addEventListener('blur', () => {
        setTimeout(() => { dropdown.style.display = 'none'; autocompleteVisible = false; }, 150);
      });
    }

    function selectAutocomplete(value) {
      const input = document.getElementById('runner-custom-cmd');
      if (input) input.value = value;
      const dropdown = document.getElementById('runner-autocomplete');
      if (dropdown) dropdown.style.display = 'none';
      autocompleteVisible = false;
    }

    function getAutocompleteSuggestions(query) {
      const suggestions = [];
      // Recent commands
      recentCommands.forEach(cmd => {
        if (cmd.toLowerCase().includes(query) && !suggestions.includes(cmd)) suggestions.push(cmd);
      });
      // Common commands
      const common = ['npm start', 'npm test', 'npm run build', 'npm run dev', 'npm install',
        'python3', 'node', 'go run .', 'cargo run', 'cargo build', 'cargo test',
        'make', 'make clean', 'make install', 'docker build .', 'docker-compose up',
        'git status', 'git log --oneline', 'pip install -r requirements.txt'];
      common.forEach(cmd => {
        if (cmd.toLowerCase().includes(query) && !suggestions.includes(cmd)) suggestions.push(cmd);
      });
      return suggestions.slice(0, 8);
    }

    function addRecentCommand(cmd) {
      recentCommands = recentCommands.filter(c => c !== cmd);
      recentCommands.unshift(cmd);
      if (recentCommands.length > 20) recentCommands.pop();
      localStorage.setItem('dterm-recent-commands', JSON.stringify(recentCommands));
      syncNow();
    }

    // ============ Environment Variable Viewer ============
    // Added as a tool in the Tools panel

    // ============ Snippets Manager ============
    let snippetsData = [];

    async function loadSnippets() {
      snippetsData = await window.api.snippets.load();
      renderSnippets();
    }

    function renderSnippets() {
      const list = document.getElementById('snippets-list');
      if (!list) return;
      if (snippetsData.length === 0) {
        list.innerHTML = '<div style="padding:12px;color:#484f58;font-size:12px;text-align:center;">No snippets yet. Click + New to create one.</div>';
        return;
      }
      list.innerHTML = snippetsData.map((s, i) => `
        <div style="padding:6px 8px;border-bottom:1px solid #1a1a1a;cursor:pointer;" onmouseenter="this.style.background='#1a1a1a'" onmouseleave="this.style.background=''">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="flex:1;font-size:12px;color:#d1d5db;" onclick="insertSnippet(${i})">${escHtml(s.name)}</span>
            <span style="font-size:10px;color:#484f58;background:#21262d;padding:1px 4px;border-radius:2px;">${s.language || 'text'}</span>
            <span style="font-size:10px;color:#6e7681;cursor:pointer;" onclick="editSnippet(${i})">✎</span>
            <span style="font-size:10px;color:#f44;cursor:pointer;" onclick="deleteSnippet(${i})">✕</span>
          </div>
          <div style="font-size:10px;color:#484f58;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" onclick="insertSnippet(${i})">${escHtml(s.code.substring(0, 80))}</div>
        </div>
      `).join('');
    }

    function createSnippet() {
      const name = prompt('Snippet name:');
      if (!name) return;
      const language = prompt('Language (e.g. javascript, python, html):') || 'text';
      const code = prompt('Snippet code:');
      if (!code) return;
      snippetsData.push({ name, language, code });
      window.api.snippets.save(snippetsData);
      renderSnippets();
      syncNow();
    }

    function insertSnippet(index) {
      const snippet = snippetsData[index];
      if (!snippet || !monacoEditor) return;
      const selection = monacoEditor.getSelection();
      monacoEditor.executeEdits('snippet', [{
        range: selection,
        text: snippet.code
      }]);
      monacoEditor.focus();
    }

    function editSnippet(index) {
      const s = snippetsData[index];
      const name = prompt('Snippet name:', s.name);
      if (!name) return;
      const language = prompt('Language:', s.language);
      const code = prompt('Code:', s.code);
      if (code === null) return;
      snippetsData[index] = { name, language: language || 'text', code };
      window.api.snippets.save(snippetsData);
      renderSnippets();
      syncNow();
    }

    function deleteSnippet(index) {
      if (!confirm('Delete this snippet?')) return;
      snippetsData.splice(index, 1);
      window.api.snippets.save(snippetsData);
      renderSnippets();
      syncNow();
    }

    // ============ Process / Port Manager ============
    let processesData = [];
    let portsData = [];

    async function refreshProcesses() {
      await Promise.all([loadProcessList(), loadPortsList()]);
    }

    async function loadProcessList() {
      const list = document.getElementById('process-list');
      if (!list) return;
      list.innerHTML = '<div style="color:#8b949e;font-size:11px;padding:4px;">Loading...</div>';
      try {
        const result = await window.api.processes.list();
        processesData = result.processes || [];
        renderProcessList(processesData);
      } catch (e) {
        list.innerHTML = '<div style="color:#f44;font-size:11px;padding:4px;">Error loading processes</div>';
      }
    }

    function renderProcessList(procs) {
      const list = document.getElementById('process-list');
      if (!list) return;
      if (procs.length === 0) {
        list.innerHTML = '<div style="color:#8b949e;font-size:11px;padding:4px;">No processes found</div>';
        return;
      }
      list.innerHTML = procs.map(line => {
        const parts = line.trim().split(/\s+/);
        const pid = parts[0];
        const rest = parts.slice(1).join(' ');
        return `<div style="display:flex;align-items:center;gap:4px;padding:2px 4px;font-size:11px;border-bottom:1px solid #111;" onmouseenter="this.style.background='#1a1a1a'" onmouseleave="this.style.background=''">
          <span style="color:#58a6ff;min-width:50px;">${pid}</span>
          <span style="flex:1;color:#d1d5db;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(rest)}</span>
          <span style="color:#f44;cursor:pointer;font-size:10px;" onclick="killProcess('${pid}')" title="Kill process">✕</span>
        </div>`;
      }).join('');
    }

    function filterProcessList() {
      const query = (document.getElementById('process-search')?.value || '').toLowerCase();
      if (!query) { renderProcessList(processesData); return; }
      renderProcessList(processesData.filter(l => l.toLowerCase().includes(query)));
    }

    async function killProcess(pid) {
      if (!confirm(`Kill process ${pid}?`)) return;
      const result = await window.api.processes.kill(pid);
      if (result.success) {
        refreshProcesses();
      }
    }

    async function loadPortsList() {
      const list = document.getElementById('ports-list');
      if (!list) return;
      list.innerHTML = '<div style="color:#8b949e;font-size:11px;padding:4px;">Loading...</div>';
      try {
        const lines = await window.api.processes.ports();
        portsData = lines;
        if (lines.length <= 1) {
          list.innerHTML = '<div style="color:#8b949e;font-size:11px;padding:4px;">No listening ports</div>';
          return;
        }
        list.innerHTML = lines.slice(1).map(line => {
          const parts = line.trim().split(/\s+/);
          return `<div style="padding:2px 4px;font-size:10px;color:#d1d5db;border-bottom:1px solid #111;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escHtml(line)}">${escHtml(line)}</div>`;
        }).join('');
      } catch (e) {
        list.innerHTML = '<div style="color:#f44;font-size:11px;padding:4px;">Error loading ports</div>';
      }
    }

    // ============ SSH Terminal ============
    let sshConnections = [];

    async function loadSshConnections() {
      sshConnections = await window.api.sshConnections.load();
    }

    function showSshDialog() {
      const dialog = document.getElementById('ssh-dialog');
      dialog.style.display = 'flex';
      document.getElementById('ssh-host').value = '';
      document.getElementById('ssh-port').value = '22';
      document.getElementById('ssh-user').value = '';
      document.getElementById('ssh-save-conn').checked = false;
      // Render saved connections
      renderSshSaved();
    }

    function closeSshDialog() {
      document.getElementById('ssh-dialog').style.display = 'none';
    }

    function renderSshSaved() {
      const list = document.getElementById('ssh-saved-list');
      if (sshConnections.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = '<div style="font-size:11px;color:#6e7681;margin-bottom:4px;">Saved connections:</div>' +
        sshConnections.map((c, i) => `
          <div style="display:flex;align-items:center;gap:6px;padding:4px 6px;background:#0d1117;border-radius:3px;margin-bottom:3px;cursor:pointer;" onclick="quickSshConnect(${i})" onmouseenter="this.style.background='#222'" onmouseleave="this.style.background='#111'">
            <span style="flex:1;font-size:12px;color:#58a6ff;">${c.user}@${c.host}:${c.port}</span>
            <span style="font-size:10px;color:#f44;cursor:pointer;" onclick="event.stopPropagation();deleteSshConnection(${i})">✕</span>
          </div>
        `).join('');
    }

    async function pickSshKeyFile() {
      const result = await window.api.dialog.openFile();
      if (result) {
        document.getElementById('ssh-keyfile').value = result;
      }
    }

    function quickSshConnect(index) {
      const conn = sshConnections[index];
      document.getElementById('ssh-host').value = conn.host;
      document.getElementById('ssh-port').value = conn.port;
      document.getElementById('ssh-user').value = conn.user;
      document.getElementById('ssh-keyfile').value = conn.keyFile || '';
      connectSsh();
    }

    function connectSsh() {
      const host = document.getElementById('ssh-host').value.trim();
      const port = document.getElementById('ssh-port').value.trim() || '22';
      const user = document.getElementById('ssh-user').value.trim();
      const keyFile = document.getElementById('ssh-keyfile').value.trim();
      if (!host || !user) return;

      const save = document.getElementById('ssh-save-conn').checked;
      if (save) {
        const exists = sshConnections.some(c => c.host === host && c.port === port && c.user === user);
        if (!exists) {
          sshConnections.push({ host, port, user, keyFile: keyFile || undefined });
          window.api.sshConnections.save(sshConnections);
          syncNow();
        }
      }

      closeSshDialog();
      // Create a terminal and run ssh command
      let sshCmd = `ssh`;
      if (keyFile) sshCmd += ` -i "${keyFile}"`;
      if (port !== '22') sshCmd += ` -p ${port}`;
      sshCmd += ` ${user}@${host}`;
      createTerminal(null, null);
      setTimeout(() => {
        const t = terminals[terminals.length - 1];
        if (t) {
          // Update tab label
          const tabEl = document.getElementById('tab-' + t.id);
          if (tabEl) {
            const label = tabEl.querySelector('.tab-label');
            if (label) label.textContent = `ssh:${host}`;
          }
          window.api.terminal.write(t.id, sshCmd + '\n');
        }
      }, 300);
    }

    async function deleteSshConnection(index) {
      sshConnections.splice(index, 1);
      await window.api.sshConnections.save(sshConnections);
      renderSshSaved();
      syncNow();
    }

    // ============ Workspaces ============
    async function saveWorkspace() {
      const name = prompt('Workspace name:');
      if (!name) return;
      const data = {
        currentPath,
        openFilePaths: openFiles.map(f => f.path),
        activeFileIndex,
        terminalCount: terminals.length,
        activeLeftTab,
        leftPanelCollapsed: document.getElementById('left-panel').classList.contains('collapsed')
      };
      await window.api.workspaces.save(name, data);
      syncNow();
    }

    async function loadWorkspace() {
      const workspaces = await window.api.workspaces.list();
      if (workspaces.length === 0) {
        alert('No saved workspaces');
        return;
      }
      const names = workspaces.map(w => w.name);
      const choice = prompt('Load workspace:\n' + names.map((n, i) => `${i + 1}. ${n}`).join('\n') + '\n\nEnter number:');
      if (!choice) return;
      const idx = parseInt(choice) - 1;
      if (idx < 0 || idx >= workspaces.length) return;
      const ws = workspaces[idx];
      if (!ws.data) return;

      // Restore folder
      if (ws.data.currentPath) {
        currentPath = ws.data.currentPath;
        loadFiles();
      }

      // Restore files
      if (ws.data.openFilePaths) {
        for (const filePath of ws.data.openFilePaths) {
          try {
            await openFileByPath(filePath);
          } catch (e) { /* file may not exist */ }
        }
      }

      // Restore terminals
      if (ws.data.terminalCount) {
        const existingCount = terminals.length;
        for (let i = existingCount; i < ws.data.terminalCount; i++) {
          createTerminal();
        }
      }

      // Restore left tab
      if (ws.data.activeLeftTab) {
        showLeftTab(ws.data.activeLeftTab);
      }

      // Update title bar
      const wsName = ws.name;
      const titleCenter = document.querySelector('.title-center');
      if (titleCenter) {
        const ver = document.getElementById('title-version');
        const verText = ver ? ver.outerHTML : '';
        titleCenter.innerHTML = `dTerm — ${wsName} ${verText}`;
      }
    }

    async function deleteWorkspace() {
      const workspaces = await window.api.workspaces.list();
      if (workspaces.length === 0) { alert('No saved workspaces'); return; }
      const names = workspaces.map(w => w.name);
      const choice = prompt('Delete workspace:\n' + names.map((n, i) => `${i + 1}. ${n}`).join('\n') + '\n\nEnter number:');
      if (!choice) return;
      const idx = parseInt(choice) - 1;
      if (idx < 0 || idx >= workspaces.length) return;
      if (!confirm(`Delete workspace "${workspaces[idx].name}"?`)) return;
      await window.api.workspaces.delete(workspaces[idx].name);
      syncNow();
    }

    // ============ Breadcrumb Path Bar ============
    function renderBreadcrumb(pathStr) {
      const container = document.querySelector('#fm-path span');
      if (!container) return;
      if (!pathStr || pathStr === '/') {
        container.innerHTML = '<span class="breadcrumb-segment" onclick="navigateTo(\'/\')">/</span>';
        return;
      }
      const parts = pathStr.split('/').filter(Boolean);
      let html = '<span class="breadcrumb">';
      html += '<span class="breadcrumb-segment" onclick="navigateTo(\'/\')">/</span>';
      parts.forEach((part, i) => {
        const fullPath = '/' + parts.slice(0, i + 1).join('/');
        html += `<span class="breadcrumb-sep">/</span><span class="breadcrumb-segment" onclick="navigateTo('${fullPath.replace(/'/g, "\\'")}')">${part}</span>`;
      });
      html += '</span>';
      container.innerHTML = html;
    }

    function navigateTo(path) {
      currentPath = path;
      loadFiles();
    }

    // ============ File Icons in Editor Tabs ============
    const fileIconMap = {
      'js': { icon: 'JS', color: '#f0db4f' },
      'jsx': { icon: 'JSX', color: '#61dafb' },
      'ts': { icon: 'TS', color: '#3178c6' },
      'tsx': { icon: 'TSX', color: '#3178c6' },
      'py': { icon: 'PY', color: '#3776ab' },
      'rb': { icon: 'RB', color: '#cc342d' },
      'go': { icon: 'GO', color: '#00add8' },
      'rs': { icon: 'RS', color: '#dea584' },
      'java': { icon: 'JV', color: '#f89820' },
      'c': { icon: 'C', color: '#555cb3' },
      'cpp': { icon: 'C+', color: '#004482' },
      'cs': { icon: 'C#', color: '#68217a' },
      'swift': { icon: 'SW', color: '#fa7343' },
      'kt': { icon: 'KT', color: '#a97bff' },
      'html': { icon: '◇', color: '#e44d26' },
      'htm': { icon: '◇', color: '#e44d26' },
      'css': { icon: '#', color: '#264de4' },
      'scss': { icon: 'SC', color: '#cf649a' },
      'less': { icon: 'LS', color: '#1d365d' },
      'json': { icon: '{}', color: '#5b9a32' },
      'xml': { icon: '◇', color: '#f56e22' },
      'yaml': { icon: 'YM', color: '#cb171e' },
      'yml': { icon: 'YM', color: '#cb171e' },
      'md': { icon: 'MD', color: '#519aba' },
      'sql': { icon: 'SQ', color: '#e38c00' },
      'sh': { icon: '$_', color: '#4eaa25' },
      'bash': { icon: '$_', color: '#4eaa25' },
      'zsh': { icon: '$_', color: '#4eaa25' },
      'php': { icon: 'PH', color: '#777bb3' },
      'lua': { icon: 'LU', color: '#000080' },
      'r': { icon: 'R', color: '#276dc3' },
      'svg': { icon: '◇', color: '#ffb13b' },
      'vue': { icon: 'VU', color: '#42b883' },
      'svelte': { icon: 'SV', color: '#ff3e00' },
      'dockerfile': { icon: '🐳', color: '#2496ed' },
      'toml': { icon: 'TM', color: '#9c4221' },
      'ini': { icon: 'IN', color: '#888' },
      'env': { icon: 'EN', color: '#ecd53f' },
      'gitignore': { icon: 'GI', color: '#f05032' },
      'lock': { icon: '🔒', color: '#888' },
    };

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const dotFile = filename.startsWith('.') ? filename.substring(1).toLowerCase() : '';
      const info = fileIconMap[ext] || fileIconMap[dotFile];
      if (info) return `<span class="tab-icon" style="color:${info.color}">${info.icon}</span>`;
      return '<span class="tab-icon" style="color:#888">●</span>';
    }

    // ============ Markdown Preview ============
    let mdPreviewActive = false;

    function simpleMarkdown(text) {
      let html = text
        // Code blocks (fenced)
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Headers
        .replace(/^######\s+(.+)$/gm, '<h6>$1</h6>')
        .replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
        .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
        .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
        .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
        .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
        // Horizontal rule
        .replace(/^---+$/gm, '<hr>')
        // Bold + italic
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        // Bold
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        // Strikethrough
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        // Images
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
        // Links
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        // Blockquotes
        .replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
        // Unordered lists
        .replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>')
        // Ordered lists
        .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
        // Tables (basic)
        .replace(/^\|(.+)\|$/gm, (match, content) => {
          const cells = content.split('|').map(c => c.trim());
          if (cells.every(c => /^[-:]+$/.test(c))) return '';
          const tag = 'td';
          return '<tr>' + cells.map(c => `<${tag}>${c}</${tag}>`).join('') + '</tr>';
        })
        // Wrap consecutive <li> in <ul>
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
        // Wrap consecutive <tr> in <table>
        .replace(/(<tr>.*<\/tr>\n?)+/g, '<table>$&</table>')
        // Line breaks (paragraphs)
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      return '<p>' + html + '</p>';
    }

    function toggleMdPreview() {
      // Close diff view if active
      if (diffViewActive) {
        if (diffEditor && activeFileIndex >= 0 && openFiles[activeFileIndex]) {
          openFiles[activeFileIndex].content = diffEditor.getModifiedEditor().getValue();
        }
        closeDiffViewSilent();
      }

      mdPreviewActive = !mdPreviewActive;
      const toggle = document.getElementById('md-preview-toggle');
      const preview = document.getElementById('md-preview-container');
      const editor = document.getElementById('editor-container');
      if (mdPreviewActive) {
        toggle.classList.add('active');
        toggle.textContent = '◀ Editor';
        preview.classList.add('visible');
        editor.style.display = 'none';
        updateMdPreview();
      } else {
        toggle.classList.remove('active');
        toggle.textContent = 'Preview ▶';
        preview.classList.remove('visible');
        editor.style.display = '';
      }
    }

    function updateMdPreview() {
      if (!mdPreviewActive) return;
      const preview = document.getElementById('md-preview-container');
      if (monacoEditor) {
        preview.innerHTML = simpleMarkdown(monacoEditor.getValue());
      }
    }

    // ============ Inline Diff View (saved vs unsaved) ============
    let diffViewActive = false;

    async function toggleDiffView() {
      const file = openFiles[activeFileIndex];
      if (!file || !file.modified) return;

      diffViewActive = !diffViewActive;

      if (diffViewActive) {
        // Turn off markdown preview if active
        if (mdPreviewActive) {
          mdPreviewActive = false;
          document.getElementById('md-preview-container').classList.remove('visible');
          document.getElementById('editor-container').style.display = '';
          const toggle = document.getElementById('md-preview-toggle');
          if (toggle) { toggle.classList.remove('active'); toggle.textContent = 'Preview ▶'; }
        }

        // Grab current content before disposing
        const currentContent = monacoEditor ? monacoEditor.getValue() : file.content;

        // Read saved version from disk
        let savedContent;
        try {
          if (file.ftpFile) {
            savedContent = await window.api.ftp.readFile(file.path);
          } else {
            savedContent = await window.api.fs.readFile(file.path);
          }
        } catch (e) {
          console.error('Could not read saved file for diff:', e);
          diffViewActive = false;
          updateEditorTabs();
          return;
        }

        // Dispose normal editor
        const container = document.getElementById('editor-container');
        if (monacoEditor) { monacoEditor.dispose(); monacoEditor = null; }
        if (diffEditor) { diffEditor.dispose(); diffEditor = null; }
        container.innerHTML = '';

        // Create diff editor
        const language = getLanguage(file.name);
        diffEditor = monaco.editor.createDiffEditor(container, {
          theme: settings.theme === 'light' ? 'vs' : 'vs-dark',
          fontSize: settings.fontSize,
          automaticLayout: true,
          readOnly: false,
          renderSideBySide: true,
          originalEditable: false
        });

        diffEditor.setModel({
          original: monaco.editor.createModel(savedContent, language),
          modified: monaco.editor.createModel(currentContent, language)
        });

        // Track changes in modified pane
        const modifiedEditor = diffEditor.getModifiedEditor();
        modifiedEditor.onDidChangeModelContent(() => {
          if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
            openFiles[activeFileIndex].content = modifiedEditor.getValue();
            openFiles[activeFileIndex].modified = true;
          }
        });
      } else {
        // Closing diff view — restore normal editor
        if (diffEditor) {
          openFiles[activeFileIndex].content = diffEditor.getModifiedEditor().getValue();
          diffEditor.dispose();
          diffEditor = null;
        }
        const container = document.getElementById('editor-container');
        container.innerHTML = '';
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }

      updateEditorTabs();
    }

    function closeDiffViewSilent() {
      if (!diffViewActive) return;
      diffViewActive = false;
      if (diffEditor) { diffEditor.dispose(); diffEditor = null; }
      const container = document.getElementById('editor-container');
      container.innerHTML = '';
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }
    }

    // ============ Image Preview Tooltip ============
    const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'];
    let imgPreviewTooltip = null;
    let imgPreviewTimeout = null;

    function showImageTooltip(e, filePath) {
      clearTimeout(imgPreviewTimeout);
      imgPreviewTimeout = setTimeout(() => {
        if (!imgPreviewTooltip) {
          imgPreviewTooltip = document.createElement('div');
          imgPreviewTooltip.className = 'file-preview-tooltip';
          document.body.appendChild(imgPreviewTooltip);
        }
        imgPreviewTooltip.innerHTML = `<img src="file://${filePath}">`;
        imgPreviewTooltip.style.display = 'block';
        imgPreviewTooltip.style.left = (e.clientX + 12) + 'px';
        imgPreviewTooltip.style.top = (e.clientY + 12) + 'px';
      }, 300);
    }

    function hideImageTooltip() {
      clearTimeout(imgPreviewTimeout);
      if (imgPreviewTooltip) {
        imgPreviewTooltip.style.display = 'none';
      }
    }

    // ============ Status Bar ============
    function updateStatusBar() {
      // Git branch
      const branchEl = document.getElementById('sb-branch');
      const branchName = document.getElementById('git-branch-name');
      if (branchName && branchName.textContent) {
        branchEl.textContent = '⎇ ' + branchName.textContent;
        branchEl.style.display = '';
      } else {
        branchEl.style.display = 'none';
      }

      // Current directory basename
      const dirEl = document.getElementById('sb-dir');
      if (currentPath) {
        dirEl.textContent = '📁 ' + (currentPath.split('/').pop() || '/');
      }

      // Language
      const langEl = document.getElementById('sb-lang');
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        const lang = getLanguage(openFiles[activeFileIndex].name);
        langEl.textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
      } else {
        langEl.textContent = '';
      }

      // Cursor position
      const cursorEl = document.getElementById('sb-cursor');
      const titleCursor = document.getElementById('status-line');
      cursorEl.textContent = titleCursor ? titleCursor.textContent : '';

      // Terminal count
      const termEl = document.getElementById('sb-terminals');
      termEl.textContent = terminals.length > 0 ? `⬛ ${terminals.length}` : '';
    }

    // Update status bar periodically
    setInterval(updateStatusBar, 2000);

    // Code Runner
    const runnerMap = {
      '.js': (f) => `node "${f}"`,
      '.mjs': (f) => `node "${f}"`,
      '.cjs': (f) => `node "${f}"`,
      '.ts': (f) => `npx tsx "${f}"`,
      '.tsx': (f) => `npx tsx "${f}"`,
      '.py': (f) => `python "${f}"`,
      '.rb': (f) => `ruby "${f}"`,
      '.go': (f) => `go run "${f}"`,
      '.rs': (f) => `cargo run`,
      '.ps1': (f) => `powershell -ExecutionPolicy Bypass -File "${f}"`,
      '.bat': (f) => `"${f}"`,
      '.cmd': (f) => `"${f}"`,
      '.php': (f) => `php "${f}"`,
      '.c': (f) => `gcc "${f}" -o "%TEMP%\\a.exe" && "%TEMP%\\a.exe"`,
      '.cpp': (f) => `g++ "${f}" -o "%TEMP%\\a.exe" && "%TEMP%\\a.exe"`,
      '.java': (f) => { const cls = f.split('\\').pop().replace(/\.java$/, ''); return `javac "${f}" && java ${cls}`; },
      '.pl': (f) => `perl "${f}"`,
      '.lua': (f) => `lua "${f}"`,
      '.r': (f) => `Rscript "${f}"`,
      '.R': (f) => `Rscript "${f}"`,
    };

    function getRunnerForFile(filePath) {
      if (!filePath) return null;
      const ext = '.' + filePath.split('.').pop();
      return runnerMap[ext] || null;
    }

    async function runCurrentFile() {
      if (activeFileIndex < 0 || !openFiles[activeFileIndex]) return;
      const file = openFiles[activeFileIndex];
      const runner = getRunnerForFile(file.path);
      if (!runner) {
        alert('No runner configured for this file type');
        return;
      }
      // Save first if modified
      if (file.modified) {
        await saveCurrentFile();
      }
      const command = runner(file.path);
      const fileCwd = file.path.substring(0, file.path.lastIndexOf('/'));
      createTerminal(null, fileCwd);
      // Wait briefly for the terminal to initialize, then write command
      setTimeout(() => {
        const t = terminals[terminals.length - 1];
        if (t) window.api.terminal.write(t.id, command + '\n');
      }, 300);
    }

    function runTask(command) {
      createTerminal(null, currentPath || null);
      setTimeout(() => {
        const t = terminals[terminals.length - 1];
        if (t) window.api.terminal.write(t.id, command + '\n');
      }, 300);
    }

    function runCustomCommand() {
      const input = document.getElementById('runner-custom-cmd');
      const cmd = input.value.trim();
      if (!cmd) return;
      addRecentCommand(cmd);
      runTask(cmd);
      input.value = '';
    }

    async function detectProjectTasks() {
      const listEl = document.getElementById('runner-tasks-list');
      if (!currentPath) {
        listEl.innerHTML = '<div class="runner-empty">Open a project folder to detect tasks</div>';
        return;
      }
      listEl.innerHTML = '<div class="runner-empty">Detecting tasks...</div>';
      try {
        const result = await window.api.runner.detectTasks(currentPath);
        if (!result.tasks || result.tasks.length === 0) {
          listEl.innerHTML = '<div class="runner-empty">No tasks detected in this project</div>';
          return;
        }
        let html = '';
        let currentCategory = '';
        for (const task of result.tasks) {
          if (task.category && task.category !== currentCategory) {
            currentCategory = task.category;
            html += `<div class="runner-task-category">${task.category}</div>`;
          }
          const detail = task.detail ? ` title="${task.detail.replace(/"/g, '&quot;')}"` : '';
          html += `<div class="runner-task-item"${detail} onclick="runTask('${task.command.replace(/'/g, "\\'")}')">
            <span style="color:#4ec94e;margin-right:6px;">▶</span>${task.name}
          </div>`;
        }
        listEl.innerHTML = html;
      } catch (e) {
        listEl.innerHTML = '<div class="runner-empty">Error detecting tasks</div>';
      }
    }

    function refreshRunner() {
      // Update "Run Current File" button state
      const btn = document.getElementById('runner-run-file-btn');
      const info = document.getElementById('runner-file-info');
      if (activeFileIndex >= 0 && openFiles[activeFileIndex]) {
        const file = openFiles[activeFileIndex];
        const fileName = file.path.split('/').pop();
        const runner = getRunnerForFile(file.path);
        if (runner) {
          btn.disabled = false;
          const ext = '.' + file.path.split('.').pop();
          const runtimeName = {
            '.js': 'node', '.mjs': 'node', '.cjs': 'node',
            '.ts': 'tsx', '.tsx': 'tsx',
            '.py': 'python', '.rb': 'ruby', '.go': 'go',
            '.rs': 'cargo', '.ps1': 'powershell', '.bat': 'cmd', '.cmd': 'cmd',
            '.php': 'php',
            '.c': 'gcc', '.cpp': 'g++', '.java': 'javac',
            '.pl': 'perl', '.lua': 'lua', '.r': 'Rscript', '.R': 'Rscript'
          }[ext] || 'unknown';
          info.textContent = `${fileName} (${runtimeName})`;
        } else {
          btn.disabled = true;
          info.textContent = `${fileName} — no runner for this type`;
        }
      } else {
        btn.disabled = true;
        info.textContent = 'No file open in editor';
      }
      // Detect project tasks
      detectProjectTasks();
      // Setup autocomplete for Quick Run
      setupRunnerAutocomplete();
    }

    // Shortcut action handlers
    const SHORTCUT_ACTIONS = {
      'run-file':            () => { runCurrentFile(); return true; },
      'save-file':           () => { saveCurrentFile(); return true; },
      'new-terminal':        () => { createTerminal(); return true; },
      'close-tab':           () => { if (activeFileIndex >= 0) closeEditorTab(activeFileIndex, { stopPropagation: () => {} }); return true; },
      'toggle-sidebar':      () => { toggleLeftPanel(); return true; },
      'swap-panels':         () => { swapPanelSizes(); return true; },
      'focus-mode':          () => { toggleFocusMode(); return true; },
      'split-vertical':      () => { splitTerminal('vertical'); return true; },
      'split-horizontal':    () => { splitTerminal('horizontal'); return true; },
      'settings':            () => { showSettings(); return true; },
      'shortcuts':           () => { showShortcuts(); return true; },
      'command-palette':     () => { showCommandPalette(); return true; },
      'command-palette-alt': () => { showCommandPalette(); return true; },
      'terminal-search':     () => {
        const t = terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
        if (t && document.activeElement?.closest('#terminal-container')) { openTerminalSearch(); return true; }
        return false;
      },
      'terminal-line-start': () => {
        const t = terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
        if (t) { window.api.terminal.write(t.id, '\x01'); return true; }
        return false;
      },
      'terminal-line-end':   () => {
        const t = terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
        if (t) { window.api.terminal.write(t.id, '\x05'); return true; }
        return false;
      },
      'terminal-word-back':  () => {
        const t = terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
        if (t) { window.api.terminal.write(t.id, '\x1bb'); return true; }
        return false;
      },
      'terminal-word-forward': () => {
        const t = terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
        if (t) { window.api.terminal.write(t.id, '\x1bf'); return true; }
        return false;
      },
      'panel-set-width': () => {
        const panel = document.getElementById('left-panel');
        const resizer = document.getElementById('left-resizer');
        const appContainer = document.getElementById('app-container');
        const pct = settings.panelWidthPercent || 40;
        const targetW = Math.round(appContainer.offsetWidth * (pct / 100));
        panel.classList.remove('collapsed');
        panel.style.width = targetW + 'px';
        leftPanelWidth = targetW;
        resizer.style.display = '';
        updateToggleIcons();
        setTimeout(() => {
          terminals.forEach(t => t.fitAddon.fit());
          if (monacoEditor) monacoEditor.layout();
        }, 250);
        return true;
      },
      'panel-close': () => {
        const panel = document.getElementById('left-panel');
        if (!panel.classList.contains('collapsed')) {
          leftPanelWidth = panel.offsetWidth;
          panel.classList.add('collapsed');
          document.getElementById('left-resizer').style.display = 'none';
          updateToggleIcons();
          setTimeout(() => terminals.forEach(t => t.fitAddon.fit()), 250);
        }
        return true;
      },
    };

    // Keyboard shortcuts (data-driven)
    document.addEventListener('keydown', (e) => {
      // Escape is not remappable
      if (e.key === 'Escape') {
        closeSettings();
        closeShortcuts();
        closeFilePreview();
        closeTerminalSearch();
        return;
      }

      // If shortcut recorder is active, capture the combo
      if (shortcutRecorderActive) {
        captureShortcutCombo(e);
        return;
      }

      const shortcuts = getShortcuts();
      const metaPressed = e.metaKey || e.ctrlKey;

      for (const [id, sc] of Object.entries(shortcuts)) {
        const metaMatch = sc.meta ? metaPressed : !metaPressed;
        const shiftMatch = sc.shift === e.shiftKey;
        const altMatch = sc.alt === e.altKey;
        const keyMatch = e.key.toLowerCase() === sc.key.toLowerCase();

        if (metaMatch && shiftMatch && altMatch && keyMatch) {
          const handler = SHORTCUT_ACTIONS[id];
          if (handler) {
            const handled = handler();
            if (handled) {
              e.preventDefault();
              return;
            }
          }
        }
      }
    });

    // File manager keyboard shortcuts
    document.getElementById('file-list').addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'c') {
        copyFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'x') {
        cutFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'v') {
        pasteFile();
      }
    });

    // ============ Cloud Sync ============
    let cloudAccount = null;

    function showWelcomeError(msg) {
      const el = document.getElementById('welcome-error');
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
    }

    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'none';
      showWelcomeError('');
    }

    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('welcome-logged-in').style.display = 'none';
      showWelcomeError('');
    }

    function showLoggedInView(username) {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'block';
      document.getElementById('payment-required').style.display = 'none';
      document.getElementById('payment-view').style.display = 'none';
      document.getElementById('welcome-username').textContent = username;
      showWelcomeError('');
    }

    function showPaymentRequired(msg) {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'none';
      document.getElementById('payment-required').style.display = 'block';
      document.getElementById('payment-view').style.display = 'none';
      if (msg) document.getElementById('payment-msg').textContent = msg;
      showWelcomeError('');
    }

    function showPaymentView() {
      if (!pendingPaymentUrl) return;
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'none';
      document.getElementById('payment-required').style.display = 'none';
      document.getElementById('payment-view').style.display = 'block';
      const wv = document.getElementById('payment-webview');
      if (wv.src !== pendingPaymentUrl) wv.src = pendingPaymentUrl;
    }

    function hidePaymentView() {
      document.getElementById('payment-view').style.display = 'none';
      if (cloudAccount && cloudAccount.user) {
        showLoggedInView(cloudAccount.user.username);
      } else {
        showLoginForm();
      }
    }

    // Track payment URL and trial info
    var pendingPaymentUrl = null;

    function handlePaymentResponse(result) {
      if (result.payment_required) {
        pendingPaymentUrl = result.payment_url || null;
        if (result.trial_expired) {
          showPaymentRequired('Your free trial has expired. Please purchase to continue using dTerm.');
        } else {
          showPaymentRequired('Payment is required to use dTerm.');
        }
        return true;
      }
      if (result.trial) {
        pendingPaymentUrl = result.payment_url || null;
        var notice = document.getElementById('trial-notice');
        var noticeText = document.getElementById('trial-notice-text');
        var days = result.trial_days_remaining || 0;
        noticeText.textContent = 'Free trial: ' + days + ' day' + (days !== 1 ? 's' : '') + ' remaining.';
        notice.style.display = 'block';
        return false;
      }
      document.getElementById('trial-notice').style.display = 'none';
      pendingPaymentUrl = null;
      return false;
    }

    // Listen for payment completion from webview
    (function() {
      var wv = document.getElementById('payment-webview');
      if (wv) {
        wv.addEventListener('did-navigate', function(e) {
          if (e.url && e.url.indexOf('dterm-pay-success') !== -1) {
            // Payment completed - re-validate account
            setTimeout(async function() {
              try {
                var result = await window.api.cloud.validate();
                if (result.success && !result.payment_required) {
                  pendingPaymentUrl = null;
                  showLoggedInView(result.user.username);
                  document.getElementById('trial-notice').style.display = 'none';
                }
              } catch (e) {}
            }, 2000);
          }
        });
      }
    })();

    function dismissWelcome() {
      document.getElementById('welcome-overlay').classList.add('hidden');
      // Re-focus the active terminal after overlay is dismissed
      const termData = terminals.find(t => t.id === activePaneId);
      if (termData) {
        termData.fitAddon.fit();
        termData.term.focus();
      }
    }

    async function cloudLogin() {
      const username = document.getElementById('cloud-username').value.trim();
      const password = document.getElementById('cloud-password').value;
      if (!username || !password) { showWelcomeError('Enter username and password'); return; }
      showWelcomeError('');
      try {
        const result = await window.api.cloud.login(username, password);
        if (result.success) {
          cloudAccount = { token: result.token, user: result.user };
          updateCloudBadge();
          // Check if payment is required
          if (handlePaymentResponse(result)) {
            return; // Payment screen shown
          }
          showLoggedInView(result.user.username);
          await pullCloudData();
        } else {
          showWelcomeError(result.error || 'Login failed');
        }
      } catch (e) { showWelcomeError('Connection error'); }
    }

    async function cloudRegister() {
      const username = document.getElementById('reg-username').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      if (!username || !email || !password) { showWelcomeError('All fields are required'); return; }
      showWelcomeError('');
      try {
        const result = await window.api.cloud.register(username, email, password);
        if (result.success) {
          cloudAccount = { token: result.token, user: result.user };
          updateCloudBadge();
          // Check if payment is required
          if (handlePaymentResponse(result)) {
            return; // Payment screen shown
          }
          showLoggedInView(result.user.username);
        } else {
          showWelcomeError(result.error || 'Registration failed');
        }
      } catch (e) { showWelcomeError('Connection error'); }
    }

    async function cloudLogout() {
      await window.api.cloud.logout();
      cloudAccount = null;
      updateCloudBadge();
      showLoginForm();
      document.getElementById('welcome-overlay').classList.remove('hidden');
    }

    function updateCloudBadge() {
      const badge = document.getElementById('cloud-badge');
      const text = document.getElementById('cloud-badge-text');
      const syncBtn = document.getElementById('cloud-sync-btn');
      badge.style.display = 'flex';
      if (cloudAccount && cloudAccount.user) {
        text.textContent = cloudAccount.user.username;
        syncBtn.style.display = '';
        startAutoSync();
        // Pre-fill collab display name
        const collabNameInput = document.getElementById('collab-display-name');
        if (collabNameInput && !collabNameInput.value) collabNameInput.value = cloudAccount.user.username;
      } else {
        text.textContent = 'Not signed in';
        syncBtn.style.display = 'none';
        stopAutoSync();
      }
      updateUserAvatar();
    }

    function updateUserAvatar() {
      const avatarImg = document.getElementById('user-avatar');
      const avatarInitials = document.getElementById('user-avatar-initials');
      if (cloudAccount && cloudAccount.user) {
        const photoUrl = cloudAccount.user.profile_photo_url;
        if (photoUrl) {
          avatarImg.src = photoUrl;
          avatarImg.style.display = 'block';
          avatarInitials.style.display = 'none';
        } else {
          avatarImg.style.display = 'none';
          avatarInitials.textContent = cloudAccount.user.username.charAt(0).toUpperCase();
          avatarInitials.style.display = 'flex';
        }
      } else {
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'none';
      }
    }

    async function uploadProfilePhoto(input) {
      const file = input.files[0];
      if (!file) return;
      const status = document.getElementById('photo-upload-status');
      status.textContent = 'Uploading...';
      status.style.color = '#d1d5db';

      const reader = new FileReader();
      reader.onload = async function() {
        try {
          const base64 = reader.result.split(',')[1];
          const result = await window.api.cloud.uploadPhoto(base64);
          if (result.error) {
            status.textContent = result.error;
            status.style.color = '#f85149';
            return;
          }
          status.textContent = 'Photo updated!';
          status.style.color = '#3fb950';
          // Update local account
          if (cloudAccount && cloudAccount.user) {
            cloudAccount.user.profile_photo_url = result.profile_photo_url;
          }
          updateUserAvatar();
          updateSettingsPhoto();
          setTimeout(() => { status.textContent = ''; }, 3000);
        } catch (e) {
          status.textContent = 'Upload failed.';
          status.style.color = '#f85149';
        }
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function updateSettingsPhoto() {
      const section = document.getElementById('settings-photo-section');
      const preview = document.getElementById('settings-photo-preview');
      const initials = document.getElementById('settings-photo-initials');
      if (!cloudAccount || !cloudAccount.user) {
        section.style.display = 'none';
        return;
      }
      section.style.display = 'flex';
      const photoUrl = cloudAccount.user.profile_photo_url;
      if (photoUrl) {
        preview.src = photoUrl;
        preview.style.display = 'block';
        initials.style.display = 'none';
      } else {
        preview.style.display = 'none';
        initials.textContent = cloudAccount.user.username.charAt(0).toUpperCase();
        initials.style.display = 'flex';
      }
    }

    function showCloudMenu() {
      if (cloudAccount && cloudAccount.user) {
        if (confirm('Sign out of cloud account?')) {
          cloudLogout();
        }
      } else {
        document.getElementById('welcome-overlay').classList.remove('hidden');
        showLoginForm();
      }
    }

    async function pullCloudData() {
      if (!cloudAccount) return;
      try {
        const result = await window.api.cloud.pullAll();
        if (result.success && result.data) {
          if (result.data.settings && result.data.settings.data_json) {
            localStorage.setItem('dterm-settings', result.data.settings.data_json);
            loadSettings();
          }
          if (result.data.bookmarks && result.data.bookmarks.data_json) {
            localStorage.setItem('dterm-bookmarks', result.data.bookmarks.data_json);
            loadBookmarks();
          }
          if (result.data.recent_folders && result.data.recent_folders.data_json) {
            localStorage.setItem('dterm-recent-folders', result.data.recent_folders.data_json);
          }
          if (result.data.recent_files && result.data.recent_files.data_json) {
            localStorage.setItem('dterm-recent-files', result.data.recent_files.data_json);
          }
          if (result.data.notes && result.data.notes.data_json) {
            await window.api.notes.save(JSON.parse(result.data.notes.data_json));
            initNotes();
          }
          if (result.data.ftp_connections && result.data.ftp_connections.data_json) {
            await window.api.ftpConnections.save(JSON.parse(result.data.ftp_connections.data_json));
          }
          if (result.data.file_bookmarks && result.data.file_bookmarks.data_json) {
            localStorage.setItem('dterm-file-bookmarks', result.data.file_bookmarks.data_json);
          }
          if (result.data.recent_commands && result.data.recent_commands.data_json) {
            localStorage.setItem('dterm-recent-commands', result.data.recent_commands.data_json);
          }
          if (result.data.snippets && result.data.snippets.data_json) {
            await window.api.snippets.save(JSON.parse(result.data.snippets.data_json));
          }
          if (result.data.ssh_connections && result.data.ssh_connections.data_json) {
            await window.api.sshConnections.save(JSON.parse(result.data.ssh_connections.data_json));
          }
          if (result.data.workspaces && result.data.workspaces.data_json) {
            const cloudWorkspaces = JSON.parse(result.data.workspaces.data_json);
            for (const ws of cloudWorkspaces) {
              await window.api.workspaces.save(ws.name, ws.data);
            }
          }
          if (result.data.session && result.data.session.data_json) {
            await window.api.session.save(JSON.parse(result.data.session.data_json));
          }
        }
      } catch (e) { console.error('Pull failed:', e); }
    }

    async function pushCloudData() {
      if (!cloudAccount) return;
      const syncIcon = document.querySelector('#cloud-badge .sync-icon');
      if (syncIcon) syncIcon.classList.add('syncing');
      try {
        // Push localStorage items
        const settings = localStorage.getItem('dterm-settings');
        if (settings) await window.api.cloud.push('settings', settings);

        const bookmarks = localStorage.getItem('dterm-bookmarks');
        if (bookmarks) await window.api.cloud.push('bookmarks', bookmarks);

        const recentFolders = localStorage.getItem('dterm-recent-folders');
        if (recentFolders) await window.api.cloud.push('recent_folders', recentFolders);

        const recentFiles = localStorage.getItem('dterm-recent-files');
        if (recentFiles) await window.api.cloud.push('recent_files', recentFiles);

        const fileBookmarks = localStorage.getItem('dterm-file-bookmarks');
        if (fileBookmarks) await window.api.cloud.push('file_bookmarks', fileBookmarks);

        const recentCommands = localStorage.getItem('dterm-recent-commands');
        if (recentCommands) await window.api.cloud.push('recent_commands', recentCommands);

        // Push file-based items
        const notes = await window.api.notes.load();
        await window.api.cloud.push('notes', JSON.stringify(notes));

        const ftpConns = await window.api.ftpConnections.load();
        await window.api.cloud.push('ftp_connections', JSON.stringify(ftpConns));

        const snippets = await window.api.snippets.load();
        await window.api.cloud.push('snippets', JSON.stringify(snippets));

        const sshConns = await window.api.sshConnections.load();
        await window.api.cloud.push('ssh_connections', JSON.stringify(sshConns));

        const workspaces = await window.api.workspaces.list();
        await window.api.cloud.push('workspaces', JSON.stringify(workspaces));

        // Push session state
        const session = await window.api.session.load();
        if (session) await window.api.cloud.push('session', JSON.stringify(session));
      } catch (e) { console.error('Push failed:', e); }
      if (syncIcon) syncIcon.classList.remove('syncing');
    }

    async function checkCloudAccount() {
      try {
        const account = await window.api.cloud.getAccount();
        if (account && account.token) {
          const validation = await window.api.cloud.validate();
          if (validation.success) {
            cloudAccount = account;
            if (validation.user) cloudAccount.user = validation.user;
            updateCloudBadge();
            // Check payment status
            if (handlePaymentResponse(validation)) {
              return 'payment_required';
            }
            await pullCloudData();
            return true;
          }
        }
      } catch (e) {}
      return false;
    }

    async function showWelcomeScreen() {
      let welcomeEnabled = false;
      try {
        const welcome = await window.api.cloud.getWelcome();
        welcomeEnabled = welcome.welcome_enabled === true || welcome.welcome_enabled === '1' || welcome.welcome_enabled === 1;
        // Show welcome message on login screen
        if (welcomeEnabled && welcome.welcome_message) {
          document.getElementById('welcome-msg').innerHTML = welcome.welcome_message;
          // Intercept links in welcome message to open externally with auto-login
          document.getElementById('welcome-msg').addEventListener('click', async (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            const href = link.getAttribute('href');
            if (!href || !href.startsWith('http')) return;
            e.preventDefault();
            e.stopPropagation();
            let url = href;
            // If link goes to mynetworktools.com and user is logged in, auto-login
            if (url.includes('mynetworktools.com')) {
              let token = cloudAccount && cloudAccount.token ? cloudAccount.token : null;
              if (!token) {
                try { const acct = await window.api.cloud.getAccount(); if (acct) token = acct.token; } catch(e) {}
              }
              if (token) {
                const redirectPath = url.replace(/^https?:\/\/[^/]+/, '');
                url = 'https://mynetworktools.com/dterm/auto-login.php?token=' + encodeURIComponent(token) + '&redirect=' + encodeURIComponent(redirectPath);
              }
            }
            if (window.api.openExternal) {
              window.api.openExternal(url);
            }
          });
        }
        if (welcome.logged_in && welcome.user) {
          cloudAccount = { user: welcome.user };
          const localAccount = await window.api.cloud.getAccount();
          if (localAccount) cloudAccount = localAccount;
          updateCloudBadge();
          // Validate to check payment status
          try {
            const validation = await window.api.cloud.validate();
            if (validation.success) {
              if (validation.user) cloudAccount.user = validation.user;
              if (handlePaymentResponse(validation)) {
                // Payment required - screen already shown
              } else {
                showLoggedInView(cloudAccount.user.username);
                await pullCloudData();
              }
            } else {
              showLoggedInView(welcome.user.username);
            }
          } catch (e) {
            showLoggedInView(welcome.user.username);
          }
        }
      } catch (e) {}

      // If not logged in from server response, check local account
      if (!cloudAccount) {
        const accountResult = await checkCloudAccount();
        if (accountResult === 'payment_required') {
          // Payment screen already shown by handlePaymentResponse
        } else if (accountResult) {
          showLoggedInView(cloudAccount.user.username);
        } else {
          showLoginForm();
        }
      }

      // Always show the welcome/login overlay on startup
      document.getElementById('welcome-overlay').classList.remove('hidden');
      updateCloudBadge();
    }

    // Manual sync button
    async function manualSync() {
      if (!cloudAccount) return;
      const btn = document.getElementById('cloud-sync-btn');
      btn.disabled = true;
      btn.textContent = '⟳ Syncing...';
      try {
        await pushCloudData();
        await pullCloudData();
        btn.textContent = '⟳ Synced!';
        setTimeout(() => { btn.textContent = '⟳ Sync'; }, 2000);
      } catch (e) {
        btn.textContent = '⟳ Failed';
        setTimeout(() => { btn.textContent = '⟳ Sync'; }, 2000);
      }
      btn.disabled = false;
    }

    // Auto-sync every 10 seconds
    let cloudSyncInterval = null;
    function startAutoSync() {
      stopAutoSync();
      cloudSyncInterval = setInterval(() => {
        if (cloudAccount) pushCloudData();
      }, 10 * 1000);
    }

    // Push to cloud whenever session saves (piggyback on the 30s session save)
    let lastPushTime = 0;
    function syncNow() {
      if (!cloudAccount) return;
      const now = Date.now();
      if (now - lastPushTime < 5000) return; // debounce 5s
      lastPushTime = now;
      pushCloudData();
    }
    function stopAutoSync() {
      if (cloudSyncInterval) { clearInterval(cloudSyncInterval); cloudSyncInterval = null; }
    }

    // Session save/restore
    async function saveSession() {
      try {
        // Gather terminal data
        const terminalData = [];
        for (const t of terminals) {
          const cwd = await window.api.terminal.getCwd(t.id);
          const shellName = t.name;
          // Resolve shell path from name
          const shellPath = shellName === 'powershell' ? 'powershell.exe' : shellName === 'cmd' ? 'cmd.exe' : settings.shell || defaultShell;
          // Serialize terminal buffer content (with ANSI escape codes for colors/formatting)
          let buffer = '';
          try {
            if (t.serializeAddon) {
              buffer = t.serializeAddon.serialize();
            }
          } catch (e) {
            console.warn('Could not serialize terminal buffer:', e);
          }
          terminalData.push({ shell: shellPath, cwd: cwd || null, name: shellName, buffer: buffer });
        }

        // Gather open editor files with cursor/scroll state
        const editorData = openFiles.filter(f => !f.ftpFile).map((f, i) => {
          const fileData = { path: f.path, name: f.name, modified: f.modified || false };
          // Save unsaved content if modified
          if (f.modified && f.content) {
            fileData.unsavedContent = f.content;
          }
          // Save cursor and scroll position for active file
          if (i === activeFileIndex && monacoEditor) {
            const pos = monacoEditor.getPosition();
            const scroll = monacoEditor.getScrollTop();
            if (pos) fileData.cursorLine = pos.lineNumber;
            if (pos) fileData.cursorColumn = pos.column;
            fileData.scrollTop = scroll;
          }
          return fileData;
        });

        // Save left terminal state
        const leftTermState = leftTerminalData ? {
          exists: true,
          cwd: await window.api.terminal.getCwd(leftTerminalData.id).catch(() => null)
        } : null;

        // Get browser tabs
        const browserTabData = browserTabs.map(t => ({
          url: t.url || (t.webview ? t.webview.getURL() : '') || ''
        }));
        const activeBrowserTabIndex = browserTabs.findIndex(t => t.id === activeBrowserTabId);
        const browserUrl = getActiveWebview() ? getActiveWebview().getURL() : null;

        // Get active browser device tab
        const activeDeviceTab = document.querySelector('.device-tab.active');
        const browserDevice = activeDeviceTab ? activeDeviceTab.dataset.device : 'desktop';

        // Get editor area height ratio
        const editorArea = document.getElementById('editor-area');
        const mainArea = document.getElementById('main-area');
        const editorRatio = (editorArea && mainArea && editorArea.classList.contains('visible'))
          ? editorArea.offsetHeight / mainArea.offsetHeight : null;

        // Get showHidden state
        const hiddenState = typeof showHidden !== 'undefined' ? showHidden : false;

        const session = {
          terminals: terminalData,
          editorFiles: editorData,
          activeFileIndex: activeFileIndex,
          browserUrl: browserUrl,
          browserTabs: browserTabData,
          activeBrowserTabIndex: activeBrowserTabIndex,
          browserDevice: browserDevice,
          fileBrowserPath: currentPath,
          leftPanelCollapsed: document.getElementById('left-panel').classList.contains('collapsed'),
          leftPanelWidth: leftPanelWidth || document.getElementById('left-panel').offsetWidth || 500,
          activeLeftTab: activeLeftTab,
          editorHeightRatio: editorRatio,
          showHidden: hiddenState,
          // FTP state
          appMode: appMode,
          ftpRemoteHost: ftpRemoteHost,
          ftpCurrentPath: ftpCurrentPath,
          ftpConnected: ftpConnected,
          // Left terminal
          leftTerminal: leftTermState,
          // Active tool in tools panel
          activeToolName: activeToolName,
          // Markdown preview state
          mdPreviewActive: mdPreviewActive,
          // Selected file path
          selectedFilePath: selectedFile ? selectedFile.path : null,
          // Editor visible state
          editorVisible: document.getElementById('editor-area').classList.contains('visible')
        };

        await window.api.session.save(session);
        // Also push to cloud
        syncNow();
        // Update last sync time in status bar
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const el = document.getElementById('session-sync-time');
        if (el) el.textContent = 'Synced ' + timeStr;
      } catch (e) {
        console.error('Failed to save session:', e);
      }
    }

    async function restoreSession() {
      try {
        const session = await window.api.session.load();
        if (!session) return;

        // Restore file browser path
        if (session.fileBrowserPath) {
          currentPath = session.fileBrowserPath;
          loadFiles();
        }

        // Restore terminal tabs
        if (session.terminals && session.terminals.length > 0) {
          for (const t of session.terminals) {
            createTerminal(t.shell, t.cwd);
            // Write saved buffer content back into the terminal
            if (t.buffer) {
              const termData = terminals[terminals.length - 1];
              if (termData && termData.term) {
                termData.term.write(t.buffer);
              }
            }
          }
        }

        // Restore editor files
        if (session.editorFiles && session.editorFiles.length > 0) {
          for (const f of session.editorFiles) {
            try {
              await openFileInEditor({ path: f.path, name: f.name, isFile: true });
              // Restore unsaved content if file was modified
              const idx = openFiles.length - 1;
              if (f.unsavedContent && idx >= 0) {
                openFiles[idx].content = f.unsavedContent;
                openFiles[idx].modified = true;
              }
            } catch (e) {
              console.warn('Could not restore file:', f.path, e);
            }
          }
          // Activate the previously active file and restore cursor
          if (session.activeFileIndex >= 0 && session.activeFileIndex < openFiles.length) {
            activateFile(session.activeFileIndex);
            const af = session.editorFiles[session.activeFileIndex];
            if (af && monacoEditor) {
              // Restore unsaved content for active file
              if (af.unsavedContent) {
                monacoEditor.setValue(af.unsavedContent);
                openFiles[session.activeFileIndex].modified = true;
                // Mark tab as modified
                const tabEl = document.querySelector(`#editor-tabs .tab:nth-child(${session.activeFileIndex + 1})`);
                if (tabEl) tabEl.classList.add('modified');
              }
              // Restore cursor position
              if (af.cursorLine) {
                monacoEditor.setPosition({ lineNumber: af.cursorLine, column: af.cursorColumn || 1 });
                monacoEditor.revealLineInCenter(af.cursorLine);
              }
              // Restore scroll position
              if (af.scrollTop) {
                setTimeout(() => monacoEditor.setScrollTop(af.scrollTop), 100);
              }
            }
          }
        }

        // Restore browser URL
        // Browser tabs restored by browser init IIFE

        // Restore browser device mode
        if (session.browserDevice && session.browserDevice !== 'desktop') {
          setBrowserDevice(session.browserDevice);
        }

        // Restore showHidden state
        if (session.showHidden) {
          showHidden = true;
          const btn = document.getElementById('hidden-toggle');
          if (btn) btn.classList.add('active');
          loadFiles();
        }

        // Restore panel width and collapsed state
        if (session.leftPanelWidth) {
          leftPanelWidth = Math.max(session.leftPanelWidth, 500);
          document.getElementById('left-panel').style.width = leftPanelWidth + 'px';
        }
        if (session.leftPanelCollapsed) {
          toggleLeftPanel();
        }
        // Restore active left tab (handles legacy activeRightTab too)
        if (session.activeLeftTab) {
          showLeftTab(session.activeLeftTab);
        } else if (session.activeRightTab) {
          showLeftTab(session.activeRightTab);
        }

        // Restore FTP state
        if (session.appMode === 'ftp' && session.ftpRemoteHost) {
          appMode = 'ftp';
          ftpRemoteHost = session.ftpRemoteHost;
          ftpCurrentPath = session.ftpCurrentPath || '/';
          // Note: FTP connection itself can't persist — user must reconnect
          // But we restore the mode and path so they know where they were
          const badge = document.getElementById('ftp-mode-badge');
          if (badge) badge.classList.add('visible');
        }

        // Restore left terminal
        if (session.leftTerminal && session.leftTerminal.exists && typeof createLeftTerminal === 'function') {
          createLeftTerminal();
        }

        // Restore active tool
        if (session.activeToolName && typeof showTool === 'function') {
          try { showTool(session.activeToolName); } catch (e) {}
        }

        // Restore markdown preview state
        if (session.mdPreviewActive) {
          mdPreviewActive = true;
          const toggleBtn = document.getElementById('md-preview-toggle');
          if (toggleBtn) toggleBtn.classList.add('active');
          const previewContainer = document.getElementById('md-preview-container');
          if (previewContainer) previewContainer.classList.add('visible');
        }

        // Restore editor height ratio
        if (session.editorHeightRatio && session.editorVisible) {
          const editorArea = document.getElementById('editor-area');
          const mainArea = document.getElementById('main-area');
          if (editorArea && mainArea) {
            editorArea.style.flex = '0 0 ' + Math.round(session.editorHeightRatio * 100) + '%';
          }
        }
      } catch (e) {
        console.error('Failed to restore session:', e);
      }
    }

    // ==========================================
    // CONTACT / MESSAGES
    // ==========================================

    function showContact() {
      if (!cloudAccount || !cloudAccount.user) {
        alert('Please sign in to send a message.');
        return;
      }
      document.getElementById('contact-from').value = cloudAccount.user.username;
      document.getElementById('contact-message').value = '';
      document.getElementById('contact-sent').style.display = 'none';
      document.getElementById('contact-error').style.display = 'none';
      document.getElementById('contact-overlay').style.display = 'flex';
      clearNotifBadge();
      loadMyMessages();
    }

    function closeContact() {
      document.getElementById('contact-overlay').style.display = 'none';
    }

    async function sendContactMessage() {
      const subject = document.getElementById('contact-subject').value;
      const message = document.getElementById('contact-message').value.trim();
      if (!message) {
        document.getElementById('contact-error').textContent = 'Please enter a message.';
        document.getElementById('contact-error').style.display = 'block';
        return;
      }

      const account = await window.api.cloud.getAccount();
      if (!account || !account.token) { alert('Not signed in.'); return; }

      try {
        const result = await window.api.messages.request('send_message', {
          token: account.token,
          subject: subject,
          message: message
        });
        if (result.error) {
          document.getElementById('contact-error').textContent = result.error;
          document.getElementById('contact-error').style.display = 'block';
          return;
        }
        document.getElementById('contact-sent').textContent = 'Message sent!';
        document.getElementById('contact-sent').style.display = 'block';
        document.getElementById('contact-error').style.display = 'none';
        document.getElementById('contact-message').value = '';
        loadMyMessages();
      } catch (e) {
        document.getElementById('contact-error').textContent = 'Failed to send: ' + e.message;
        document.getElementById('contact-error').style.display = 'block';
      }
    }

    async function loadMyMessages() {
      const account = await window.api.cloud.getAccount();
      if (!account || !account.token) return;

      try {
        const result = await window.api.messages.request('get_my_messages', { token: account.token });
        const list = document.getElementById('my-messages-list');
        if (!result.success || !result.messages || result.messages.length === 0) {
          list.innerHTML = '<div style="color:#6e7681; font-size:11px; text-align:center; padding:12px;">No messages yet.</div>';
          return;
        }
        list.innerHTML = result.messages.map(m => {
          const date = new Date(m.created_at).toLocaleDateString();
          const subjectText = m.subject.replace(/\[dTerm (Bug|Idea)\].*/, '$1');
          const isBug = m.subject.includes('Bug');
          const badge = isBug
            ? '<span style="color:#f85149; font-weight:600;">Bug</span>'
            : '<span style="color:#58a6ff; font-weight:600;">Idea</span>';
          let reply = '';
          if (m.admin_replies) {
            const replies = m.admin_replies.split('|||');
            reply = replies.map(r => `<div class="msg-reply"><div class="msg-reply-label">Admin Reply</div>${escapeHtml(r)}</div>`).join('');
          }
          return `<div class="my-msg-item">
            <div class="msg-header"><span class="msg-subject">${badge}</span><span class="msg-date">${date}</span></div>
            <div class="msg-body">${escapeHtml(m.body.substring(0, 150))}${m.body.length > 150 ? '...' : ''}</div>
            ${reply}
          </div>`;
        }).join('');
      } catch (e) { /* ignore */ }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Notification checking
    async function checkForReplies() {
      if (!cloudAccount || !cloudAccount.user) return;
      const account = await window.api.cloud.getAccount();
      if (!account || !account.token) return;

      try {
        const result = await window.api.messages.request('check_replies', { token: account.token });
        if (result.success && result.replies && result.replies.length > 0) {
          // Show notification badge
          const badge = document.getElementById('notif-count');
          const bellEl = document.getElementById('notif-badge');
          badge.textContent = result.replies.length;
          badge.classList.add('visible');
          bellEl.classList.add('has-notif');

          // Show toast for the most recent reply
          const latest = result.replies[0];
          const replyPreview = latest.body.substring(0, 100) + (latest.body.length > 100 ? '...' : '');
          showToast('New Reply', replyPreview);

          // Fire native OS notification (shows even when app is in background)
          const notifTitle = 'dTerm - New Reply';
          const notifBody = result.replies.length === 1
            ? replyPreview
            : result.replies.length + ' new replies';
          window.api.notify(notifTitle, notifBody);
        }
      } catch (e) { /* ignore */ }
    }

    function showToast(title, body) {
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-body').textContent = body;
      document.getElementById('notif-toast').classList.add('visible');
      setTimeout(() => { document.getElementById('notif-toast').classList.remove('visible'); }, 8000);
    }

    function dismissToast() {
      document.getElementById('notif-toast').classList.remove('visible');
    }

    function clearNotifBadge() {
      document.getElementById('notif-count').classList.remove('visible');
      document.getElementById('notif-badge').classList.remove('has-notif');
    }

    // Check for replies every 60 seconds
    setInterval(checkForReplies, 60000);
    // Also check on startup (after a delay to let cloud auth complete)
    setTimeout(checkForReplies, 10000);

    // ==========================================
    // AUTO-UPDATE
    // ==========================================

    // Set dynamic version from package.json
    api.appUpdate.getVersion().then(v => {
      const el = document.getElementById('about-version');
      if (el) el.textContent = 'Version ' + v;
      const tv = document.getElementById('title-version');
      if (tv) tv.textContent = 'v' + v;
    });

    // Listen for update status from main process
    api.appUpdate.onUpdateStatus((status, detail) => {
      const bar = document.getElementById('update-bar');
      const text = document.getElementById('update-bar-text');
      const btn = document.getElementById('update-bar-btn');
      if (status === 'downloading') {
        bar.classList.add('visible');
        text.textContent = 'Downloading update...';
        btn.style.display = 'none';
      } else if (status === 'ready') {
        bar.classList.add('visible');
        text.textContent = 'Update ready!';
        btn.style.display = '';
      } else if (status === 'error') {
        console.log('Update error:', detail);
      }
    });

    // FTP progress listener
    api.ftp.onProgress((info) => {
      const bar = document.getElementById('ftp-progress-bar');
      const fill = document.getElementById('ftp-progress-fill');
      if (info.bytesOverall > 0) {
        bar.style.display = 'block';
        // For indeterminate progress, pulse the bar
        fill.style.width = Math.min(100, (info.bytes / Math.max(info.bytesOverall, 1)) * 100) + '%';
      }
    });

    // Broadcast check — polls every 30s, shows modal when admin sends
    let _dismissedSentAt = '';  // tracks the sent_at we dismissed
    async function checkBroadcast() {
      try {
        const result = await api.cloud.getBroadcast();
        if (result && result.message && result.enabled && result.sent_at) {
          // Only show if this is a new send we haven't dismissed
          if (_dismissedSentAt === result.sent_at) return;
          document.getElementById('broadcast-text').textContent = result.message;
          document.getElementById('broadcast-overlay').dataset.sentAt = result.sent_at;
          document.getElementById('broadcast-overlay').style.display = 'flex';
        } else {
          // Broadcast disabled or no sent_at — hide and reset
          _dismissedSentAt = '';
          document.getElementById('broadcast-overlay').style.display = 'none';
        }
      } catch {}
    }
    function dismissBroadcast() {
      // Remember which send we dismissed by its timestamp
      _dismissedSentAt = document.getElementById('broadcast-overlay').dataset.sentAt || Date.now().toString();
      document.getElementById('broadcast-overlay').style.display = 'none';
    }
    // Initial check after 3s, then poll every 30s
    setTimeout(checkBroadcast, 3000);
    setInterval(checkBroadcast, 30000);

    // File watcher — auto-refresh file browser
    api.fs.onChange((dirPath, filename) => {
      if (dirPath === currentPath && appMode !== 'ftp') {
        loadFiles();
      }
    });

    // ==========================================
    // LASTPASS VAULT
    // ==========================================

    let vaultEntries = [];
    let vaultLoggedIn = false;

    async function vaultInit() {
      const installed = await window.api.vault.checkInstalled();
      if (!installed.installed) {
        document.getElementById('vault-not-installed').style.display = 'block';
        document.getElementById('vault-login').style.display = 'none';
        document.getElementById('vault-main').style.display = 'none';
        document.getElementById('vault-detail').style.display = 'none';
        return;
      }
      document.getElementById('vault-not-installed').style.display = 'none';
      const status = await window.api.vault.status();
      if (status.loggedIn) {
        vaultLoggedIn = true;
        document.getElementById('vault-login').style.display = 'none';
        document.getElementById('vault-main').style.display = 'flex';
        document.getElementById('vault-detail').style.display = 'none';
        document.getElementById('vault-user-email').textContent = status.email;
        vaultLoadEntries();
      } else {
        vaultLoggedIn = false;
        document.getElementById('vault-login').style.display = 'block';
        document.getElementById('vault-main').style.display = 'none';
        document.getElementById('vault-detail').style.display = 'none';
      }
    }

    async function vaultRefresh() {
      await vaultInit();
    }

    function vaultRunInTerminal(command) {
      createTerminal();
      // The newly created terminal is the last one in the array
      const termData = terminals[terminals.length - 1];
      if (termData) {
        setTimeout(() => {
          window.api.terminal.write(termData.id, command + '\n');
        }, 500);
      }
    }

    function vaultRunInstall() {
      vaultRunInTerminal('brew install lastpass-cli');
    }

    async function vaultLogin() {
      const email = document.getElementById('vault-email').value.trim();
      if (!email) return;
      const result = await window.api.vault.login(email);
      if (result.command) {
        vaultRunInTerminal(result.command);
        vaultSetStatus('Complete login in the terminal, then click ↻ to refresh.');
      }
    }

    async function vaultLogout() {
      await window.api.vault.logout();
      vaultLoggedIn = false;
      vaultEntries = [];
      document.getElementById('vault-main').style.display = 'none';
      document.getElementById('vault-detail').style.display = 'none';
      document.getElementById('vault-login').style.display = 'block';
    }

    async function vaultLoadEntries() {
      vaultSetStatus('Loading vault...');
      const result = await window.api.vault.list();
      if (result.error) {
        vaultSetStatus('Error: ' + result.error);
        return;
      }
      vaultEntries = result.entries || [];
      vaultSetStatus(vaultEntries.length + ' entries loaded');
      vaultRenderEntries(vaultEntries);
    }

    function vaultFilterEntries() {
      const q = document.getElementById('vault-search').value.toLowerCase().trim();
      if (!q) {
        vaultRenderEntries(vaultEntries);
        return;
      }
      const filtered = vaultEntries.filter(e =>
        (e.name && e.name.toLowerCase().includes(q)) ||
        (e.url && e.url.toLowerCase().includes(q)) ||
        (e.username && e.username.toLowerCase().includes(q)) ||
        (e.group && e.group.toLowerCase().includes(q))
      );
      vaultRenderEntries(filtered);
    }

    function vaultRenderEntries(entries) {
      const container = document.getElementById('vault-entries');
      if (!entries.length) {
        container.innerHTML = '<div style="padding:12px;font-size:11px;color:#6e7681;text-align:center;">No entries found</div>';
        return;
      }
      // Group by folder
      const groups = {};
      entries.forEach(e => {
        const g = e.group || 'None';
        if (!groups[g]) groups[g] = [];
        groups[g].push(e);
      });
      let html = '';
      for (const [group, items] of Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]))) {
        if (Object.keys(groups).length > 1) {
          html += `<div style="padding:4px 8px;font-size:10px;color:#8b949e;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">${group}</div>`;
        }
        items.forEach(e => {
          const displayUrl = e.url ? e.url.replace(/^https?:\/\//, '').replace(/\/$/, '') : '';
          html += `<div class="vault-entry" onclick="vaultShowEntry('${e.id}')" style="padding:6px 8px;cursor:pointer;border-bottom:1px solid #21262d;">
            <div style="font-size:12px;color:#d1d5db;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.name || 'Unnamed'}</div>
            <div style="font-size:10px;color:#6e7681;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.username || ''}${displayUrl ? ' · ' + displayUrl : ''}</div>
          </div>`;
        });
      }
      container.innerHTML = html;
    }

    async function vaultShowEntry(id) {
      document.getElementById('vault-main').style.display = 'none';
      document.getElementById('vault-detail').style.display = 'flex';
      document.getElementById('vault-detail-content').innerHTML = '<div style="padding:12px;font-size:11px;color:#8b949e;">Loading...</div>';

      const result = await window.api.vault.show(id);
      if (result.error) {
        document.getElementById('vault-detail-content').innerHTML = `<div style="padding:12px;font-size:11px;color:#f85149;">${result.error}</div>`;
        return;
      }
      const e = result.entry;
      document.getElementById('vault-detail-title').textContent = e.name || 'Entry';

      let html = '<div style="display:flex;flex-direction:column;gap:8px;">';

      const fields = [
        { label: 'Name', value: e.name },
        { label: 'Username', value: e.username, copyable: true },
        { label: 'URL', value: e.url },
        { label: 'Group', value: e.group || e.fullname },
        { label: 'Note', value: e.note, multiline: true }
      ];

      fields.forEach(f => {
        if (!f.value) return;
        html += `<div>
          <div style="font-size:10px;color:#8b949e;margin-bottom:2px;">${f.label}</div>
          <div style="font-size:12px;color:#d1d5db;${f.multiline ? 'white-space:pre-wrap;' : 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'}background:#0d1117;padding:4px 6px;border-radius:3px;border:1px solid #21262d;${f.copyable ? 'cursor:pointer;' : ''}" ${f.copyable ? `onclick="navigator.clipboard.writeText('${f.value.replace(/'/g, "\\'")}')"` : ''}>${f.value}</div>
        </div>`;
      });

      // Password field (hidden by default, with copy & show buttons)
      html += `<div>
        <div style="font-size:10px;color:#8b949e;margin-bottom:2px;">Password</div>
        <div style="display:flex;gap:4px;align-items:stretch;">
          <div id="vault-pw-display" style="flex:1;font-size:12px;color:#d1d5db;background:#0d1117;padding:4px 6px;border-radius:3px;border:1px solid #21262d;font-family:monospace;">••••••••</div>
          <button onclick="vaultShowPassword('${id}')" id="vault-pw-show-btn" style="background:#21262d;border:1px solid #30363d;color:#8b949e;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px;white-space:nowrap;">Show</button>
          <button onclick="vaultCopyPassword('${id}')" style="background:#21262d;border:1px solid #30363d;color:#8b949e;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px;white-space:nowrap;">Copy</button>
        </div>
      </div>`;

      // Auto-fill buttons
      html += `<div style="margin-top:8px;border-top:1px solid #30363d;padding-top:8px;">
        <div style="font-size:10px;color:#8b949e;margin-bottom:6px;">Auto-fill</div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button onclick="vaultFillFtp('${id}')" style="background:#21262d;border:1px solid #30363d;color:#58a6ff;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px;">Fill FTP</button>
          <button onclick="vaultFillSsh('${id}')" style="background:#21262d;border:1px solid #30363d;color:#58a6ff;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px;">Fill SSH</button>
        </div>
      </div>`;

      html += '</div>';
      document.getElementById('vault-detail-content').innerHTML = html;
    }

    async function vaultShowPassword(id) {
      const btn = document.getElementById('vault-pw-show-btn');
      const display = document.getElementById('vault-pw-display');
      if (btn.textContent === 'Hide') {
        display.textContent = '••••••••';
        btn.textContent = 'Show';
        return;
      }
      btn.textContent = '...';
      const result = await window.api.vault.getPassword(id);
      if (result.error) {
        display.textContent = 'Error';
        btn.textContent = 'Show';
        return;
      }
      display.textContent = result.password;
      btn.textContent = 'Hide';
    }

    async function vaultCopyPassword(id) {
      const result = await window.api.vault.getPassword(id);
      if (result.password) {
        navigator.clipboard.writeText(result.password);
        vaultSetStatus('Password copied to clipboard');
      }
    }

    async function vaultFillFtp(id) {
      const result = await window.api.vault.show(id);
      if (result.error) return;
      const e = result.entry;
      const pw = await window.api.vault.getPassword(id);
      // Parse host from URL
      let host = '';
      if (e.url) {
        try {
          const u = new URL(e.url.startsWith('http') ? e.url : 'ftp://' + e.url);
          host = u.hostname;
          if (u.port) document.getElementById('ftp-port').value = u.port;
        } catch { host = e.url; }
      }
      if (host) document.getElementById('ftp-host').value = host;
      if (e.username) document.getElementById('ftp-user').value = e.username;
      if (pw.password) document.getElementById('ftp-pass').value = pw.password;
      showLeftTab('ftp');
      vaultSetStatus('FTP fields filled');
    }

    async function vaultFillSsh(id) {
      const result = await window.api.vault.show(id);
      if (result.error) return;
      const e = result.entry;
      let host = '';
      if (e.url) {
        try {
          const u = new URL(e.url.startsWith('http') ? e.url : 'ssh://' + e.url);
          host = u.hostname;
          if (u.port) document.getElementById('ssh-port').value = u.port;
        } catch { host = e.url; }
      }
      if (host) document.getElementById('ssh-host').value = host;
      if (e.username) document.getElementById('ssh-user').value = e.username;
      showSshDialog();
      vaultSetStatus('SSH fields filled');
    }

    function vaultBackToList() {
      document.getElementById('vault-detail').style.display = 'none';
      document.getElementById('vault-main').style.display = 'flex';
    }

    function vaultSetStatus(msg) {
      const el = document.getElementById('vault-status');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    // ==========================================
    // COLLABORATIVE EDITING
    // ==========================================

    function collabShowError(msg) {
      const el = document.getElementById('collab-error');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function collabGetDisplayName() {
      let name = document.getElementById('collab-display-name').value.trim();
      if (!name && cloudAccount && cloudAccount.user) name = cloudAccount.user.username;
      if (!name) name = 'Anonymous';
      return name;
    }

    async function collabCreateRoom() {
      if (collabState) { collabShowError('Already in a session. Leave first.'); return; }
      if (!openFiles.length || activeFileIndex < 0) { collabShowError('Open a file first to share it.'); return; }

      const file = openFiles[activeFileIndex];
      const content = monacoEditor ? monacoEditor.getValue() : (file.content || '');
      const name = collabGetDisplayName();

      try {
        const result = await window.api.collab.request('create_room', {
          username: name,
          filename: file.name,
          content: content,
          language: file.language || 'plaintext'
        });
        if (result.error) { collabShowError(result.error); return; }

        collabState = {
          code: result.code,
          userId: result.userId,
          version: result.version,
          filename: file.name,
          language: file.language || 'plaintext',
          isOwner: true,
          lastContent: content,
          username: name
        };

        collabShowSession();
        collabStartPolling();
      } catch (e) {
        collabShowError('Failed to create session: ' + e.message);
      }
    }

    async function collabJoinRoom() {
      if (collabState) { collabShowError('Already in a session. Leave first.'); return; }

      const code = document.getElementById('collab-join-code').value.trim().toUpperCase();
      if (!code || code.length < 4) { collabShowError('Enter a valid access code.'); return; }

      const name = collabGetDisplayName();

      try {
        const result = await window.api.collab.request('join_room', { code, username: name });
        if (result.error) { collabShowError(result.error); return; }

        collabState = {
          code: result.code,
          userId: result.userId,
          version: result.version,
          filename: result.filename,
          language: result.language || 'plaintext',
          isOwner: false,
          lastContent: result.content,
          username: name
        };

        // Open the shared file content in editor
        const tempName = result.filename || 'collab-file.txt';
        // Create a virtual file in the editor
        const lang = result.language || 'plaintext';
        openFiles.push({ name: tempName, path: '__collab__/' + tempName, content: result.content, language: lang, modified: false, isCollab: true });
        activeFileIndex = openFiles.length - 1;
        setEditorContent(result.content, tempName);
        updateEditorTabs();
        showEditor();

        collabShowSession();
        collabUpdateUsers(result.users);
        collabStartPolling();
      } catch (e) {
        collabShowError('Failed to join session: ' + e.message);
      }
    }

    async function collabLeaveRoom() {
      if (!collabState) return;
      try {
        await window.api.collab.request('leave_room', { code: collabState.code, userId: collabState.userId });
      } catch (e) { /* ignore */ }
      collabStopPolling();
      collabState = null;
      collabShowLobby();
      document.getElementById('collab-nav-dot').classList.remove('visible');
    }

    function collabShowSession() {
      document.getElementById('collab-lobby').style.display = 'none';
      document.getElementById('collab-session').style.display = 'flex';
      document.getElementById('collab-session').style.flexDirection = 'column';
      document.getElementById('collab-session').style.gap = '12px';
      document.getElementById('collab-code-display').textContent = collabState.code;
      document.getElementById('collab-filename').textContent = collabState.filename;
      document.getElementById('collab-nav-dot').classList.add('visible');
    }

    function collabShowLobby() {
      document.getElementById('collab-lobby').style.display = 'block';
      document.getElementById('collab-session').style.display = 'none';
    }

    function collabCopyCode() {
      if (collabState) {
        navigator.clipboard.writeText(collabState.code);
        const btn = event.target;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Code'; }, 2000);
      }
    }

    function collabUpdateUsers(users) {
      const list = document.getElementById('collab-users-list');
      list.innerHTML = '';
      if (!users) return;
      for (const [uid, user] of Object.entries(users)) {
        const li = document.createElement('li');
        const dot = document.createElement('span');
        dot.className = 'user-dot';
        dot.style.background = user.color || '#61afef';
        li.appendChild(dot);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = user.name + (uid === collabState.userId ? ' (you)' : '');
        li.appendChild(nameSpan);
        if (user.cursor) {
          const cursorInfo = document.createElement('span');
          cursorInfo.style.cssText = 'color:#6e7681; font-size:10px; margin-left:auto;';
          cursorInfo.textContent = 'Ln ' + user.cursor.line;
          li.appendChild(cursorInfo);
        }
        list.appendChild(li);
      }
    }


    function collabStartPolling() {
      if (!collabState) return;
      collabState.polling = true;
      collabLongPollLoop();
    }

    function collabStopPolling() {
      if (collabState) {
        collabState.polling = false;
      }
    }

    // Push changes immediately when user types (debounced)
    let collabPushTimer = null;
    async function collabPushNow() {
      if (!collabState || !monacoEditor) return;
      collabPushPending = false;

      const content = monacoEditor.getValue();
      if (content === collabState.lastContent) return;

      const cursor = monacoEditor.getPosition();
      const cursorData = cursor ? { line: cursor.lineNumber, col: cursor.column } : null;

      try {
        const result = await window.api.collab.request('push_changes', {
          code: collabState.code,
          userId: collabState.userId,
          content: content,
          version: collabState.version,
          cursor: cursorData,
          username: collabState.username
        });
        if (!collabState) return;
        if (result.error) {
          document.getElementById('collab-status-text').textContent = 'Error: ' + result.error;
          return;
        }
        collabState.version = result.version;
        collabState.lastContent = content;
        if (result.users) collabUpdateUsers(result.users);
        document.getElementById('collab-status-text').textContent = 'Synced';
      } catch (e) {
        document.getElementById('collab-status-text').textContent = 'Push error';
      }
    }

    function collabSchedulePush() {
      if (collabPushTimer) clearTimeout(collabPushTimer);
      collabPushTimer = setTimeout(collabPushNow, 150);
    }

    // Long-poll loop: server holds connection open until changes arrive or 20s timeout
    async function collabLongPollLoop() {
      while (collabState && collabState.polling) {
        try {
          const result = await window.api.collab.request('pull_changes', {
            code: collabState.code,
            userId: collabState.userId,
            version: collabState.version,
            longPoll: true
          });
          if (!collabState || !collabState.polling) break;

          if (result.error) {
            if (result.error === 'Room not found') {
              collabShowError('Session ended by host.');
              collabStopPolling();
              collabState = null;
              collabShowLobby();
              document.getElementById('collab-nav-dot').classList.remove('visible');
              return;
            }
            document.getElementById('collab-status-text').textContent = 'Error: ' + result.error;
            await new Promise(r => setTimeout(r, 2000));
            continue;
          }

          if (result.users) collabUpdateUsers(result.users);

          if (result.hasChanges && result.content !== undefined && monacoEditor) {
            const currentContent = monacoEditor.getValue();
            if (result.content !== currentContent) {
              const pos = monacoEditor.getPosition();
              const scrollTop = monacoEditor.getScrollTop();

              collabIgnoreNextChange = true;
              monacoEditor.setValue(result.content);
              collabIgnoreNextChange = false;

              if (pos) monacoEditor.setPosition(pos);
              monacoEditor.setScrollTop(scrollTop);

              collabState.lastContent = result.content;
              document.getElementById('collab-status-text').textContent = 'Updated by ' + (result.lastEditBy || 'collaborator');
            }
            collabState.version = result.version;
          } else {
            document.getElementById('collab-status-text').textContent = 'Connected';
          }
        } catch (e) {
          if (!collabState || !collabState.polling) break;
          document.getElementById('collab-status-text').textContent = 'Connection error';
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    // Auto-save session periodically
    setInterval(saveSession, 30000);

    // Auto-push on window close
    window.addEventListener('beforeunload', () => {
      // Leave collab session
      if (collabState) {
        window.api.collab.request('leave_room', { code: collabState.code, userId: collabState.userId });
      }
      // Save session synchronously by sending to main process
      // (beforeunload can't await, but the IPC call is fire-and-forget here)
      saveSession();
      if (cloudAccount) {
        pushCloudData();
      }
    });

    // Start
    init();
    // initNotes() is called from Monaco onload callback
    showWelcomeScreen();
    loadSshConnections();
    updateStatusBar();
  </script>
</body>
</html>
